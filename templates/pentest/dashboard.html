{% extends "base.html" %}
{% block title %}Pentest — ARPIA{% endblock %}
{% block content %}
<div class="pentest-layout">
  <section class="intel-column">
    <form class="intel-project-selector" method="get">
      <div class="selector-details">
        <span class="selector-label">Projeto ativo</span>
        {% if selected_project %}
          <strong class="selector-name">{{ selected_project.name }}</strong>
          {% if selected_project.client_name %}
            <span class="selector-meta">{{ selected_project.client_name }}</span>
          {% endif %}
        {% else %}
          <strong class="selector-name">Nenhum projeto selecionado</strong>
          <span class="selector-meta">Escolha um projeto para habilitar macros ofensivas.</span>
        {% endif %}
      </div>
      <div class="selector-controls">
        {% if projects %}
          <label for="intelProjectSelect" class="visually-hidden">Selecionar projeto</label>
          <div class="select-wrapper">
            <select id="intelProjectSelect" name="project" onchange="this.form.submit()">
              <option value=""{% if not selected_project_id %} selected{% endif %}>Todos os projetos</option>
              {% for project in projects %}
                <option value="{{ project.id }}"{% if project.id|stringformat:'s' == selected_project_id %} selected{% endif %}>{{ project.name }}{% if project.client_name %} — {{ project.client_name }}{% endif %}</option>
              {% endfor %}
            </select>
          </div>
          <noscript>
            <button type="submit" class="selector-submit">Aplicar</button>
          </noscript>
        {% else %}
          <p class="selector-empty">Nenhum projeto disponível no momento.</p>
        {% endif %}
      </div>
    </form>
    <header class="intel-header">
      <h1>Console de Operações</h1>
      <p class="intel-caption">Selecione um módulo para sincronizar as intel disponíveis na operação atual.</p>
    </header>

    <div class="module-toggles" role="tablist">
      {% for module in modules %}
        <button class="module-toggle" data-module="{{ module.slug }}" role="tab">{{ module.name }}</button>
      {% endfor %}
    </div>

    <article class="module-summary" id="moduleSummary"></article>

    <div class="module-metrics" id="moduleMetrics" aria-live="polite"></div>

    <div class="module-panels">
      <section class="data-card" aria-labelledby="highlights-title">
        <header id="highlights-title">Pontos de infiltração</header>
        <ul class="data-list" id="moduleHighlights"></ul>
      </section>
      <section class="data-card" aria-labelledby="log-title">
        <header id="log-title">Linha do tempo</header>
        <ul class="log-list" id="moduleLog"></ul>
      </section>
    </div>

    <section class="ssh-card" id="sshDemoCard" hidden>
      <header>Teste de credencial SSH</header>
      <p class="ssh-caption" id="sshMetaCaption">Executa automaticamente as credenciais compartilhadas pelo projeto.</p>
      <button type="button" id="sshTrigger" class="ssh-trigger">Executar varredura SSH</button>
      <small class="ssh-hint">A macro de projeto envia as combinações host + credencial e o resultado aparece no Terminal Ofensivo.</small>
    </section>
  </section>

  <section class="terminal-column">
    <header class="terminal-header">
      <span>Terminal ofensivo</span>
      <small>sessão isolada x64 · kernel 6.8</small>
    </header>
    <div class="terminal-shell" id="terminalShell" aria-live="polite">
      <pre id="terminalOutput"></pre>
    </div>
    <form class="terminal-form" id="terminalForm" autocomplete="off">
      <div class="terminal-input">
        <span class="terminal-prompt">└──$</span>
        <input type="text" id="terminalCommand" name="command" placeholder="Digite um comando Kali..." aria-label="Comando do terminal">
        <button type="submit" id="terminalSubmit">Executar</button>
      </div>
      <small class="terminal-hint">Os comandos são executados diretamente no host Kali desta instância. Use com responsabilidade.</small>
    </form>
  </section>
</div>

{{ modules|json_script:"pentest-modules-data" }}
{{ initial_terminal_lines|json_script:"pentest-terminal-lines" }}
{{ ssh_demo|json_script:"pentest-ssh-demo" }}
<script>
(function(){
  const modules = JSON.parse(document.getElementById("pentest-modules-data").textContent || "[]");
  const defaultSlug = "{{ default_module }}";
  const toggles = Array.from(document.querySelectorAll('.module-toggle'));
  const summaryEl = document.getElementById('moduleSummary');
  const metricsEl = document.getElementById('moduleMetrics');
  const highlightsEl = document.getElementById('moduleHighlights');
  const logEl = document.getElementById('moduleLog');
  const sshDemo = JSON.parse(document.getElementById("pentest-ssh-demo").textContent || "{}");
  const sshCard = document.getElementById('sshDemoCard');
  const sshTrigger = document.getElementById('sshTrigger');
  const sshMetaCaption = document.getElementById('sshMetaCaption');
  const projectId = sshDemo && sshDemo.project_id ? String(sshDemo.project_id) : "";
  const projectName = sshDemo && sshDemo.project_name ? sshDemo.project_name : "";

  function metricTemplate(metric){
    return `<div class="metric"><span class="metric-value">${metric.value}</span><span class="metric-label">${metric.label}</span></div>`;
  }

  function logTemplate(item){
    return `<li><span class="log-time">${item.time}</span><div><strong>${item.event}</strong><span>${item.detail}</span></div></li>`;
  }

  function highlightTemplate(text){
    return `<li><span class="bullet"></span>${text}</li>`;
  }

  function updateSshMeta(){
    if(!sshMetaCaption){ return; }
    const hostList = Array.isArray(sshDemo.hosts) ? sshDemo.hosts : [];
    const count = Number.isFinite(sshDemo.target_count) ? sshDemo.target_count : 0;
    const hasProject = Boolean(sshDemo.has_project && projectId);
    if(!hasProject){
      sshMetaCaption.textContent = 'Selecione um projeto para habilitar a macro de credenciais.';
      if(sshTrigger){
        sshTrigger.disabled = true;
        sshTrigger.classList.remove('is-loading');
      }
      return;
    }
    const name = projectName || projectId;
    const plural = count === 1 ? '' : 's';
    const base = count > 0
      ? `Macro do projeto ${name} pronta com ${count} combinação${plural} de host + credencial.`
      : `Projeto ${name} ainda não possui credenciais com senha configuradas.`;
    const hostSummary = hostList.length ? ` Hosts alvo: ${hostList.join(', ')}.` : '';
    sshMetaCaption.textContent = `${base}${hostSummary}`.trim();
    if(sshTrigger){
      sshTrigger.disabled = count === 0;
      if(count === 0){ sshTrigger.classList.remove('is-loading'); }
    }
  }

  function render(slug){
    const active = modules.find((entry)=> entry.slug === slug) || modules[0];
    toggles.forEach((btn)=>{
      const isActive = btn.dataset.module === active.slug;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-selected', String(isActive));
    });
    const isHunt = Boolean(active && active.slug === 'hunt');
    if(sshCard){
      sshCard.hidden = !isHunt;
      if(isHunt){ updateSshMeta(); }
    }
    if(!active){
      summaryEl.textContent = 'Nenhum módulo selecionado.';
      metricsEl.innerHTML = '';
      highlightsEl.innerHTML = '';
      logEl.innerHTML = '';
      return;
    }
    summaryEl.textContent = active.summary;
    metricsEl.innerHTML = (active.key_metrics || []).map(metricTemplate).join('');
    highlightsEl.innerHTML = (active.highlights || []).map(highlightTemplate).join('');
    logEl.innerHTML = (active.activity_log || []).map(logTemplate).join('');
  }

  toggles.forEach((btn)=>{
    btn.addEventListener('click', ()=> render(btn.dataset.module));
  });

  render(defaultSlug || (modules[0] && modules[0].slug));

  const terminalLines = JSON.parse(document.getElementById("pentest-terminal-lines").textContent || "[]");
  const outputEl = document.getElementById('terminalOutput');
  const shellEl = document.getElementById('terminalShell');
  const formEl = document.getElementById('terminalForm');
  const commandEl = document.getElementById('terminalCommand');
  const submitEl = document.getElementById('terminalSubmit');
  const PROMPT = '└──$';
  const history = Array.isArray(terminalLines) ? [...terminalLines] : [];

  function renderTerminal(){
    outputEl.textContent = history.join('\n');
    shellEl.scrollTop = shellEl.scrollHeight;
  }

  function appendLine(line){
    history.push(line);
    if(history.length > 500){ history.splice(0, history.length - 500); }
    renderTerminal();
  }

  function appendBlock(block){
    if(!block){ return; }
    block.replace(/\r\n/g,'\n').split('\n').forEach((line)=> appendLine(line));
  }

  function getCSRFToken(){
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? decodeURIComponent(match[1]) : '';
  }

  renderTerminal();

  if(formEl){
    formEl.addEventListener('submit', async (event)=>{
      event.preventDefault();
      const command = (commandEl.value || '').trim();
      if(!command){ return; }

      appendLine(`${PROMPT} ${command}`);
      commandEl.value = '';
      submitEl.disabled = true;
      commandEl.disabled = true;

      try{
        const response = await fetch('{% url "arpia_pentest:terminal_execute" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
          },
          body: JSON.stringify({command}),
        });

        if(!response.ok){
          let message = `Falha ao executar (HTTP ${response.status}).`;
          try {
            const data = await response.json();
            if(data.error){ message = data.error; }
          } catch (err) {
            /* noop */
          }
          appendLine(message);
        } else {
          const data = await response.json();
          appendBlock(data.stdout || '');
          if(data.stderr){ appendBlock(data.stderr); }
          appendLine(`(exit ${data.returncode})`);
        }
      } catch(err){
        appendLine(`Erro de rede: ${err}`);
      } finally {
        submitEl.disabled = false;
        commandEl.disabled = false;
        commandEl.focus();
      }
    });
  }

  if(sshTrigger){
    sshTrigger.addEventListener('click', async ()=>{
      const count = Number.isFinite(sshDemo.target_count) ? sshDemo.target_count : 0;
      if(!projectId){
        appendLine('[hunt] Selecione um projeto para disparar o teste de credenciais.');
        return;
      }
      if(!count){
        appendLine('[hunt] Nenhuma combinação de credencial disponível para teste.');
        return;
      }

      const hostList = Array.isArray(sshDemo.hosts) ? sshDemo.hosts : [];
      const name = projectName || projectId;
      appendLine(`[hunt] Disparando teste automático de credenciais SSH do projeto ${name} (${count} combinações).`);
      if(hostList.length){ appendLine(`[hunt] Hosts alvo: ${hostList.join(', ')}.`); }
      if(sshTrigger){
        sshTrigger.disabled = true;
        sshTrigger.classList.add('is-loading');
      }

      try{
        const response = await fetch('{% url "arpia_pentest:terminal_ssh_test" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
          },
          body: JSON.stringify({project: projectId}),
        });

        let data;
        try{
          data = await response.json();
        } catch(parseErr){
          data = null;
        }

        if(!response.ok){
          const message = data && data.error ? data.error : `Falha no teste SSH (HTTP ${response.status}).`;
          appendLine(message);
          if(data && data.missing_dependency){ appendLine(`Dependência ausente: ${data.missing_dependency}`); }
        } else if(data){
          if(data.stdout){ appendBlock(data.stdout); }
          if(data.stderr){ appendBlock(data.stderr); }
          appendLine(`(ssh exit ${data.returncode})`);
        }
      } catch(err){
        appendLine(`Erro de rede durante teste SSH: ${err}`);
      } finally {
        if(sshTrigger){
          sshTrigger.classList.remove('is-loading');
          updateSshMeta();
        }
      }
    });
  }
  updateSshMeta();
})();
</script>

<style>
.intel-project-selector{display:flex;justify-content:space-between;align-items:flex-end;gap:1rem;margin-bottom:1rem;background:rgba(2,24,45,0.62);border:1px solid rgba(0,255,204,0.16);border-radius:14px;padding:1rem 1.2rem;box-shadow:0 0 22px rgba(0,255,204,0.08);} 
.selector-details{display:flex;flex-direction:column;gap:.35rem;max-width:60%;}
.selector-label{font-size:.72rem;letter-spacing:.12em;text-transform:uppercase;color:#7fe3ff;}
.selector-name{color:#d4f8ff;font-size:1.1rem;}
.selector-meta{color:#8bb2c3;font-size:.88rem;}
.selector-controls{display:flex;flex-direction:column;align-items:flex-end;gap:.4rem;min-width:220px;}
.select-wrapper{position:relative;width:100%;}
.select-wrapper select{appearance:none;width:100%;background:rgba(0,21,40,0.78);border:1px solid rgba(0,255,204,0.18);border-radius:10px;padding:.55rem 2.1rem .55rem .85rem;color:#d8fbff;font-weight:600;letter-spacing:.04em;cursor:pointer;}
.select-wrapper::after{content:"▾";position:absolute;right:.75rem;top:50%;transform:translateY(-50%);pointer-events:none;color:#7fe3ff;font-size:.9rem;opacity:.7;}
.select-wrapper select:hover{border-color:rgba(0,255,204,0.3);}
.select-wrapper select:focus{outline:none;border-color:rgba(0,255,204,0.45);box-shadow:0 0 0 2px rgba(0,255,204,0.18);}
.selector-submit{padding:.45rem .9rem;border-radius:9px;border:1px solid rgba(0,255,204,0.18);background:rgba(0,21,40,0.78);color:#9beff2;font-weight:600;cursor:pointer;}
.selector-submit:hover{border-color:rgba(0,255,204,0.3);color:#d8fbff;}
.selector-empty{margin:0;color:#8bb2c3;font-size:.88rem;}
.visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;}

.pentest-layout{display:grid;grid-template-columns:1.6fr 1fr;gap:1.6rem;padding:1.2rem 1.6rem;min-height:calc(100vh - 140px);background:radial-gradient(circle at top left,rgba(20,60,120,0.18),transparent 55%);} 
.intel-column{display:flex;flex-direction:column;gap:1.2rem;background:rgba(3,18,36,0.72);border:1px solid rgba(0,255,204,0.12);border-radius:18px;padding:1.4rem;box-shadow:0 0 32px rgba(0,255,204,0.08);} 
.intel-header h1{margin:0;font-size:1.6rem;color:#7fe3ff;letter-spacing:.08em;text-transform:uppercase;} 
.intel-caption{margin:0;color:#8bb2c3;font-size:.92rem;} 
.module-toggles{display:flex;gap:1rem;} 
.module-toggle{flex:1;background:linear-gradient(160deg,rgba(0,255,204,0.18),rgba(0,160,255,0.08));border:1px solid rgba(0,255,204,0.28);border-radius:12px;padding:.8rem 1rem;color:#9beff2;font-weight:700;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;transition:all .2s ease;} 
.module-toggle:hover{border-color:rgba(0,255,204,0.45);color:#d8fbff;box-shadow:0 0 18px rgba(0,255,204,0.24);} 
.module-toggle.active{background:rgba(0,255,204,0.28);color:#04151f;box-shadow:0 0 28px rgba(0,255,204,0.45);text-shadow:0 0 12px rgba(0,0,0,0.6);} 
.module-summary{min-height:70px;padding:1rem;border-radius:12px;border:1px solid rgba(0,255,204,0.12);background:rgba(2,24,45,0.6);color:#a7c6d7;font-size:.95rem;line-height:1.5;} 
.module-metrics{display:flex;gap:1rem;flex-wrap:wrap;} 
.metric{flex:1 1 120px;background:rgba(0,21,40,0.8);border:1px solid rgba(127,227,255,0.2);border-radius:12px;padding:.9rem 1rem;display:flex;flex-direction:column;gap:.25rem;text-transform:uppercase;} 
.metric-value{font-size:1.7rem;font-weight:700;color:#7fe3ff;} 
.metric-label{font-size:.75rem;color:#7093a6;letter-spacing:.12em;} 
.module-panels{display:grid;grid-template-columns:1fr 1fr;gap:1.2rem;} 
.data-card{background:rgba(0,21,40,0.78);border:1px solid rgba(0,255,204,0.16);border-radius:16px;padding:1rem;display:flex;flex-direction:column;gap:.8rem;} 
.data-card header{font-size:.95rem;font-weight:700;text-transform:uppercase;color:#7fe3ff;letter-spacing:.12em;} 
.data-list,.log-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.75rem;font-size:.9rem;color:#cbe4f2;} 
.data-list .bullet{display:inline-block;width:8px;height:8px;border-radius:50%;background:#7fe3ff;margin-right:.6rem;box-shadow:0 0 12px rgba(0,255,204,0.6);} 
.data-list li{display:flex;align-items:flex-start;gap:.6rem;} 
.log-list li{display:flex;gap:.8rem;align-items:flex-start;padding-bottom:.6rem;border-bottom:1px solid rgba(113,196,204,0.08);} 
.log-list li:last-child{border-bottom:none;padding-bottom:0;} 
.log-time{font-family:"Courier New",monospace;font-size:.85rem;color:#6fd6ff;margin-top:.1rem;min-width:48px;} 
.log-list strong{display:block;color:#d4f8ff;} 
.log-list span{display:block;color:#8fb8c9;font-size:.83rem;} 
.ssh-card{margin-top:1.2rem;background:rgba(0,26,48,0.82);border:1px solid rgba(0,255,204,0.18);border-radius:18px;padding:1.2rem;display:flex;flex-direction:column;gap:1rem;box-shadow:0 0 26px rgba(0,255,204,0.1);} 
.ssh-card header{font-size:1rem;font-weight:700;text-transform:uppercase;color:#7fe3ff;letter-spacing:.1em;} 
.ssh-caption{margin:0;color:#8fb8c9;font-size:.9rem;} 
.ssh-trigger{align-self:flex-start;background:linear-gradient(160deg,rgba(0,255,204,0.4),rgba(0,160,255,0.65));border:none;color:#04151f;font-weight:700;text-transform:uppercase;letter-spacing:.12em;padding:.85rem 1.8rem;border-radius:12px;cursor:pointer;transition:transform .18s ease,box-shadow .18s ease;} 
.ssh-trigger:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(0,255,204,0.22);} 
.ssh-trigger.is-loading{opacity:.6;cursor:wait;transform:none;box-shadow:none;} 
.ssh-trigger:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none;} 
.ssh-hint{color:#6fa7ba;font-size:.78rem;} 

.terminal-column{background:rgba(3,18,36,0.78);border-radius:18px;border:1px solid rgba(127,227,255,0.16);padding:1.4rem;display:flex;flex-direction:column;box-shadow:0 0 26px rgba(0,160,255,0.14);} 
.terminal-header{display:flex;align-items:center;justify-content:space-between;color:#7fe3ff;font-size:.95rem;text-transform:uppercase;letter-spacing:.08em;margin-bottom:1rem;} 
.terminal-shell{flex:1;background:radial-gradient(circle at 15% 20%,rgba(0,255,204,0.1),transparent 60%),rgba(0,10,20,0.9);border:1px solid rgba(0,255,204,0.2);border-radius:16px;padding:1.2rem;overflow:auto;box-shadow:inset 0 0 32px rgba(0,255,204,0.08);} 
.terminal-shell pre{margin:0;font-family:"Fira Code", "Courier New", monospace;font-size:.88rem;line-height:1.6;color:#9ae6ff;} 
.terminal-form{margin-top:1.1rem;display:flex;flex-direction:column;gap:.55rem;} 
.terminal-input{display:flex;align-items:center;gap:.9rem;background:rgba(0,12,22,0.92);border:1px solid rgba(0,255,204,0.24);border-radius:14px;padding:.85rem 1rem;box-shadow:0 0 22px rgba(0,255,204,0.08);} 
.terminal-prompt{font-family:"Fira Code", "Courier New", monospace;color:#5be8ff;font-size:1rem;letter-spacing:.08em;} 
.terminal-input input{flex:1;background:transparent;border:none;color:#e0f8ff;font-family:"Fira Code", "Courier New", monospace;font-size:1.02rem;padding:.35rem 0;outline:none;} 
.terminal-input input::placeholder{color:rgba(173,226,235,0.45);} 
.terminal-input button{background:linear-gradient(160deg,rgba(0,255,204,0.35),rgba(0,160,255,0.6));border:none;color:#04151f;font-weight:700;text-transform:uppercase;letter-spacing:.12em;padding:.85rem 1.6rem;border-radius:12px;cursor:pointer;transition:transform .18s ease, box-shadow .18s ease;} 
.terminal-input button:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,255,204,0.25);} 
.terminal-input button:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none;} 
.terminal-hint{color:#6fa7ba;font-size:.78rem;} 

@media (max-width:1200px){
  .intel-project-selector{flex-direction:column;align-items:flex-start;gap:.8rem;}
  .selector-details{max-width:100%;}
  .selector-controls{width:100%;align-items:stretch;}
  .pentest-layout{grid-template-columns:1fr;}
  .terminal-column{min-height:360px;}
}
@media (max-width:768px){
  .intel-project-selector{padding:1rem;}
  .module-toggles{flex-direction:column;}
  .module-panels{grid-template-columns:1fr;}
}
</style>
{% endblock %}
