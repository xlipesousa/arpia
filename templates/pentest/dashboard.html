{% extends "base.html" %}
{% block title %}Pentest — ARPIA{% endblock %}
{% block content %}
<div class="pentest-layout">
  <section class="intel-column">
    <header class="intel-header">
      <h1>Console de Operações</h1>
      <p class="intel-caption">Selecione um módulo para sincronizar as intel disponíveis na operação atual.</p>
    </header>

    <div class="module-toggles" role="tablist">
      {% for module in modules %}
        <button class="module-toggle" data-module="{{ module.slug }}" role="tab">{{ module.name }}</button>
      {% endfor %}
    </div>

    <article class="module-summary" id="moduleSummary"></article>

    <div class="module-metrics" id="moduleMetrics" aria-live="polite"></div>

    <div class="module-panels">
      <section class="data-card" aria-labelledby="highlights-title">
        <header id="highlights-title">Pontos de infiltração</header>
        <ul class="data-list" id="moduleHighlights"></ul>
      </section>
      <section class="data-card" aria-labelledby="log-title">
        <header id="log-title">Linha do tempo</header>
        <ul class="log-list" id="moduleLog"></ul>
      </section>
    </div>
  </section>

  <section class="terminal-column">
    <header class="terminal-header">
      <span>Terminal ofensivo</span>
      <small>sessão isolada x64 · kernel 6.8</small>
    </header>
    <div class="terminal-shell" id="terminalShell" aria-live="polite">
      <pre><code>{% for line in terminal_lines %}{{ line }}{% if not forloop.last %}
{% endif %}{% endfor %}</code></pre>
    </div>
  </section>
</div>

{{ modules|json_script:"pentest-modules-data" }}
<script>
(function(){
  const modules = JSON.parse(document.getElementById("pentest-modules-data").textContent || "[]");
  const defaultSlug = "{{ default_module }}";
  const toggles = Array.from(document.querySelectorAll('.module-toggle'));
  const summaryEl = document.getElementById('moduleSummary');
  const metricsEl = document.getElementById('moduleMetrics');
  const highlightsEl = document.getElementById('moduleHighlights');
  const logEl = document.getElementById('moduleLog');

  function metricTemplate(metric){
    return `<div class="metric"><span class="metric-value">${metric.value}</span><span class="metric-label">${metric.label}</span></div>`;
  }

  function logTemplate(item){
    return `<li><span class="log-time">${item.time}</span><div><strong>${item.event}</strong><span>${item.detail}</span></div></li>`;
  }

  function highlightTemplate(text){
    return `<li><span class="bullet"></span>${text}</li>`;
  }

  function render(slug){
    const active = modules.find((entry)=> entry.slug === slug) || modules[0];
    toggles.forEach((btn)=>{
      const isActive = btn.dataset.module === active.slug;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-selected', String(isActive));
    });
    if(!active){
      summaryEl.textContent = 'Nenhum módulo selecionado.';
      metricsEl.innerHTML = '';
      highlightsEl.innerHTML = '';
      logEl.innerHTML = '';
      return;
    }
    summaryEl.textContent = active.summary;
    metricsEl.innerHTML = (active.key_metrics || []).map(metricTemplate).join('');
    highlightsEl.innerHTML = (active.highlights || []).map(highlightTemplate).join('');
    logEl.innerHTML = (active.activity_log || []).map(logTemplate).join('');
  }

  toggles.forEach((btn)=>{
    btn.addEventListener('click', ()=> render(btn.dataset.module));
  });

  render(defaultSlug || (modules[0] && modules[0].slug));
})();
</script>

<style>
.pentest-layout{display:grid;grid-template-columns:1.6fr 1fr;gap:1.6rem;padding:1.2rem 1.6rem;min-height:calc(100vh - 140px);background:radial-gradient(circle at top left,rgba(20,60,120,0.18),transparent 55%);} 
.intel-column{display:flex;flex-direction:column;gap:1.2rem;background:rgba(3,18,36,0.72);border:1px solid rgba(0,255,204,0.12);border-radius:18px;padding:1.4rem;box-shadow:0 0 32px rgba(0,255,204,0.08);} 
.intel-header h1{margin:0;font-size:1.6rem;color:#7fe3ff;letter-spacing:.08em;text-transform:uppercase;} 
.intel-caption{margin:0;color:#8bb2c3;font-size:.92rem;} 
.module-toggles{display:flex;gap:1rem;} 
.module-toggle{flex:1;background:linear-gradient(160deg,rgba(0,255,204,0.18),rgba(0,160,255,0.08));border:1px solid rgba(0,255,204,0.28);border-radius:12px;padding:.8rem 1rem;color:#9beff2;font-weight:700;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;transition:all .2s ease;} 
.module-toggle:hover{border-color:rgba(0,255,204,0.45);color:#d8fbff;box-shadow:0 0 18px rgba(0,255,204,0.24);} 
.module-toggle.active{background:rgba(0,255,204,0.28);color:#04151f;box-shadow:0 0 28px rgba(0,255,204,0.45);text-shadow:0 0 12px rgba(0,0,0,0.6);} 
.module-summary{min-height:70px;padding:1rem;border-radius:12px;border:1px solid rgba(0,255,204,0.12);background:rgba(2,24,45,0.6);color:#a7c6d7;font-size:.95rem;line-height:1.5;} 
.module-metrics{display:flex;gap:1rem;flex-wrap:wrap;} 
.metric{flex:1 1 120px;background:rgba(0,21,40,0.8);border:1px solid rgba(127,227,255,0.2);border-radius:12px;padding:.9rem 1rem;display:flex;flex-direction:column;gap:.25rem;text-transform:uppercase;} 
.metric-value{font-size:1.7rem;font-weight:700;color:#7fe3ff;} 
.metric-label{font-size:.75rem;color:#7093a6;letter-spacing:.12em;} 
.module-panels{display:grid;grid-template-columns:1fr 1fr;gap:1.2rem;} 
.data-card{background:rgba(0,21,40,0.78);border:1px solid rgba(0,255,204,0.16);border-radius:16px;padding:1rem;display:flex;flex-direction:column;gap:.8rem;} 
.data-card header{font-size:.95rem;font-weight:700;text-transform:uppercase;color:#7fe3ff;letter-spacing:.12em;} 
.data-list,.log-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.75rem;font-size:.9rem;color:#cbe4f2;} 
.data-list .bullet{display:inline-block;width:8px;height:8px;border-radius:50%;background:#7fe3ff;margin-right:.6rem;box-shadow:0 0 12px rgba(0,255,204,0.6);} 
.data-list li{display:flex;align-items:flex-start;gap:.6rem;} 
.log-list li{display:flex;gap:.8rem;align-items:flex-start;padding-bottom:.6rem;border-bottom:1px solid rgba(113,196,204,0.08);} 
.log-list li:last-child{border-bottom:none;padding-bottom:0;} 
.log-time{font-family:"Courier New",monospace;font-size:.85rem;color:#6fd6ff;margin-top:.1rem;min-width:48px;} 
.log-list strong{display:block;color:#d4f8ff;} 
.log-list span{display:block;color:#8fb8c9;font-size:.83rem;} 

.terminal-column{background:rgba(3,18,36,0.78);border-radius:18px;border:1px solid rgba(127,227,255,0.16);padding:1.4rem;display:flex;flex-direction:column;box-shadow:0 0 26px rgba(0,160,255,0.14);} 
.terminal-header{display:flex;align-items:center;justify-content:space-between;color:#7fe3ff;font-size:.95rem;text-transform:uppercase;letter-spacing:.08em;margin-bottom:1rem;} 
.terminal-shell{flex:1;background:radial-gradient(circle at 15% 20%,rgba(0,255,204,0.1),transparent 60%),rgba(0,10,20,0.9);border:1px solid rgba(0,255,204,0.2);border-radius:16px;padding:1.2rem;overflow:auto;box-shadow:inset 0 0 32px rgba(0,255,204,0.08);} 
.terminal-shell pre{margin:0;font-family:"Fira Code", "Courier New", monospace;font-size:.88rem;line-height:1.6;color:#9ae6ff;} 

@media (max-width:1200px){
  .pentest-layout{grid-template-columns:1fr;}
  .terminal-column{min-height:360px;}
}
@media (max-width:768px){
  .module-toggles{flex-direction:column;}
  .module-panels{grid-template-columns:1fr;}
}
</style>
{% endblock %}
