{% extends "base.html" %}
{% load static %}
{% block title %}Scripts — ARPIA{% endblock %}

{% block content %}
<div class="main">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
    <h2 style="margin:0;color:var(--text)">Scripts</h2>
    <div>
      <a href="{% url 'scripts_create' %}" class="btn btn-primary" style="display:inline-flex;align-items:center;gap:.6rem;padding:.45rem .8rem;border-radius:8px;background:linear-gradient(90deg,#4fd1c5,var(--accent));color:#021023;text-decoration:none;font-weight:700;">
        Novo Script
      </a>
    </div>
  </div>

  <div class="card" style="padding:0.75rem;">
    <div style="overflow:auto;">
      <table id="scripts-table" class="projects-table" style="width:100%;border-collapse:collapse;color:var(--muted);">
        <thead>
          <tr style="text-align:left;font-weight:700;color:var(--muted);font-size:.9rem;">
            <th class="id-col" style="padding:.45rem .5rem;border-bottom:1px solid rgba(255,255,255,0.04);min-width:64px;text-align:center">Script ID</th>
            <th class="name-col" style="padding:.45rem .5rem;border-bottom:1px solid rgba(255,255,255,0.04);min-width:180px">Nome</th>
            <th class="desc-col" style="padding:.45rem .5rem;border-bottom:1px solid rgba(255,255,255,0.04);">Descrição</th>
            <th class="type-col" style="padding:.45rem .5rem;border-bottom:1px solid rgba(255,255,255,0.04);min-width:110px">Tipo</th>
            <th class="actions-col" style="padding:.45rem .5rem;border-bottom:1px solid rgba(255,255,255,0.04);min-width:180px;text-align:right">Ações</th>
          </tr>
        </thead>
        <tbody id="scripts-body">
          {% for s in scripts %}
          <tr>
            <td class="id-col" style="padding:.45rem .5rem;white-space:nowrap;text-align:center;vertical-align:middle;">{{ s.id }}</td>
            <td class="name-col" style="padding:.45rem .5rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:160px;max-width:45%;">{{ s.name }}</td>
            <td class="desc-col" style="padding:.45rem .5rem;overflow:hidden;text-overflow:ellipsis;min-width:200px;max-width:40ch;">{{ s.description }}</td>
            <td class="type-col" style="padding:.45rem .5rem;text-transform:capitalize;vertical-align:middle;">{{ s.type }}</td>
            <td class="actions-col" style="padding:.45rem .5rem;text-align:right;vertical-align:middle;">
              <!-- ações: Edit, Clone (default), Reset (default), Run, Delete (custom allowed) -->
              <a href="{% url 'scripts_edit' s.id %}" class="btn-icon btn-success" title="Editar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 21l3-1 11-11 1-3L14 3 3 14v7z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg></a>

              <a href="{% url 'scripts_clone' s.id %}" class="btn-icon btn-info" title="Clonar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><rect x="9" y="9" width="13" height="13" rx="2" stroke="currentColor" stroke-width="1.4"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke="currentColor" stroke-width="1.4"/></svg></a>

              {% if s.type == "default" %}
                <a href="{% url 'scripts_reset' s.id %}" class="btn-icon btn-warning" title="Resetar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 11-3.17-6.37" stroke="currentColor" stroke-width="1.4"/><path d="M21 3v6h-6" stroke="currentColor" stroke-width="1.4"/></svg></a>
              {% endif %}

              <button type="button" class="btn-icon btn-info" data-id="{{ s.id }}" data-action="run" title="Executar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M5 3v18l15-9L5 3z" stroke="currentColor" stroke-width="1.2"/></svg></button>

              <a href="{% url 'scripts_delete' s.id %}" class="btn-icon btn-danger" title="Apagar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 6h18" stroke="currentColor" stroke-width="1.4"/><path d="M8 6v14a1 1 0 001 1h6a1 1 0 001-1V6" stroke="currentColor" stroke-width="1.4"/><path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="1.4"/></svg></a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5" style="padding:.8rem;color:var(--muted)">Nenhum script encontrado.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between;padding:.7rem .3rem;margin-top:.6rem;">
      <div>
        Mostrar
        <select onchange="location.search='page=1&page_size='+this.value" style="padding:.25rem .4rem;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);">
          <option value="5" {% if scripts_page.paginator.per_page == 5 %}selected{% endif %}>5</option>
          <option value="10" {% if scripts_page.paginator.per_page == 10 %}selected{% endif %}>10</option>
          <option value="25" {% if scripts_page.paginator.per_page == 25 %}selected{% endif %}>25</option>
        </select>
        entradas
      </div>

      <div style="display:flex;gap:.35rem;align-items:center;">
        {% if scripts_page.has_previous %}
          <a href="?page={{ scripts_page.previous_page_number }}&page_size={{ scripts_page.paginator.per_page }}" class="btn-pager">«</a>
        {% else %}
          <span class="btn-pager disabled">«</span>
        {% endif %}
        {% for num in scripts_page.paginator.page_range %}
          {% if num == scripts_page.number %}
            <span class="btn-pager active">{{ num }}</span>
          {% else %}
            <a href="?page={{ num }}&page_size={{ scripts_page.paginator.per_page }}" class="btn-pager">{{ num }}</a>
          {% endif %}
        {% endfor %}
        {% if scripts_page.has_next %}
          <a href="?page={{ scripts_page.next_page_number }}&page_size={{ scripts_page.paginator.per_page }}" class="btn-pager">»</a>
        {% else %}
          <span class="btn-pager disabled">»</span>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
/* datatable dinâmico */
.projects-table{ table-layout:auto; width:100%; }
.projects-table th, .projects-table td{ padding:.45rem .5rem; vertical-align:middle; overflow:hidden; }
.projects-table .id-col{ min-width:64px; width:auto; text-align:center; }
.projects-table .name-col{ min-width:160px; max-width:45%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.projects-table .desc-col{ max-width:60ch; overflow:hidden; text-overflow:ellipsis; }
.projects-table .type-col{ min-width:110px; text-transform:capitalize; }
.projects-table .actions-col{ min-width:180px; text-align:right; white-space:nowrap; }

/* botões de ícone (compactos) */
.btn-icon{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:32px;
  height:32px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.03);
  background:transparent;
  color:var(--muted);
  cursor:pointer;
  margin-left:6px;
  text-decoration:none;
}
.btn-icon svg{ display:block; }
.btn-success{ background: rgba(79,209,197,0.06); color:#4fd1c5; border-color: rgba(79,209,197,0.08); }
.btn-info{ background: rgba(96,165,250,0.06); color:var(--accent-2); border-color: rgba(96,165,250,0.08); }
.btn-warning{ background: rgba(255,184,93,0.06); color:#ffb85d; border-color: rgba(255,184,93,0.08); }
.btn-danger{ background: rgba(255,139,139,0.06); color:#ff8b8b; border-color: rgba(255,139,139,0.08); }

.btn-pager{ display:inline-flex; padding:.28rem .5rem; border-radius:6px; border:1px solid rgba(255,255,255,0.03); text-decoration:none; color:var(--muted); }
.btn-pager.active{ background:rgba(255,255,255,0.03); color:var(--text); font-weight:700; }
.btn-pager.disabled{ opacity:0.45; cursor:default; }
</style>

<script>
(function(){
  const tbody = document.getElementById('scripts-body');

  tbody.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('[data-action], a.btn-icon[data-action], button[data-action]') || ev.target.closest('button[data-action]') || ev.target.closest('button[data-id][data-action]') || ev.target.closest('button');
    // botão de executar:
    const runBtn = ev.target.closest('button[data-action="run"]') || ev.target.closest('button[data-action]');
    if(runBtn && runBtn.dataset.action === 'run'){
      const id = runBtn.dataset.id;
      const resp = await fetch(`/scripts/${id}/run/`);
      const data = await resp.json().catch(()=>({status:'error'}));
      if(data.status === 'ok'){
        alert('Execução simulada iniciada para script ' + id);
      } else {
        alert('Falha ao iniciar execução (simulação).');
      }
      return;
    }
    // outros links seguem navegação padrão (placeholders)
  });
})();
</script>
{% endblock %}