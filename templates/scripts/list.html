{% extends "base.html" %}
{% load static %}
{% block title %}Scripts — ARPIA{% endblock %}

{% block content %}
<div class="main">
  <div class="scripts-header">
    <div>
      <h2>Scripts operacionais</h2>
      <p class="page-subtitle">Aproveite playbooks de Nmap e personalize varreduras com os dados do projeto.</p>
    </div>
    <div class="actions">
      <a
        href="{% url 'scripts_create' %}{% if selected_project_id %}?project={{ selected_project_id }}{% endif %}"
        class="btn btn-primary btn-new-script"
      >Novo Script</a>
    </div>
  </div>

  <div class="layout">
    <div class="table-card card">
      <div class="table-toolbar">
        <div class="project-select">
          <label for="script-project-select">Projeto de referência</label>
          <select id="script-project-select" name="project">
            {% if project_options %}
              {% for project in project_options %}
                <option value="{{ project.id }}" {% if project.id == selected_project_id %}selected{% endif %}>{{ project.name }}</option>
              {% endfor %}
            {% else %}
              <option value="">Nenhum projeto disponível</option>
            {% endif %}
          </select>
        </div>
        <div class="page-size">
          <label for="page-size-select">Entradas</label>
          <select id="page-size-select">
            {% for option in page_size_choices %}
              <option value="{{ option }}" {% if scripts_page.paginator.per_page == option %}selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="table-wrapper">
        <table class="scripts-table">
          <thead>
            <tr>
              <th class="col-name">Nome</th>
              <th class="col-desc">Descrição</th>
              <th class="col-tags">Tags</th>
              <th class="col-type">Tipo</th>
              <th class="col-updated">Atualizado</th>
              <th class="col-actions">Ações</th>
            </tr>
          </thead>
          <tbody id="scripts-body">
            {% for s in scripts %}
              <tr>
                <td class="col-name">
                  <div class="script-name">{{ s.name }}</div>
                  <div class="script-filename">{{ s.filename }}</div>
                </td>
                <td class="col-desc">{{ s.description|default:"—" }}</td>
                <td class="col-tags">
                  {% if s.tags %}
                    <div class="tag-list">
                      {% for tag in s.tags %}
                        <span class="tag">{{ tag }}</span>
                      {% endfor %}
                    </div>
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
                <td class="col-type">
                  {% if s.is_default %}
                    <span class="badge badge-default">Default</span>
                  {% else %}
                    <span class="badge badge-custom">Personalizado</span>
                  {% endif %}
                </td>
                <td class="col-updated">{{ s.updated_at|date:"Y-m-d H:i" }}</td>
                <td class="col-actions">
                  {% if s.can_edit %}
                    <a href="{% url 'scripts_edit' s.id %}" class="btn-icon btn-success" title="Editar">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 21l3-1 11-11 1-3L14 3 3 14v7z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </a>
                  {% endif %}

                  {% if s.can_clone %}
                    <form method="post" action="{% url 'scripts_clone' s.id %}" class="inline-form" title="Clonar">
                      {% csrf_token %}
                      <button type="submit" class="btn-icon btn-info">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><rect x="9" y="9" width="13" height="13" rx="2" stroke="currentColor" stroke-width="1.4"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke="currentColor" stroke-width="1.4"/></svg>
                      </button>
                    </form>
                  {% endif %}

                  {% if s.can_reset %}
                    <form method="post" action="{% url 'scripts_reset' s.id %}" class="inline-form" title="Resetar">
                      {% csrf_token %}
                      <button type="submit" class="btn-icon btn-warning">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 11-3.17-6.37" stroke="currentColor" stroke-width="1.4"/><path d="M21 3v6h-6" stroke="currentColor" stroke-width="1.4"/></svg>
                      </button>
                    </form>
                  {% endif %}

                  <button type="button" class="btn-icon btn-info" data-run-script data-id="{{ s.id }}" data-name="{{ s.name }}" title="Pré-visualizar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M5 3v18l15-9L5 3z" stroke="currentColor" stroke-width="1.2"/></svg>
                  </button>

                  {% if s.can_delete %}
                    <form method="post" action="{% url 'scripts_delete' s.id %}" class="inline-form" title="Excluir" onsubmit="return confirm('Excluir script {{ s.name }}?');">
                      {% csrf_token %}
                      <button type="submit" class="btn-icon btn-danger">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 6h18" stroke="currentColor" stroke-width="1.4"/><path d="M8 6v14a1 1 0 001 1h6a1 1 0 001-1V6" stroke="currentColor" stroke-width="1.4"/><path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="1.4"/></svg>
                      </button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="empty">Nenhum script disponível. Clone um default ou crie um personalizado.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="pagination">
        <div class="page-info">Página {{ scripts_page.number }} de {{ scripts_page.paginator.num_pages }}</div>
        <div class="pager">
          {% if scripts_page.has_previous %}
            <a href="?page={{ scripts_page.previous_page_number }}&page_size={{ scripts_page.paginator.per_page }}&project={{ selected_project_id }}" class="btn-pager">«</a>
          {% else %}
            <span class="btn-pager disabled">«</span>
          {% endif %}
          {% for num in scripts_page.paginator.page_range %}
            {% if num == scripts_page.number %}
              <span class="btn-pager active">{{ num }}</span>
            {% else %}
              <a href="?page={{ num }}&page_size={{ scripts_page.paginator.per_page }}&project={{ selected_project_id }}" class="btn-pager">{{ num }}</a>
            {% endif %}
          {% endfor %}
          {% if scripts_page.has_next %}
            <a href="?page={{ scripts_page.next_page_number }}&page_size={{ scripts_page.paginator.per_page }}&project={{ selected_project_id }}" class="btn-pager">»</a>
          {% else %}
            <span class="btn-pager disabled">»</span>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="side-panel">
      <div class="card macros-card">
        <div class="card-header">
          <h3>Macros disponíveis</h3>
          <p class="muted">Esses placeholders são substituídos pelos dados do projeto selecionado.</p>
        </div>
        <ul class="macro-list">
          {% for macro in macro_entries %}
            <li>
              <div class="macro-key">{{ macro.key }}</div>
              {% if macro.is_pre %}
                <pre class="macro-value">{{ macro.value }}</pre>
              {% else %}
                <span class="macro-value">{{ macro.value|default:"—" }}</span>
              {% endif %}
            </li>
          {% empty %}
            <li><span class="muted">Nenhum dado disponível para o projeto atual.</span></li>
          {% endfor %}
        </ul>
      </div>

      <div class="card preview-card">
        <div class="preview-header">
          <div>
            <h3 id="script-preview-title">Pré-visualização</h3>
            <p class="muted">Execute um script para gerar uma versão pronta com macros resolvidas.</p>
          </div>
          <button type="button" class="btn btn-ghost" id="copy-script" disabled>Copiar</button>
        </div>
        <pre id="script-preview" class="script-preview">Selecione um script para visualizar.</pre>
      </div>
    </div>
  </div>
</div>

{{ project_macros|json_script:"project-macros-data" }}

<style>
.scripts-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:1.4rem;gap:1rem;}
.scripts-header h2{margin:0;color:var(--text);font-size:1.6rem;}
.page-subtitle{margin:.2rem 0 0;color:var(--muted);font-size:.95rem;}
.btn-new-script{display:inline-flex;align-items:center;padding:.5rem 1.1rem;border-radius:10px;font-weight:600;}
.layout{display:grid;grid-template-columns:2fr 1fr;gap:1.2rem;align-items:start;}
.table-card{padding:1rem;}
.table-toolbar{display:flex;justify-content:space-between;gap:1rem;flex-wrap:wrap;margin-bottom:.8rem;}
.project-select label,.page-size label{display:block;font-size:.75rem;text-transform:uppercase;color:var(--muted);margin-bottom:.2rem;letter-spacing:.08em;}
.project-select select,.page-size select{min-width:190px;padding:.4rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:var(--text);}
.table-wrapper{overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,0.03);} 
.scripts-table{width:100%;border-collapse:collapse;font-size:.92rem;color:var(--muted);}
.scripts-table thead{background:rgba(255,255,255,0.02);}
.scripts-table th,.scripts-table td{padding:.65rem .75rem;vertical-align:top;border-bottom:1px solid rgba(255,255,255,0.04);}
.scripts-table tbody tr:hover{background:rgba(255,255,255,0.01);}
.col-name{min-width:220px;color:var(--text);} 
.script-name{font-weight:600;color:var(--text);} 
.script-filename{font-size:.78rem;color:var(--muted);}
.col-desc{max-width:420px;}
.tag-list{display:flex;flex-wrap:wrap;gap:.35rem;}
.tag{background:rgba(79,209,197,0.08);border:1px solid rgba(79,209,197,0.14);color:#4fd1c5;padding:.15rem .45rem;border-radius:999px;font-size:.7rem;text-transform:uppercase;letter-spacing:.05em;}
.badge{display:inline-flex;align-items:center;padding:.25rem .6rem;border-radius:999px;font-size:.72rem;text-transform:uppercase;letter-spacing:.08em;}
.badge-default{background:rgba(96,165,250,0.08);color:var(--accent-2);}
.badge-custom{background:rgba(79,209,197,0.08);color:#4fd1c5;}
.col-updated{white-space:nowrap;font-size:.85rem;}
.col-actions{white-space:nowrap;text-align:right;}
.inline-form{display:inline-block;margin:0 .2rem;}
.btn-icon{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:9px;border:1px solid rgba(255,255,255,0.05);background:transparent;color:var(--muted);cursor:pointer;margin:0 .15rem;text-decoration:none;transition:transform .15s ease;}
.btn-icon:hover{transform:translateY(-1px);}
.btn-icon svg{display:block;}
.btn-success{background:rgba(79,209,197,0.08);color:#4fd1c5;border-color:rgba(79,209,197,0.14);} 
.btn-info{background:rgba(96,165,250,0.08);color:var(--accent-2);border-color:rgba(96,165,250,0.14);} 
.btn-warning{background:rgba(255,184,93,0.08);color:#ffb85d;border-color:rgba(255,184,93,0.14);} 
.btn-danger{background:rgba(255,139,139,0.08);color:#ff8b8b;border-color:rgba(255,139,139,0.14);} 
.btn-icon:disabled,.btn-icon.disabled{opacity:.45;cursor:not-allowed;}
.empty{padding:1rem;text-align:center;color:var(--muted);}
.pagination{display:flex;justify-content:space-between;align-items:center;margin-top:.9rem;font-size:.85rem;color:var(--muted);flex-wrap:wrap;gap:.6rem;}
.btn-pager{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);text-decoration:none;color:var(--muted);} 
.btn-pager.active{background:rgba(255,255,255,0.07);color:var(--text);font-weight:600;} 
.btn-pager.disabled{opacity:.4;cursor:default;} 
.side-panel{display:grid;gap:1rem;} 
.macros-card{padding:1rem;} 
.macro-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.8rem;} 
.macro-key{font-size:.75rem;text-transform:uppercase;letter-spacing:.08em;color:var(--accent-2);margin-bottom:.25rem;} 
.macro-value{display:block;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;font-size:.8rem;color:var(--text);background:rgba(15,23,42,0.45);border:1px solid rgba(148,163,184,0.15);border-radius:8px;padding:.45rem .6rem;white-space:pre-wrap;word-break:break-word;} 
.preview-card{padding:1rem;} 
.preview-header{display:flex;align-items:flex-start;justify-content:space-between;gap:.6rem;} 
#copy-script{padding:.35rem .75rem;border-radius:8px;background:rgba(96,165,250,0.08);border:1px solid rgba(96,165,250,0.14);color:var(--accent-2);cursor:pointer;} 
#copy-script:disabled{opacity:.4;cursor:not-allowed;} 
.script-preview{margin:1rem 0 0;background:rgba(2,16,35,0.8);border-radius:10px;border:1px solid rgba(148,163,184,0.15);padding:.8rem;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;font-size:.82rem;color:#dbeafe;min-height:220px;overflow:auto;} 
.muted{color:var(--muted);} 

@media (max-width:1080px){
  .layout{grid-template-columns:1fr;}
  .side-panel{grid-template-columns:1fr;}
}
</style>

<script>
(function(){
  const projectSelect = document.getElementById('script-project-select');
  const pageSizeSelect = document.getElementById('page-size-select');
  const runButtons = document.querySelectorAll('[data-run-script]');
  const preview = document.getElementById('script-preview');
  const previewTitle = document.getElementById('script-preview-title');
  const copyBtn = document.getElementById('copy-script');

  if(projectSelect){
    projectSelect.addEventListener('change', ()=>{
      const params = new URLSearchParams(window.location.search);
      if(projectSelect.value){
        params.set('project', projectSelect.value);
      } else {
        params.delete('project');
      }
      params.set('page', '1');
      params.set('page_size', pageSizeSelect?.value || '10');
      window.location.search = params.toString();
    });
  }

  if(pageSizeSelect){
    pageSizeSelect.addEventListener('change', ()=>{
      const params = new URLSearchParams(window.location.search);
      params.set('page_size', pageSizeSelect.value);
      params.set('page', '1');
      if(projectSelect?.value){
        params.set('project', projectSelect.value);
      }
      window.location.search = params.toString();
    });
  }

  runButtons.forEach((btn)=>{
    btn.addEventListener('click', async ()=>{
      const scriptId = btn.dataset.id;
      if(!scriptId){ return; }
      const projectId = projectSelect?.value || '';
      const url = projectId ? `/scripts/${scriptId}/run/?project=${projectId}` : `/scripts/${scriptId}/run/`;
      btn.disabled = true;
      btn.classList.add('disabled');
      try{
        const resp = await fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}});
        if(!resp.ok){ throw new Error('Erro ao obter script'); }
        const data = await resp.json();
        if(data.status === 'ok'){
          preview.textContent = data.content || 'Nenhum conteúdo retornado.';
          previewTitle.textContent = `Pré-visualização — ${btn.dataset.name || 'script'}`;
          copyBtn.disabled = !(data.content && data.content.length);
          copyBtn.dataset.content = data.content || '';
        } else {
          preview.textContent = 'Falha ao gerar script.';
          copyBtn.disabled = true;
        }
      } catch(err){
        console.error(err);
        preview.textContent = 'Erro ao executar script. Verifique o console do navegador.';
        copyBtn.disabled = true;
      } finally {
        btn.disabled = false;
        btn.classList.remove('disabled');
      }
    });
  });

  if(copyBtn){
    copyBtn.addEventListener('click', async ()=>{
      const text = copyBtn.dataset.content || preview.textContent;
      if(!text){ return; }
      try{
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = 'Copiado!';
        setTimeout(()=>{ copyBtn.textContent = 'Copiar'; }, 1800);
      } catch(err){
        console.warn('Clipboard indisponível', err);
      }
    });
  }
})();
</script>
{% endblock %}