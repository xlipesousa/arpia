<!doctype html>
{% extends "base.html" %}
{% load static %}
{% block title %}Relatórios — ARPIA{% endblock %}

{% block content %}
<div class="main">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
    <h2 style="margin:0;color:var(--text)">Relatórios</h2>
    <div style="display:flex;gap:.6rem;align-items:center;">
      <!-- Novo Relatório: botão primário com gradiente -->
      <a href="#" id="btn-new-report" class="btn btn-primary" style="display:inline-flex;align-items:center;gap:.6rem;padding:.45rem .8rem;border-radius:8px;background:linear-gradient(90deg,#4fd1c5,var(--accent));color:#021023;text-decoration:none;font-weight:700;">
        Novo Relatório
      </a>

      <!-- Gerar Selecionados: destaque em verde (ação positiva) -->
      <button id="btn-generate-selected" class="btn" style="display:inline-flex;align-items:center;gap:.5rem;padding:.4rem .7rem;border-radius:8px;background:rgba(79,209,197,0.06);color:#4fd1c5;border:1px solid rgba(79,209,197,0.08);font-weight:700;cursor:pointer;">
        Gerar Selecionados
      </button>

      <!-- Exportar: botão secundário com borda -->
      <a href="#" id="btn-export-all" class="btn" style="display:inline-flex;align-items:center;gap:.5rem;padding:.35rem .7rem;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);text-decoration:none;font-weight:700;">
        Exportar
      </a>
    </div>
  </div>

  <div class="card" style="padding:.75rem;">
    <div style="display:flex;gap:1rem;margin-bottom:.75rem;flex-wrap:wrap;">
      <div style="display:flex;gap:.5rem;align-items:center;">
        <label style="color:var(--muted)">Projeto</label>
        <select id="filter-project" style="padding:.3rem .5rem;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.03);">
          <option value="">Todos</option>
          <option>Infra Red Team</option>
          <option>Web App Audit</option>
        </select>
      </div>

      <div style="display:flex;gap:.5rem;align-items:center;">
        <label style="color:var(--muted)">Tipo</label>
        <select id="filter-type" style="padding:.3rem .5rem;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.03);">
          <option value="">Todos</option>
          <option value="full">Full</option>
          <option value="delta">Delta</option>
          <option value="exec">Executive</option>
        </select>
      </div>

      <div style="display:flex;gap:.5rem;align-items:center;">
        <label style="color:var(--muted)">Período</label>
        <input id="filter-from" type="date" style="padding:.3rem .5rem;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.03);">
        <span style="color:var(--muted)">—</span>
        <input id="filter-to" type="date" style="padding:.3rem .5rem;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.03);">
      </div>

      <div style="margin-left:auto;color:var(--muted);display:flex;align-items:center;gap:.6rem">
        <input id="q" placeholder="Pesquisar..." style="padding:.35rem .6rem;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)">
        <button id="btn-filter" class="btn" style="display:inline-flex;align-items:center;gap:.6rem;padding:.45rem .8rem;border-radius:8px;background:linear-gradient(90deg,#4fd1c5,var(--accent));color:#021023;border:1px solid rgba(79,209,197,0.08);font-weight:700;text-decoration:none;cursor:pointer;">
          Aplicar
        </button>
      </div>
    </div>

    <div style="overflow:auto;">
      <table id="reports-table" class="projects-table" style="width:100%;color:var(--muted);">
        <thead>
          <tr style="text-align:left;font-weight:700;color:var(--muted);">
            <th style="padding:.45rem .6rem;"><input type="checkbox" id="chk-all"></th>
            <th>ID</th>
            <th>Título</th>
            <th>Projeto</th>
            <th>Tipo</th>
            <th>Criado</th>
            <th>Status</th>
            <th style="text-align:right">Ações</th>
          </tr>
        </thead>
        <tbody id="reports-body">
          <!-- dados fictícios -->
          <tr>
            <td style="padding:.45rem .6rem;"><input type="checkbox" data-id="1"></td>
            <td>1</td>
            <td style="color:var(--text)">Executive summary — Infra Red Team</td>
            <td>Infra Red Team</td>
            <td>executive_only</td>
            <td>2025-09-01</td>
            <td><span style="padding:.12rem .5rem;border-radius:6px;background:rgba(79,209,197,0.04);color:#7eeacf">Pronto</span></td>
            <td style="text-align:right">
              <a href="{% url 'reports_detail' 1 %}" class="btn-icon btn-info" title="Ver">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </a>
              <button class="btn-icon btn-success" data-id="1" data-action="generate" title="Gerar"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3v12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 11l4 4 4-4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
              <a href="#" class="btn-icon btn-info" title="Baixar"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3v12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21H3" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg></a>
              <a href="#" class="btn-icon btn-danger" title="Remover"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 6v14a1 1 0 001 1h6a1 1 0 001-1V6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg></a>
            </td>
          </tr>

          <tr>
            <td style="padding:.45rem .6rem;"><input type="checkbox" data-id="2"></td>
            <td>2</td>
            <td style="color:var(--text)">Full report — Web App Audit</td>
            <td>Web App Audit</td>
            <td>full</td>
            <td>2025-08-21</td>
            <td><span style="padding:.12rem .5rem;border-radius:6px;background:rgba(255,184,93,0.04);color:#ffb85d">Em fila</span></td>
            <td style="text-align:right">
              <a href="{% url 'reports_detail' 2 %}" class="btn-icon btn-info" title="Ver"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg></a>
              <button class="btn-icon btn-success" data-id="2" data-action="generate" title="Gerar"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3v12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 11l4 4 4-4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
              <a href="#" class="btn-icon btn-info" title="Baixar"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3v12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21H3" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg></a>
              <a href="#" class="btn-icon btn-danger" title="Remover"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 6v14a1 1 0 001 1h6a1 1 0 001-1V6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg></a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between;padding:.7rem .3rem;margin-top:.6rem;">
      <div>
        Mostrar
        <select id="reports-page-size" style="padding:.25rem .4rem;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
        </select>
        entradas
      </div>

      <div id="reports-paginator" style="display:flex;gap:.35rem;align-items:center;"></div>
    </div>
  </div>
</div>

<style>
/* reaproveita estilos de datatable do projeto */
.projects-table{ table-layout:auto; width:100%; border-collapse:collapse; }
.projects-table th, .projects-table td{ padding:.45rem .6rem; vertical-align:middle; overflow:hidden; color:var(--muted); }
.projects-table td:nth-child(2), .projects-table th:nth-child(2){ width:56px; text-align:center; color:var(--muted); }
.projects-table td:nth-child(3){ color:var(--text); max-width:40ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.projects-table .actions-col{ min-width:180px; text-align:right; white-space:nowrap; }

/* botão de ícone */
.btn-icon{ display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:var(--muted); cursor:pointer; margin-left:6px; text-decoration:none; }
.btn-icon svg{ display:block; width:16px; height:16px; stroke:currentColor; fill:none; stroke-width:1.4; }

/* destaque de status */
span.badge { padding:.12rem .5rem; border-radius:6px; font-weight:700; }

/* pager */
.btn-pager{ display:inline-flex; padding:.28rem .5rem; border-radius:6px; border:1px solid rgba(255,255,255,0.03); text-decoration:none; color:var(--muted); }
.btn-pager.active{ background:rgba(255,255,255,0.03); color:var(--text); font-weight:700; }
.btn-pager.disabled{ opacity:0.45; cursor:default; }

/* ===== melhorias visuais para filtros / selects / inputs (destaque em fundo escuro) ===== */
.card .filters, .card .filters * { box-sizing: border-box; }

/* Realce dos selects e date inputs usados como filtros */
.card select,
.card input[type="date"],
.card input[type="text"],
.card input#q {
  background: linear-gradient(180deg, rgba(255,255,255,0.018), rgba(255,255,255,0.012));
  border: 1px solid rgba(255,255,255,0.06);
  color: var(--text);
  padding: .38rem .6rem;
  border-radius: 8px;
  min-height: 36px;
  outline: none;
  box-shadow: 0 6px 18px rgba(2,16,35,0.035);
  transition: box-shadow .18s ease, border-color .12s ease, transform .08s ease;
}

/* Aparência consistente dos selects em todos os browsers */
.card select {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background-image: linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.18) 50%), linear-gradient(135deg, rgba(255,255,255,0.18) 50%, transparent 50%);
  background-position: calc(100% - 14px) calc(1em + 1px), calc(100% - 9px) calc(1em + 1px);
  background-size: 6px 6px, 6px 6px;
  background-repeat: no-repeat;
  padding-right: 2.2rem;
}

/* Foco — destaca ainda mais para acessibilidade */
.card select:focus,
.card input[type="date"]:focus,
.card input#q:focus {
  border-color: rgba(79,209,197,0.18);
  box-shadow: 0 10px 30px rgba(79,209,197,0.05), 0 3px 8px rgba(2,16,35,0.06);
  transform: translateY(-1px);
  color: var(--text);
}

/* Placeholder do campo de pesquisa */
.card input#q::placeholder { color: rgba(255,255,255,0.35); }

/* Botão "Aplicar" — destaque visual consistente com o projeto (primário compacto) */
#btn-filter {
  display:inline-flex;
  align-items:center;
  gap:.4rem;
  padding:.38rem .7rem;
  border-radius:8px;
  background: linear-gradient(90deg,#4fd1c5,var(--accent));
  color: #021023; /* mesma cor do botão "Novo Relatório" */
  border: 1px solid rgba(79,209,197,0.08);
  font-weight:700;
  cursor:pointer;
  box-shadow: 0 8px 26px rgba(4,18,42,0.06);
}

/* Pequeno hover/active para o botão aplicar */
#btn-filter:hover { transform: translateY(-1px); box-shadow: 0 12px 34px rgba(4,18,42,0.08); }
#btn-filter:active { transform: translateY(0); }

/* Espaçamento e alinhamento para o bloco de filtros (para responsividade) */
.card > div[style*="display:flex;gap:1rem"] { gap: .75rem; align-items:center; }
.card label { color: var(--muted); margin-right:.25rem; font-size:.95rem; }

/* garantir contraste para datas/seletores pequenos */
.card input[type="date"]::-webkit-calendar-picker-indicator { filter: brightness(0.95) invert(0.9); }

/* mantendo o botão novo/gerar/exportar com aparência coerente (se sobrescrito por inline styles) */
.btn{ border-radius:8px; padding:.35rem .65rem; font-weight:700; }

/* ajuste fino em telas menores */
@media (max-width:900px){
  .card > div[style*="display:flex;gap:1rem"]{ flex-direction:column; align-items:stretch; gap:.5rem; }
  .card select, .card input[type="date"], .card input#q { width:100%; }
  #btn-filter { width:100%; justify-content:center; }
}
</style>

<script>
(function(){
  /* client-side pager (reutilizável) */
  function makePager(tbodyId, pageSizeSelId, paginatorId){
    const tbody = document.getElementById(tbodyId); if(!tbody) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const pageSizeSel = document.getElementById(pageSizeSelId);
    const paginator = document.getElementById(paginatorId);
    let pageSize = parseInt(pageSizeSel.value,10) || 10;
    let current = 1;
    function render(){
      const total = rows.length; const pages = Math.max(1, Math.ceil(total / pageSize));
      if(current > pages) current = pages;
      const start = (current - 1) * pageSize; const end = start + pageSize;
      rows.forEach((r,i)=> r.style.display = (i>=start && i<end) ? '' : 'none');
      paginator.innerHTML = '';
      function mk(label,p,disabled=false){ const b=document.createElement('button'); b.type='button'; b.textContent=label; b.className='btn-pager'; if(disabled) b.classList.add('disabled'); b.addEventListener('click', ()=>{ if(!disabled){ current=p; render(); }}); return b; }
      paginator.appendChild(mk('«',1,current===1));
      const left = Math.max(1,current-2), right = Math.min(pages,current+2);
      for(let p=left;p<=right;p++){ const b=mk(p,p,false); if(p===current) b.classList.add('active'); paginator.appendChild(b); }
      paginator.appendChild(mk('»',pages,current===pages));
    }
    pageSizeSel.addEventListener('change', ()=>{ pageSize = parseInt(pageSizeSel.value,10); current = 1; render(); });
    render();
  }

  makePager('reports-body','reports-page-size','reports-paginator');

  // actions (generate)
  document.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('[data-action="generate"]');
    if(!btn) return;
    const id = btn.dataset.id;
    btn.disabled = true;
    const resp = await fetch(`/reports/${id}/generate/`, { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '' } });
    const data = await resp.json().catch(()=>({status:'error'}));
    alert('Gerar relatório — ' + (data.status || 'erro'));
    btn.disabled = false;
  });

  document.getElementById('chk-all')?.addEventListener('change', (ev)=>{
    const checked = ev.target.checked;
    document.querySelectorAll('#reports-body input[type="checkbox"]').forEach(c=> c.checked = checked );
  });
})();
</script>
{% endblock %}