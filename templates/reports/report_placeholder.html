{% extends "base.html" %}
{% load report_extras %}
{% block title %}Relatórios{% if project %} — {{ project.name }}{% elif session %} — {{ session.title }}{% endif %}{% endblock %}

{% block content %}
<section class="report-header">
  <div class="header-info">
    <a href="{% url 'arpia_scan:dashboard' %}{% if project %}?project={{ project.id }}{% endif %}" class="back-link">← Voltar para scans</a>
    <h1>{% if project %}Central de relatórios · {{ project.name }}{% elif session %}Relatório do scan {{ session.title }}{% else %}Central de relatórios{% endif %}</h1>
    <p class="page-subtitle">
      {% if project %}
        Consolidado das atividades de scan, vulnerabilidades, threat hunt e pentest deste projeto.
      {% elif session %}
        Visualização consolidada construída a partir do snapshot da sessão para acelerar análise e decisões.
      {% else %}
        Selecione um projeto ou sessão para visualizar os relatórios agregados dos módulos ARPIA.
      {% endif %}
    </p>
  </div>
  <div class="header-session">
    {% if session %}
      <div class="status-block">
        <span class="label">Status da sessão</span>
        <span class="status-pill status-{{ session.status }}">{{ session.get_status_display }}</span>
        <span class="muted">Referência #{{ session.reference }}</span>
      </div>
      <div class="header-actions">
        <a href="{% url 'arpia_scan:session_detail' session.id %}" class="btn-secondary">Abrir sessão</a>
        <a href="{% url 'arpia_report:api_session_report' session.id %}" class="btn-secondary" target="_blank" rel="noopener noreferrer">Exportar JSON</a>
      </div>
    {% elif project %}
      <div class="status-block">
        <span class="label">Projeto</span>
        <span class="status-pill">{{ project.name }}</span>
        <span class="muted">ID {{ project.pk }}</span>
      </div>
      <div class="header-actions">
        <a href="{% url 'arpia_report:api_project_report' project.id %}" class="btn-secondary" target="_blank" rel="noopener noreferrer">Exportar JSON</a>
      </div>
    {% endif %}
  </div>
</section>

<section class="report-overview">
  <article class="card final-report-card">
    <header>
      <h2>Relatório final do projeto</h2>
      <span class="badge">{{ project_report.status|default:'missing'|title }}</span>
    </header>
    <p class="summary">{{ project_report.summary|default:"Consolide os módulos para gerar o relatório final." }}</p>
    <dl class="final-meta">
      <div>
        <dt>Última geração</dt>
        <dd>{% if project_report.generated_at %}{{ project_report.generated_at|date:"d/m/Y H:i" }}{% else %}<span class="muted">—</span>{% endif %}</dd>
      </div>
      <div>
        <dt>Válido até</dt>
        <dd>{% if project_report.valid_until %}{{ project_report.valid_until|date:"d/m/Y" }}{% else %}<span class="muted">—</span>{% endif %}</dd>
      </div>
    </dl>
    <details class="payload-block">
      <summary>Visualizar dados consolidados</summary>
      <pre>{{ project_report_payload_json|default:"{}"|safe }}</pre>
    </details>
  </article>

  {% if scan_entry %}
    {% with stats=report_stats targets=report_targets timing=scan_snapshot.timing %}
    <article class="card scan-highlights">
      <header>
        <h2>Resumo da última sessão de scan</h2>
        <span class="badge">{{ scan_entry.metadata.status|default:'—'|title }}</span>
      </header>
      <div class="metrics-grid">
        <div class="metric-chip">
          <span class="metric-value">{{ stats.total_tasks|default:0 }}</span>
          <span class="metric-label">etapas</span>
        </div>
        <div class="metric-chip">
          <span class="metric-value">{{ stats.completed_tasks|default:0 }}</span>
          <span class="metric-label">concluídas</span>
        </div>
        <div class="metric-chip">
          <span class="metric-value">{{ stats.failed_tasks|default:0 }}</span>
          <span class="metric-label">falhas</span>
        </div>
        <div class="metric-chip">
          <span class="metric-value">{{ stats.total_findings|default:0 }}</span>
          <span class="metric-label">achados</span>
        </div>
        <div class="metric-chip">
          <span class="metric-value">{{ targets.open_ports|default:0 }}</span>
          <span class="metric-label">portas abertas</span>
        </div>
        <div class="metric-chip">
          <span class="metric-value">{% if timing.duration_seconds %}{{ timing.duration_seconds|floatformat:0 }}s{% else %}—{% endif %}</span>
          <span class="metric-label">duração</span>
        </div>
      </div>
      {% if report_highlights %}
      <ul class="highlights">
        {% for insight in report_highlights|slice:":3" %}
        <li class="highlight-item highlight-{{ insight.level|default:'info' }}">{{ insight.message }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% if session %}
        <a class="link" href="{% url 'arpia_scan:session_detail' session.id %}">Abrir detalhes da sessão</a>
      {% endif %}
    </article>
    {% endwith %}
  {% endif %}
</section>

{% if scan_snapshot %}
<section class="scan-detail-grid">
  <article class="card status-card">
    <header>
      <h3>Status das etapas</h3>
      <span class="muted">Distribuição de {{ report_stats.total_tasks|default:0 }} tarefas</span>
    </header>
    {% if status_chart %}
      <ul class="status-chart">
        {% for item in status_chart %}
          <li>
            <div class="status-row">
              <span>{{ item.label }}</span>
              <span class="status-count">{{ item.count }}</span>
            </div>
            <div class="status-bar">
              <span class="status-fill" style="width: {{ item.percentage }}%"></span>
              <span class="status-percentage">{{ item.percentage }}%</span>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="empty">Nenhuma tarefa executada nesta sessão.</p>
    {% endif %}
  </article>

  <article class="card timeline-card">
    <header>
      <h3>Linha do tempo</h3>
      <span class="muted">Ordens cronológicas com início e término</span>
    </header>
    {% if scan_timeline %}
      <ol class="timeline">
        {% for entry in scan_timeline %}
        <li>
          <div class="timeline-marker status-{{ entry.status|default:'pending' }}"></div>
          <div class="timeline-body">
            <div class="timeline-header">
              <strong>{{ entry.label }}</strong>
              <span class="badge">{{ entry.status|default:'pending'|title }}</span>
            </div>
            <div class="timeline-meta">
              <span>Início: {{ entry.started_at|default:"—" }}</span>
              <span>Término: {{ entry.finished_at|default:"—" }}</span>
              <span>Duração: {% if entry.duration_seconds %}{{ entry.duration_seconds|floatformat:1 }}s{% else %}—{% endif %}</span>
            </div>
          </div>
        </li>
        {% endfor %}
      </ol>
    {% else %}
      <p class="empty">Linha do tempo indisponível.</p>
    {% endif %}
  </article>

  <article class="card findings-card">
    <header>
      <h3>Achados do scan</h3>
      <span class="muted">{{ scan_findings|length }} registro(s)</span>
    </header>
    {% if scan_findings %}
      <ul class="finding-list">
        {% for finding in scan_findings|slice:":6" %}
        <li>
          <div class="finding-header">
            <span class="badge">{{ finding.kind_display|default:finding.kind }}</span>
            {% if finding.severity %}<span class="badge severity">{{ finding.severity|upper }}</span>{% endif %}
          </div>
          <strong>{{ finding.title }}</strong>
          <p class="muted">{{ finding.summary|default:"Sem descrição." }}</p>
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="empty">Nenhum achado documentado.</p>
    {% endif %}
  </article>

  <article class="card targets-card">
    <header>
      <h3>Superfície observada</h3>
      <span class="muted">{{ report_targets.hosts_count|default:0 }} hosts • {{ report_targets.open_ports|default:0 }} portas abertas</span>
    </header>
    {% if report_targets.hosts %}
      <ul class="target-list">
        {% for host in report_targets.hosts|slice:":4" %}
        <li>
          <div class="target-heading">
            <strong>{{ host.host }}</strong>
            {% if host.severity %}<span class="badge severity-{{ host.severity|lower }}">{{ host.severity|title }}</span>{% endif %}
          </div>
          <p class="muted">{% if host.hostname %}{{ host.hostname }} • {% endif %}{{ host.ports|length|default:0 }} porta(s)</p>
          {% if host.ports %}
          <div class="port-tags">
            {% for port in host.ports|slice:":6" %}
            <span class="port-tag">{{ port.port }}/{{ port.protocol|default:"tcp" }} {{ port.service|default:"" }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="empty">Nenhum alvo registrado.</p>
    {% endif %}
  </article>

  <article class="card services-card">
    <header>
      <h3>Serviços predominantes</h3>
      <span class="muted">{{ report_services.count|default:0 }} serviços</span>
    </header>
    {% if report_services.items %}
      <ul class="service-list">
        {% for item in report_services.items|slice:":6" %}
        <li>
          <strong>{{ item.service|default:"Desconhecido"|title }}</strong>
          <span class="muted">{{ item.occurrences|length|default:0 }} ocorrência(s)</span>
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="empty">Nenhum serviço agregado disponível.</p>
    {% endif %}
  </article>

  <article class="card tasks-card">
    <header>
      <h3>Etapas executadas</h3>
      <span class="muted">Detalhes das primeiras tarefas</span>
    </header>
    {% if scan_tasks %}
      <table class="tasks-table">
        <thead>
          <tr>
            <th>Ordem</th>
            <th>Etapa</th>
            <th>Status</th>
            <th>Ferramenta</th>
            <th>Início</th>
            <th>Término</th>
          </tr>
        </thead>
        <tbody>
          {% for task in scan_tasks|slice:":6" %}
          <tr>
            <td>{{ task.order }}</td>
            <td>{{ task.name }}</td>
            <td><span class="badge">{{ task.status|title }}</span></td>
            <td>{% if task.tool %}{{ task.tool.name|default:task.tool.slug }}{% else %}<span class="muted">—</span>{% endif %}</td>
            <td>{% if task.started_at %}{{ task.started_at|date:"d/m/Y H:i" }}{% else %}<span class="muted">—</span>{% endif %}</td>
            <td>{% if task.finished_at %}{{ task.finished_at|date:"d/m/Y H:i" }}{% else %}<span class="muted">—</span>{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="empty">Nenhuma etapa registrada.</p>
    {% endif %}
  </article>

  <article class="card raw-card">
    <header>
      <h3>Snapshot bruto</h3>
      <span class="muted">JSON completo do relatório provisório</span>
    </header>
    <details>
      <summary>Visualizar JSON</summary>
      <pre>{{ scan_snapshot_json|default:"{}"|safe }}</pre>
    </details>
  </article>
</section>
{% endif %}

<section class="report-sections">
  {% for section in sections.values %}
    <article class="card section-card section-{{ section.key }}">
      <header>
        <div>
          <h3>{{ section.label }}</h3>
          <p class="muted">{{ section.description }}</p>
        </div>
      </header>

      {% if section.items %}
        <ul class="section-list">
          {% for item in section.items %}
            <li class="section-item">
              <div class="item-header">
                <strong>{{ item.title }}</strong>
                {% if item.metadata.status %}
                  <span class="badge">{{ item.metadata.status|title }}</span>
                {% endif %}
              </div>
              {% if item.summary %}<p class="item-summary">{{ item.summary }}</p>{% endif %}
              <dl class="item-meta">
                {% for key, value in item.metadata.items %}
                  {% if value %}
                  <div>
                    <dt>{{ key|underscore_to_space|title }}</dt>
                    <dd>{{ value }}</dd>
                  </div>
                  {% endif %}
                {% endfor %}
              </dl>
              {% if item.link %}
                <a href="{{ item.link }}" class="item-link" target="_blank" rel="noopener noreferrer">Abrir detalhe</a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="empty">{{ section.empty_text }}</p>
      {% endif %}
    </article>
  {% endfor %}
</section>

{% if not has_report %}
  <section class="report-empty">
    <div class="card note-card">
      <h2>Nenhum relatório disponível</h2>
      <p>Finalize uma sessão de scan ou ingestão de dados de vulnerabilidades, hunt ou pentest para visualizar aqui.</p>
      <a href="{% url 'arpia_scan:dashboard' %}" class="btn-primary">Ir para sessões de scan</a>
    </div>
  </section>
{% endif %}

<style>
.report-header{display:flex;flex-direction:column;gap:1.4rem;margin-bottom:1.8rem;}
.header-info h1{margin:.2rem 0;font-size:2rem;color:var(--text);}
.back-link{text-decoration:none;color:var(--muted);font-size:.95rem;}
.back-link:hover{color:var(--text);}
.page-subtitle{margin:0;color:var(--muted);max-width:720px;}
.header-session{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:flex-end;gap:1rem;}
.status-block{display:flex;flex-direction:column;gap:.3rem;}
.status-block .label{font-size:.75rem;text-transform:uppercase;color:var(--muted);letter-spacing:.08em;}
.status-pill{display:inline-flex;align-items:center;padding:.35rem .9rem;border-radius:999px;font-weight:600;font-size:.85rem;background:rgba(255,255,255,0.08);color:var(--text);}
.status-running{background:rgba(123,195,255,0.22);}
.status-completed{background:rgba(118,221,174,0.25);}
.status-failed{background:rgba(255,132,132,0.25);}
.header-actions{display:flex;gap:.6rem;}
.btn-secondary,.btn-primary{display:inline-flex;align-items:center;justify-content:center;padding:.55rem 1.1rem;border-radius:999px;font-weight:600;font-size:.85rem;text-decoration:none;transition:.2s ease;}
.btn-secondary{background:rgba(76,148,255,0.16);border:1px solid rgba(76,148,255,0.25);color:#8bc5ff;}
.btn-secondary:hover{background:rgba(117,187,255,0.26);}
.btn-primary{background:rgba(118,221,174,0.18);border:1px solid rgba(118,221,174,0.28);color:#d8f6e9;}
.btn-primary:hover{background:rgba(118,221,174,0.28);}
.badge{display:inline-flex;align-items:center;padding:.3rem .8rem;border-radius:999px;font-weight:600;font-size:.75rem;background:rgba(255,255,255,0.08);color:var(--text);}
.muted{color:var(--muted);font-size:.85rem;}

.report-overview{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1.4rem;margin-bottom:1.6rem;}
.card{background:rgba(8,23,43,0.82);border-radius:16px;padding:1.4rem;border:1px solid rgba(255,255,255,0.05);box-shadow:0 18px 38px rgba(5,16,32,0.35);}
.card header{display:flex;align-items:center;justify-content:space-between;gap:.6rem;margin-bottom:1rem;}
.link{display:inline-flex;margin-top:.8rem;color:#8bc5ff;text-decoration:none;font-weight:600;}
.link:hover{text-decoration:underline;}
.final-report-card .summary{margin:0 0 1rem 0;color:var(--muted);}
.final-meta{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;margin:0 0 1rem 0;}
.final-meta dt{font-size:.75rem;text-transform:uppercase;color:var(--muted);letter-spacing:.08em;margin-bottom:.3rem;}
.payload-block summary{cursor:pointer;font-weight:600;}
.payload-block pre{max-height:220px;overflow:auto;margin-top:.6rem;background:rgba(0,0,0,0.35);padding:.9rem 1rem;border-radius:12px;font-size:.8rem;}

.metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:.9rem;margin-bottom:1rem;}
.metric-chip{display:flex;flex-direction:column;gap:.25rem;background:rgba(255,255,255,0.02);padding:.9rem 1rem;border-radius:12px;border:1px solid rgba(255,255,255,0.04);}
.metric-value{font-size:1.5rem;font-weight:700;color:#8bc5ff;}
.metric-label{font-size:.78rem;color:var(--muted);}
.highlights{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.6rem;}
.highlight-item{padding:.65rem .9rem;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);font-size:.9rem;}
.highlight-warning{border-color:rgba(255,214,165,0.3);}
.highlight-error{border-color:rgba(255,132,132,0.3);}
.highlight-success{border-color:rgba(118,221,174,0.3);}

.scan-detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1.4rem;margin-bottom:1.8rem;}
.status-chart{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.9rem;}
.status-row{display:flex;align-items:center;justify-content:space-between;font-weight:600;}
.status-bar{position:relative;height:10px;background:rgba(255,255,255,0.08);border-radius:999px;margin-top:.35rem;overflow:hidden;}
.status-fill{display:block;height:100%;background:linear-gradient(90deg,#7fb5ff,#4d9dff);}
.status-percentage{position:absolute;right:.4rem;top:50%;transform:translateY(-50%);font-size:.72rem;color:rgba(255,255,255,0.86);}
.timeline{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:1.2rem;}
.timeline li{display:flex;gap:.8rem;}
.timeline-marker{width:12px;height:12px;border-radius:999px;margin-top:.45rem;background:rgba(127,181,255,0.45);}
.timeline-marker.status-completed{background:rgba(118,221,174,0.65);}
.timeline-marker.status-failed{background:rgba(255,132,132,0.65);}
.timeline-body{flex:1;display:flex;flex-direction:column;gap:.4rem;}
.timeline-header{display:flex;align-items:center;gap:.6rem;font-size:1rem;font-weight:600;}
.timeline-meta{display:flex;flex-wrap:wrap;gap:.6rem;font-size:.8rem;color:var(--muted);}
.finding-list, .target-list, .service-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.9rem;}
.finding-header{display:flex;gap:.6rem;align-items:center;margin-bottom:.35rem;}
.target-heading{display:flex;align-items:center;justify-content:space-between;gap:.6rem;}
.port-tags{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.45rem;}
.port-tag{padding:.3rem .6rem;border-radius:999px;background:rgba(255,255,255,0.06);font-size:.78rem;color:rgba(255,255,255,0.85);}
.service-list li{display:flex;align-items:center;justify-content:space-between;gap:.6rem;padding:.55rem .75rem;background:rgba(255,255,255,0.02);border-radius:10px;border:1px solid rgba(255,255,255,0.04);}
.tasks-table{width:100%;border-collapse:collapse;font-size:.85rem;}
.tasks-table th, .tasks-table td{padding:.5rem .6rem;border-bottom:1px solid rgba(255,255,255,0.08);text-align:left;}
.tasks-table th{font-size:.75rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);}
.raw-card details{margin-top:.6rem;}
.raw-card pre{max-height:320px;overflow:auto;margin-top:.6rem;background:rgba(0,0,0,0.35);padding:.9rem 1rem;border-radius:12px;font-size:.8rem;}
.empty{color:var(--muted);font-size:.9rem;}

.report-sections{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1.4rem;}
.section-card header{margin-bottom:.8rem;}
.section-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:1rem;}
.section-item{border:1px solid rgba(255,255,255,0.05);border-radius:12px;padding:1rem;background:rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:.7rem;}
.item-header{display:flex;align-items:center;gap:.6rem;justify-content:space-between;}
.item-summary{margin:0;color:var(--muted);}
.item-meta{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.6rem;margin:0;}
.item-meta dt{font-size:.72rem;text-transform:uppercase;color:var(--muted);letter-spacing:.08em;margin-bottom:.2rem;}
.item-meta dd{margin:0;}
.item-link{align-self:flex-start;color:#8bc5ff;text-decoration:none;font-weight:600;font-size:.85rem;}
.item-link:hover{text-decoration:underline;}

.report-empty{margin-top:2rem;display:flex;}
.note-card{width:100%;max-width:540px;margin:0 auto;text-align:left;}
.note-card h2{margin-top:0;margin-bottom:.8rem;}
.note-card p{color:var(--muted);}

@media (max-width:900px){
  .header-session{align-items:flex-start;}
  .report-overview{grid-template-columns:1fr;}
  .scan-detail-grid{grid-template-columns:1fr;}
  .report-sections{grid-template-columns:1fr;}
}
</style>
{% endblock %}
