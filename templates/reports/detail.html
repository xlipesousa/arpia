{% extends "base.html" %}
{% load static %}
{% block title %}Relatório — ARPIA{% endblock %}

{% block content %}
<div class="main">
  <div style="display:flex;gap:1rem;align-items:flex-start;">
    <div style="flex:1;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem;">
        <div>
          <h2 style="margin:.1rem 0;color:var(--text)">Executive Summary — Relatório #{{ request.resolver_match.kwargs.pk }}</h2>
          <div style="color:var(--muted)">Projeto: Web App Audit • Tipo: full • Gerado em: 2025-08-21</div>
        </div>
        <div style="display:flex;gap:.6rem;align-items:center;">
          <a href="#" class="btn btn-primary">Exportar PDF</a>
          <!-- passar pk via data-attribute para evitar template-injection no JS -->
          <button id="btn-regenerate" class="btn" data-pk="{{ request.resolver_match.kwargs.pk }}" style="background:transparent;border:1px solid rgba(255,255,255,0.04);">Regenerar</button>
          <button id="btn-redact" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.04);">Redact</button>
        </div>
      </div>

      <nav style="display:flex;gap:.5rem;margin-bottom:.75rem;flex-wrap:wrap;">
        <a href="#executive" class="link small">Executive</a>
        <a href="#vuln" class="link small">Vulnerabilidades</a>
        <a href="#mitigation" class="link small">Plano de Mitigação</a>
        <a href="#delta" class="link small">Defensive Delta</a>
        <a href="#validation" class="link small">Exploit Validation</a>
        <a href="#manifest" class="link small">Manifest</a>
        <a href="#artifacts" class="link small">Artifacts</a>
      </nav>

      <section id="executive" style="margin-bottom:1rem;">
        <h3>Executive summary</h3>
        <p style="color:var(--muted)">Resumo executivo gerado por AI (placeholder). Pontos principais, riscos críticos e recomendações de alto nível.</p>
      </section>

      <section id="vuln" style="margin-bottom:1rem;">
        <h3>Vulnerabilities summary</h3>
        <table class="projects-table" style="width:100%;margin-top:.5rem;">
          <thead><tr><th>ID</th><th>Vuln</th><th>Severidade</th><th>Stack</th><th>Status</th></tr></thead>
          <tbody>
            <tr><td>V-101</td><td>SQL Injection em /login</td><td>Critical</td><td>Web App</td><td>New</td></tr>
            <tr><td>V-99</td><td>Open redirect</td><td>Medium</td><td>Web App</td><td>Persisted</td></tr>
          </tbody>
        </table>
      </section>

      <section id="mitigation" style="margin-bottom:1rem;">
        <h3>Mitigation plan</h3>
        <p style="color:var(--muted)">Agrupado por stack, esforço estimado e prioridade. (placeholder)</p>
      </section>

      <section id="delta" style="margin-bottom:1rem;">
        <h3>Defensive posture delta</h3>
        <p style="color:var(--muted)">Mudanças propostas na configuração defensiva.</p>
      </section>

      <section id="validation" style="margin-bottom:1rem;">
        <h3>Exploit validation summary</h3>
        <p style="color:var(--muted)">Resumo das validações de exploração realizadas (ofensivo).</p>
      </section>

      <section id="artifacts" style="margin-bottom:1rem;">
        <h3>Artifacts</h3>
        <ul style="color:var(--muted)">
          <li>scan-nmap-20250901.xml</li>
          <li>burp-report-20250820.json</li>
        </ul>
      </section>
    </div>

    <aside style="width:320px;">
      <div class="card" style="padding:.8rem;">
        <h4 style="margin:.2rem 0;color:var(--muted)">Manifest</h4>
        <div style="font-size:.85rem; color:var(--muted);">
          <div>hash_manifest: <code style="color:var(--text)">a1b2c3d4...</code></div>
          <div style="margin-top:.5rem">Seções:
            <ul style="color:var(--muted);margin:.3rem 0 0 1rem">
              <li>vulnerabilities_summary</li>
              <li>mitigation_plan</li>
              <li>artifacts</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="card" style="padding:.8rem;margin-top:.6rem;">
        <h4 style="margin:.2rem 0;color:var(--muted)">Quick actions</h4>
        <div style="display:flex;flex-direction:column;gap:.5rem;">
          <a href="#" class="btn">Download PDF</a>
          <a href="#" class="btn">Enviar por E-mail</a>
          <a href="#" class="btn">Criar tarefa de mitigation</a>
        </div>
      </div>
    </aside>
  </div>
</div>

<style>
.projects-table{ table-layout:auto; width:100%; border-collapse:collapse; }
.projects-table th, .projects-table td{ padding:.45rem .6rem; vertical-align:middle; overflow:hidden; color:var(--muted); }
.card{ background:rgba(255,255,255,0.01); border-radius:8px; padding:.6rem; }
.link.small{ color:var(--muted); text-decoration:none; padding:.25rem .45rem; border-radius:6px; background:transparent; }
</style>

<script>
document.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('#btn-regenerate');
  if(!btn) return;
  // ler pk do data-attribute (string) para evitar templating direto no JS
  const pk = btn.dataset.pk;
  if(!pk) return;
  fetch(`/reports/${pk}/generate/`, {
    method:'POST',
    headers:{
      'X-Requested-With':'XMLHttpRequest',
      'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || ''
    }
  })
  .then(r=>r.json()).then(d=> alert('Regenerar: ' + (d.status||'ok'))).catch(()=>alert('Erro (simulado)'));
});
</script>
{% endblock %}