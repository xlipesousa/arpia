{% extends "base.html" %}
{% load static %}
{% block title %}{{ project.name|default:"Novo Projeto" }} — ARPIA{% endblock %}

{% block content %}
<div class="main" style="padding:1.25rem;max-width:900px;margin:0 auto;">
  <h2 style="margin:0 0 1rem 0;color:var(--text)">{{ project.name|default:"Novo Projeto" }}</h2>

  <form action="{% if project %}{% url 'projects_edit' project.id %}{% else %}{% url 'projects_create' %}{% endif %}" method="post" class="card" style="padding:1rem;display:flex;flex-direction:column;gap:.75rem;">
    {% csrf_token %}
    <!-- básicos -->
    <label style="font-weight:700;color:var(--muted)">Nome</label>
    <input name="name" required placeholder="Nome do projeto" value="{{ project.name|default:form.name }}" style="padding:.5rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);">

    <label style="font-weight:700;color:var(--muted)">Descrição</label>
    <textarea name="description" placeholder="Breve descrição" rows="3" style="padding:.6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);resize:vertical;">{{ project.description|default:form.description }}</textarea>

    <label style="font-weight:700;color:var(--muted)">Cliente</label>
    <input name="client" type="text" placeholder="Nome da empresa contratante" value="{{ project.client|default:form.client }}" style="width:100%;padding:.45rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);" />

    <div style="display:flex;gap:.75rem;flex-wrap:wrap;">
      <div style="flex:1;min-width:220px;">
        <label style="font-weight:700;color:var(--muted)">Início</label>
        <input name="start" id="proj-start" type="datetime-local" value="{{ project.start|default:form.start }}" style="width:100%;padding:.45rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);">
      </div>
      <div style="flex:1;min-width:220px;">
        <label style="font-weight:700;color:var(--muted)">Término</label>
        <input name="end" id="proj-end" type="datetime-local" value="{{ project.end|default:form.end }}" style="width:100%;padding:.45rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);">
      </div>
    </div>

    <!-- complementares -->
    <h4 style="margin:.5rem 0 .25rem 0;color:var(--muted)">Dados complementares</h4>

  <label style="font-weight:700;color:var(--muted)">Hosts Alvo (separados por vírgula)</label>
  <input name="hosts" placeholder="ex: 10.0.0.5,example.com,192.168.1.2" value="{{ project.hosts|default:form.hosts }}" style="padding:.45rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);">

  <label style="font-weight:700;color:var(--muted)">Hosts Protegidos (separados por vírgula)</label>
  <input name="protected_hosts" placeholder="ex: 10.0.0.5,example.com,192.168.1.2" value="{{ project.protected_hosts|default:form.protected_hosts }}" style="padding:.45rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);">
    
    <label style="font-weight:700;color:var(--muted)">Networks (CIDR, vírgula separados)</label>
    <input name="networks" placeholder="ex: 10.0.0.0/24,192.168.0.0/16" value="{{ project.networks|default:form.networks }}" style="padding:.45rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);">

    <label style="font-weight:700;color:var(--muted)">Portas de interesse (porta/protocolo, separadas por vírgula)</label>
    <input name="ports" placeholder="ex: 22/tcp, 80/tcp, 53/udp" value="{{ project.ports|default:form.ports }}" style="padding:.45rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);">
    <p class="small-muted" style="margin:0;">Quando o protocolo for omitido, consideramos <strong>tcp</strong> automaticamente. Aceitamos apenas tcp ou udp.</p>
    {% if errors.ports %}
      <p class="form-error">{{ errors.ports }}</p>
    {% endif %}

    <!-- credenciais -->
    <div style="border:1px solid rgba(255,255,255,0.03);padding:.6rem;border-radius:8px;background:rgba(255,255,255,0.005)">
      <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem;">
        <label style="font-weight:700;color:var(--muted);margin-right:.5rem">Credenciais</label>
        <select id="cred-type" style="padding:.35rem .5rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);">
          <option value="userpass">username + password</option>
          <option value="usrs_ssh">username + ssh (passphrase + private key)</option>
          <option value="user">username only</option>
          <option value="pass">password only</option>
        </select>
      </div>

      <div id="cred-fields" style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.5rem;">
        <!-- campos dinâmicos -->
        <input id="cred-username" placeholder="username" style="display:none;padding:.4rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);min-width:200px;">
        <input id="cred-password" placeholder="password" style="display:none;padding:.4rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);min-width:200px;">
        <input id="cred-passphrase" placeholder="passphrase (opcional)" style="display:none;padding:.4rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);min-width:200px;">
        <textarea id="cred-pkey" placeholder="private key (PEM)" style="display:none;padding:.4rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);min-width:300px;min-height:88px;"></textarea>

        <div style="margin-left:auto;display:flex;gap:.5rem;align-items:center;">
          <button type="button" id="cred-add" class="btn btn-primary compact">Adicionar</button>
        </div>
      </div>

      <div id="cred-list-wrap" style="overflow:auto;">
        <table style="width:100%;border-collapse:collapse;color:var(--muted);">
          <thead>
            <tr style="text-align:left;font-weight:700;color:var(--muted);font-size:.85rem;">
              <th style="width:160px;padding:.4rem">Tipo</th>
              <th style="padding:.4rem">Campos</th>
              <th style="width:80px;padding:.4rem;text-align:right">Ações</th>
            </tr>
          </thead>
          <tbody id="cred-list">
            {% comment %} se houver credenciais já associadas, renderize aqui via context.credentials {% endcomment %}
            {% for c in project.credentials|default:form.credentials %}
            <tr>
              <td style="padding:.4rem;color:var(--text)">{{ c.type }}</td>
              <td style="padding:.4rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{ c.summary }}</td>
              <td style="padding:.4rem;text-align:right"><button type="button" class="btn btn-ghost btn-sm cred-remove">Remover</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <input type="hidden" name="credentials_json" id="credentials_json" value='{{ project.credentials_json|default:form.credentials_json|default:"[]" }}'>
    </div>

    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem;">
      <a href="{% url 'projects_list' %}" class="btn btn-ghost">Cancelar</a>
      <button type="submit" class="btn btn-primary">Salvar</button>
    </div>
  </form>
</div>

<style>
.card{ background:rgba(255,255,255,0.01); border-radius:10px; }
.btn{ border-radius:8px; padding:.35rem .6rem; font-weight:700; cursor:pointer; color:var(--muted); background:transparent; border:1px solid rgba(255,255,255,0.03); text-decoration:none; display:inline-flex; align-items:center; gap:.4rem; }
.btn-ghost{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); }
.btn-primary{ background:linear-gradient(90deg,#4fd1c5,var(--accent)); color:#021023; border:1px solid rgba(79,209,197,0.08); box-shadow:0 8px 26px rgba(4,18,42,0.06); }
.btn.compact{ padding:.32rem .5rem; font-size:.95rem; }
.small-muted{ color:var(--muted); font-size:.86rem; margin-right:.25rem; }
.form-error{ color:#f87171; font-size:.86rem; margin:0; }
</style>

<script>
(function(){
  // credenciais - gerência local (serializa em credentials_json)
  let creds = [];
  try{ creds = JSON.parse(document.getElementById('credentials_json').value || '[]'); }catch(e){ creds = []; }
  const credList = document.getElementById('cred-list');

  const typeSel = document.getElementById('cred-type');
  const fUsername = document.getElementById('cred-username');
  const fPassword = document.getElementById('cred-password');
  const fPassphrase = document.getElementById('cred-passphrase');
  const fPKey = document.getElementById('cred-pkey');
  const btnAdd = document.getElementById('cred-add');
  const hiddenInput = document.getElementById('credentials_json');

  function renderFieldsFor(type){
    // esconder todos
    [fUsername,fPassword,fPassphrase,fPKey].forEach(n=> n.style.display='none');
    if(type === 'userpass'){ fUsername.style.display='inline-block'; fPassword.style.display='inline-block'; }
    if(type === 'usrs_ssh'){ fUsername.style.display='inline-block'; fPassphrase.style.display='inline-block'; fPKey.style.display='inline-block'; }
    if(type === 'user'){ fUsername.style.display='inline-block'; }
    if(type === 'pass'){ fPassword.style.display='inline-block'; }
  }

  function renderList(){
    credList.innerHTML = '';
    creds.forEach((c, idx)=>{
      const tr = document.createElement('tr');
      const tdType = document.createElement('td'); tdType.style.padding='.4rem'; tdType.style.color='var(--text)'; tdType.innerText = c.type_label || c.type;
      const tdFields = document.createElement('td'); tdFields.style.padding='.4rem'; tdFields.style.color='var(--muted)';
      // criar resumo
      const parts = [];
      if(c.username) parts.push('user: ' + c.username);
      if(c.password) parts.push('pass: ' + (c.password.length>10? c.password.slice(0,10)+'…': c.password));
      if(c.passphrase) parts.push('passphrase: ' + (c.passphrase.length>10? c.passphrase.slice(0,10)+'…': c.passphrase));
      if(c.pkey) parts.push('pkey: ' + (c.pkey.length>30? c.pkey.slice(0,30)+'…': c.pkey));
      tdFields.innerText = parts.join(' · ');
      const tdActions = document.createElement('td'); tdActions.style.padding='.4rem'; tdActions.style.textAlign='right';
      const btn = document.createElement('button'); btn.type='button'; btn.className='btn btn-ghost btn-sm'; btn.innerText='Remover';
      btn.addEventListener('click', ()=> { creds.splice(idx,1); updateHidden(); renderList(); });
      tdActions.appendChild(btn);
      tr.appendChild(tdType); tr.appendChild(tdFields); tr.appendChild(tdActions);
      credList.appendChild(tr);
    });
    updateHidden();
  }

  function updateHidden(){ hiddenInput.value = JSON.stringify(creds); }

  // inicializar campos e lista
  renderFieldsFor(typeSel.value);
  renderList();

  typeSel.addEventListener('change', ()=> { renderFieldsFor(typeSel.value); });

  btnAdd.addEventListener('click', ()=>{
    const type = typeSel.value;
    const obj = { type: type, type_label: typeSel.options[typeSel.selectedIndex].text };
    if(type === 'userpass'){ obj.username = fUsername.value.trim(); obj.password = fPassword.value; if(!obj.username || !obj.password){ alert('username e password são obrigatórios'); return; } }
    if(type === 'usrs_ssh'){ obj.username = fUsername.value.trim(); obj.passphrase = fPassphrase.value; obj.pkey = fPKey.value; if(!obj.username || !obj.pkey){ alert('username e private key são obrigatórios'); return; } }
    if(type === 'user'){ obj.username = fUsername.value.trim(); if(!obj.username){ alert('username é obrigatório'); return; } }
    if(type === 'pass'){ obj.password = fPassword.value; if(!obj.password){ alert('password é obrigatório'); return; } }

    creds.push(obj);
    // limpar inputs relevantes
    [fUsername,fPassword,fPassphrase,fPKey].forEach(n=> n.value = '');
    renderList();
  });

  // delegação para remover itens se usuário usar botões gerados server-side
  document.addEventListener('click', (ev)=>{
    const rm = ev.target.closest('.cred-remove');
    if(!rm) return;
    const tr = rm.closest('tr');
    const idx = Array.from(credList.children).indexOf(tr);
    if(idx >= 0){ creds.splice(idx,1); renderList(); }
  });

  // garantir serialização ao submeter (caso algo não atualizado)
  document.querySelector('form')?.addEventListener('submit', ()=> updateHidden());

})();
</script>
{% endblock %}