{% extends "base.html" %}
{% load static %}
{% block title %}Compartilhar {{ project.name }} — ARPIA{% endblock %}

{% block content %}
<div class="main" style="padding:1.5rem;max-width:900px;margin:0 auto;display:flex;flex-direction:column;gap:1.5rem;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
    <div>
      <h2 style="margin:0;color:var(--text);">Compartilhar projeto</h2>
      <p style="margin:.4rem 0 0 0;color:var(--muted);">Gerencie quem pode acessar <strong>{{ project.name }}</strong>.</p>
    </div>
    <div>
      <a href="{% url 'projects_detail' project.id %}" class="btn btn-ghost">Voltar</a>
    </div>
  </div>

  <section class="card" style="padding:1.2rem;display:flex;flex-direction:column;gap:.65rem;">
    <span class="label">Link direto</span>
    <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
      <input id="share-link" type="text" readonly value="{{ share_url }}" style="flex:1;min-width:240px;padding:.5rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text);">
      <button type="button" class="btn btn-primary" id="share-copy">Copiar link</button>
    </div>
    <small style="color:var(--muted);">Compartilhe este link apenas com integrantes confiáveis. Ele requer autenticação na plataforma.</small>
  </section>

  <section class="card" style="padding:1.2rem;display:flex;flex-direction:column;gap:1rem;">
    <h3 style="margin:0;color:var(--text);font-size:1.05rem;">Adicionar participante</h3>
    <form action="" method="post" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.75rem;align-items:end;">
      {% csrf_token %}
      <div>
        <label class="label" for="share-username">Usuário</label>
        <input id="share-username" name="username" value="{{ form.username }}" placeholder="username" style="width:100%;padding:.5rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);">
        {% if errors.username %}<span class="error">{{ errors.username }}</span>{% endif %}
      </div>
      <div>
        <label class="label" for="share-role">Permissão</label>
        <select id="share-role" name="role" style="width:100%;padding:.5rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);">
          {% for value,label in role_choices %}
            <option value="{{ value }}" {% if form.role == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        {% if errors.role %}<span class="error">{{ errors.role }}</span>{% endif %}
      </div>
      <div>
        <button type="submit" class="btn btn-primary">Conceder acesso</button>
      </div>
    </form>
  </section>

  <section class="card" style="padding:1.2rem;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:.75rem;margin-bottom:1rem;">
      <h3 style="margin:0;color:var(--text);font-size:1.05rem;">Colaboradores atuais</h3>
      {% if errors.membership %}<span class="error" style="margin:0;">{{ errors.membership }}</span>{% endif %}
    </div>
    {% if memberships %}
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr style="text-align:left;color:var(--muted);font-size:.85rem;">
            <th style="padding:.4rem .5rem;">Usuário</th>
            <th style="padding:.4rem .5rem;">Permissão</th>
            <th style="padding:.4rem .5rem;">Adicionado por</th>
            <th style="padding:.4rem .5rem;">Desde</th>
            <th style="padding:.4rem .5rem;text-align:right;">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for member in memberships %}
          <tr style="border-top:1px solid rgba(255,255,255,0.03);">
            <td style="padding:.45rem .5rem;color:var(--text);">{{ member.user.get_full_name|default:member.user.username }}</td>
            <td style="padding:.45rem .5rem;color:var(--muted);">
              {% if member.user_id == project.owner_id %}
                {{ member.get_role_display }}
              {% else %}
                <form method="post" style="display:flex;gap:.5rem;align-items:center;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="update">
                  <input type="hidden" name="membership_id" value="{{ member.id }}">
                  <select name="role" style="padding:.35rem .5rem;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:var(--text);">
                    {% for value,label in role_choices %}
                      <option value="{{ value }}" {% if member.role == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                  <button type="submit" class="btn btn-small">Salvar</button>
                </form>
              {% endif %}
            </td>
            <td style="padding:.45rem .5rem;color:var(--muted);">
              {% if member.invited_by %}
                {{ member.invited_by.get_full_name|default:member.invited_by.username }}
              {% else %}
                —
              {% endif %}
            </td>
            <td style="padding:.45rem .5rem;color:var(--muted);white-space:nowrap;">{{ member.created_at|date:"d/m/Y H:i" }}</td>
            <td style="padding:.45rem .5rem;text-align:right;">
              {% if member.user_id != project.owner_id %}
              <form method="post" style="display:inline-flex;">
                {% csrf_token %}
                <input type="hidden" name="action" value="remove">
                <input type="hidden" name="membership_id" value="{{ member.id }}">
                <button type="submit" class="btn btn-danger btn-small">Revogar</button>
              </form>
              {% else %}
                <span style="color:var(--muted);font-size:.85rem;">Proprietário</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p style="margin:0;color:var(--muted);">Nenhum colaborador extra cadastrado ainda.</p>
    {% endif %}
  </section>
</div>

<style>
.card{ background:rgba(255,255,255,0.01); border-radius:12px; }
.btn{ border-radius:8px; padding:.4rem .7rem; font-weight:700; text-decoration:none; display:inline-flex; align-items:center; gap:.4rem; border:1px solid rgba(255,255,255,0.08); transition:all .2s ease; cursor:pointer; }
.btn-small{ padding:.25rem .6rem; font-size:.8rem; }
.btn-ghost{ background:transparent; color:var(--muted); }
.btn-primary{ background:linear-gradient(90deg,#4fd1c5,var(--accent)); color:#021023; border-color:rgba(79,209,197,0.12); box-shadow:0 8px 22px rgba(3,15,32,0.12); }
.btn-danger{ background:rgba(255,105,105,0.12); color:#ff8b8b; border-color:rgba(255,139,139,0.28); }
.label{ font-size:.8rem; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; display:block; margin-bottom:.35rem; }
.error{ display:block; color:#ff8b8b; font-size:.8rem; margin-top:.3rem; }
</style>

<script>
(function(){
  const copyBtn = document.getElementById('share-copy');
  const input = document.getElementById('share-link');
  if(!copyBtn || !input) return;
  copyBtn.addEventListener('click', ()=>{
    input.select();
    if(navigator.clipboard){
      navigator.clipboard.writeText(input.value).then(()=>{
        copyBtn.innerText = 'Copiado!';
        setTimeout(()=> copyBtn.innerText = 'Copiar link', 2000);
      }).catch(()=>{
        document.execCommand('copy');
        copyBtn.innerText = 'Copiado!';
        setTimeout(()=> copyBtn.innerText = 'Copiar link', 2000);
      });
    } else {
      document.execCommand('copy');
      copyBtn.innerText = 'Copiado!';
      setTimeout(()=> copyBtn.innerText = 'Copiar link', 2000);
    }
  });
})();
</script>
{% endblock %}
