{% extends "base.html" %}
{% block title %}Assistente IA - ARPIA{% endblock %}

{% block content %}
<section class="ai-panel">
  <header class="ai-header">
    <h1>Assistente inteligente</h1>
    <p class="muted">Selecione um projeto e faca perguntas para receber recomendacoes rapidas a partir dos dados coletados.</p>
  </header>

  <div class="ai-layout">
    <aside class="ai-sidebar">
      <section class="ai-provider-card">
        <h2>Provedor de IA</h2>
        <div id="ai-provider-status" class="muted">Carregando status...</div>
        <form id="ai-credential-form" class="ai-credential-form">
          {% csrf_token %}
          <label for="openai-api-key">Chave OpenAI</label>
          <input type="password" id="openai-api-key" name="api_key" placeholder="sk-..." autocomplete="off" />
          <button type="submit" class="btn-secondary">Salvar chave</button>
        </form>
        <p id="ai-provider-feedback" class="ai-feedback hidden"></p>
      </section>

      <section class="ai-sidebar-section">
        <h2>Projetos</h2>
        <ul class="ai-project-list">
          {% for project in projects %}
            <li class="ai-project-item {% if selected_project and project.id == selected_project.id %}is-active{% endif %}">
              <a href="?project={{ project.id }}">{{ project.name }}</a>
            </li>
          {% empty %}
            <li class="muted">Nenhum projeto disponivel.</li>
          {% endfor %}
        </ul>
      </section>

      <section class="ai-sidebar-section">
        <h2>Historico de chats</h2>
        <ul class="ai-history-list">
          {% for session in chat_history %}
            <li>
              <span class="ai-history-title">{{ session.title }}</span>
              <span class="ai-history-meta">{{ session.provider }} · {{ session.created_at|date:"d/m H:i" }}</span>
            </li>
          {% empty %}
            <li class="muted">Sem conversas registradas ainda.</li>
          {% endfor %}
        </ul>
      </section>
    </aside>

    <main class="ai-conversation" id="ai-main" data-project-id="{{ selected_project.id|default:"" }}">
      {% if selected_project %}
        <section class="ai-chat-feed" id="ai-chat-feed">
          <div class="ai-chat-placeholder" id="ai-chat-placeholder">
            <h2>Pronto para ajudar</h2>
            <p class="muted">Pergunte sobre vulnerabilidades, exploracao controlada ou planos de mitigacao.</p>
          </div>
        </section>

        <form id="ai-form" class="ai-chat-form">
          {% csrf_token %}
          <div class="ai-input-shell">
            <textarea id="ai-question" name="question" rows="1" placeholder="Envie uma pergunta ao ARPIA IA..." ></textarea>
            <button type="submit" class="btn-primary" aria-label="Enviar pergunta">
              Enviar
            </button>
          </div>
          <p class="ai-chat-hint">Os dados sao sanitizados para a demo. Evite inserir informacoes sensiveis.</p>
        </form>
      {% else %}
        <div class="ai-empty-state">
          <h2>Selecione um projeto para comecar</h2>
          <p class="muted">Escolha um projeto na coluna esquerda para liberar o assistente.</p>
        </div>
      {% endif %}
    </main>

    <aside class="ai-insights">
      {% if selected_project %}
        <h2>Insights do projeto</h2>
        <details class="ai-accordion" open>
          <summary>Resumo principal</summary>
          <dl>
            <dt>Nome</dt>
            <dd>{{ project_context.project.name }}</dd>
            <dt>Cliente</dt>
            <dd>{{ project_context.project.client|default:"-" }}</dd>
            <dt>Descricao</dt>
            <dd>{{ project_context.project.description|default:"-" }}</dd>
          </dl>
        </details>

        <details class="ai-accordion">
          <summary>Vulnerabilidades recentes</summary>
          <ul class="ai-accordion-list">
            {% for finding in project_context.vulnerability_findings %}
              <li>
                <strong>{{ finding.cve|default:"Sem CVE" }}</strong>
                <span class="badge">{{ finding.severity|upper }}</span>
                <div>{{ finding.summary }}</div>
              </li>
            {% empty %}
              <li class="muted">Nenhuma vulnerabilidade registrada.</li>
            {% endfor %}
          </ul>
        </details>

        <details class="ai-accordion">
          <summary>Scripts sugeridos</summary>
          <ul class="ai-accordion-list">
            {% for script in project_context.available_scripts %}
              <li>
                <strong>{{ script.name }}</strong>
                {% if script.requires_tool %}<span class="badge">Requer ferramenta</span>{% endif %}
                <div>{{ script.description }}</div>
              </li>
            {% empty %}
              <li class="muted">Nenhum script cadastrado.</li>
            {% endfor %}
          </ul>
        </details>
      {% else %}
        <div class="ai-insights-empty muted">
          <p>Aguardando selecao de projeto.</p>
        </div>
      {% endif %}
    </aside>
  </div>
</section>

<script>
(function() {
  const form = document.getElementById("ai-form");

  const answerBox = document.getElementById("ai-answer");
  const main = document.getElementById("ai-main");
  const projectId = main?.dataset.projectId || "";
  const providersUrl = "{{ providers_url }}";
  const registerOpenAiUrl = "{{ register_openai_url }}";
  const providerStatus = document.getElementById("ai-provider-status");
  const providerFeedback = document.getElementById("ai-provider-feedback");
  const credentialForm = document.getElementById("ai-credential-form");
  const chatFeed = document.getElementById("ai-chat-feed");
  const chatPlaceholder = document.getElementById("ai-chat-placeholder");

  function appendMessage(role, text) {
    if (!chatFeed) {
      return null;
    }
    const article = document.createElement("article");
    article.className = `ai-message ai-message-${role}`;
    article.textContent = text;
    chatFeed.appendChild(article);
    chatFeed.scrollTop = chatFeed.scrollHeight;
    return article;
  }

  function renderAssistantAnswer(article, payload) {
    if (!article) {
      return;
    }
    article.dataset.role = "assistant";
    article.innerHTML = "";
    const mainContent = document.createElement("p");
    mainContent.textContent = payload.answer;
    article.appendChild(mainContent);

    const metadata = payload.metadata || {};
    if (metadata.status && metadata.status !== "ok") {
      const note = document.createElement("p");
      note.className = "ai-message-note";
      note.textContent = metadata.message || "Resumo interno exibido devido a erro no provedor.";

      if (metadata.detail === "openai-quota-exceeded") {
        note.textContent += " Verifique o limite de creditos/quota no painel OpenAI.";
      }

      article.appendChild(note);
    }

    if (chatFeed) {
      chatFeed.scrollTop = chatFeed.scrollHeight;
    }
  }

  function renderAssistantError(article, message) {
    if (!article) {
      return;
    }
    article.classList.add("ai-message-error");
    article.textContent = message;
    if (chatFeed) {
      chatFeed.scrollTop = chatFeed.scrollHeight;
    }
  }

  async function readErrorMessage(response) {
    try {
      const payload = await response.json();
      if (payload && typeof payload === "object") {
        return payload.error || payload.message || "Nao foi possivel obter resposta.";
      }
    } catch (parseError) {
      try {
        const text = await response.text();
        if (text.trim()) {
          return text.trim();
        }
      } catch (_) {
        /* ignore */
      }
    }
    return `Nao foi possivel obter resposta (HTTP ${response.status}).`;
  }

  if (form) {
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!projectId) {
        alert("Selecione um projeto antes de enviar perguntas.");
        return;
      }

      const questionField = document.getElementById("ai-question");
      const question = questionField.value.trim();
      if (!question) {
        alert("Digite uma pergunta.");
        return;
      }

      const formData = new FormData(form);
      formData.append("project_id", projectId);

      if (chatPlaceholder) {
        chatPlaceholder.classList.add("hidden");
      }

      appendMessage("user", question);
      const pendingAnswer = appendMessage("assistant", "Gerando resposta...");

      try {
        const response = await fetch("{{ assist_url }}", {
          method: "POST",
          headers: {
            "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value,
          },
          body: formData,
        });

        if (!response.ok) {
          const message = await readErrorMessage(response);
          renderAssistantError(pendingAnswer, message);
          questionField.focus();
          return;
        }

        const payload = await response.json();
        renderAssistantAnswer(pendingAnswer, payload);
        questionField.value = "";
        questionField.focus();
      } catch (error) {
        renderAssistantError(pendingAnswer, "Erro inesperado ao consultar o assistente.");
        questionField.focus();
      }
    });
  }

  async function refreshProviderStatus() {
    if (!providerStatus) return;

    try {
      const response = await fetch(providersUrl, { method: "GET" });
      if (!response.ok) {
        providerStatus.textContent = "Nao foi possivel carregar o status do provedor.";
        return;
      }

      const payload = await response.json();
      const providers = payload.providers || [];
      const openai = providers.find((item) => item.slug === "openai");

      if (!openai) {
        providerStatus.textContent = "Provedor OpenAI nao encontrado.";
        return;
      }

      if (openai.has_credentials && openai.credential) {
        const validation = openai.credential.validation || null;
        let statusText = `Chave cadastrada (${openai.credential.masked_api_key})`;
        if (validation) {
          if (validation.status === "ok") {
            statusText += " · validacao OK";
          } else if (validation.status === "skipped") {
            statusText += " · validacao desativada";
          } else if (validation.message) {
            statusText += ` · ${validation.message}`;
          }
        }

        providerStatus.textContent = statusText;
      } else {
        providerStatus.textContent = "Nenhuma chave cadastrada ainda.";
      }
    } catch (error) {
      providerStatus.textContent = "Erro ao consultar provedores.";
    }
  }

  if (credentialForm) {
    credentialForm.addEventListener("submit", async (event) => {
      event.preventDefault();

      const apiKeyField = credentialForm.querySelector("#openai-api-key");
      const csrfToken = credentialForm.querySelector('[name=csrfmiddlewaretoken]').value;
      const apiKey = apiKeyField.value.trim();

      if (!apiKey) {
        providerFeedback.classList.remove("hidden");
        providerFeedback.textContent = "Informe uma chave de API.";
        return;
      }

      providerFeedback.classList.remove("hidden");
      providerFeedback.textContent = "Salvando...";

      try {
        const formData = new FormData(credentialForm);
        const response = await fetch(registerOpenAiUrl, {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken },
          body: formData,
        });

        if (!response.ok) {
          const payload = await response.json();
          providerFeedback.textContent = payload.error || "Nao foi possivel salvar a chave.";
          return;
        }

        const payload = await response.json();
        const credentialPayload = payload.credential || {};
        const validation = credentialPayload.validation || null;

        if (validation) {
          if (validation.status === "ok") {
            providerFeedback.textContent = validation.message || "Chave registrada com sucesso.";
          } else if (validation.status === "skipped") {
            providerFeedback.textContent = "Chave salva. Validacao desativada neste ambiente (defina ARPIA_AI_VALIDATE_PROVIDER_KEYS=true para validar).";
          } else {
            providerFeedback.textContent = validation.message || "Chave salva, mas a validacao falhou.";
          }
        } else {
          providerFeedback.textContent = "Chave registrada com sucesso.";
        }

        apiKeyField.value = "";
        refreshProviderStatus();
      } catch (error) {
        providerFeedback.textContent = "Erro ao salvar a chave.";
      }
    });
  }

  refreshProviderStatus();
})();
</script>

<style>
.ai-panel { display: flex; flex-direction: column; gap: 1.5rem; }
.ai-header h1 { margin: 0; }
.ai-layout {
  display: grid;
  grid-template-columns: 280px minmax(0, 1fr) 320px;
  gap: 1.5rem;
  align-items: start;
}
.ai-sidebar {
  background: rgba(8, 23, 43, 0.78);
  border-radius: 16px;
  padding: 1.2rem;
  display: flex;
  flex-direction: column;
  gap: 1.2rem;
  max-height: calc(100vh - 220px);
  overflow-y: auto;
}
.ai-sidebar h2 { margin: 0 0 0.6rem 0; }
.ai-sidebar-section { display: flex; flex-direction: column; gap: 0.8rem; }
.ai-provider-card {
  background: rgba(255, 255, 255, 0.04);
  border-radius: 12px;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}
.ai-provider-card form { display: flex; flex-direction: column; gap: 0.6rem; }
.ai-provider-card input {
  border-radius: 8px;
  padding: 0.6rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(0, 0, 0, 0.2);
  color: inherit;
}
.ai-provider-card .btn-secondary { align-self: flex-start; }
.ai-feedback { font-size: 0.85rem; color: rgba(180, 220, 255, 0.85); margin: 0; }
.ai-project-list,
.ai-history-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 0.6rem;
}
.ai-project-item a {
  display: block;
  padding: 0.6rem 0.8rem;
  border-radius: 10px;
  text-decoration: none;
  color: inherit;
  background: rgba(255, 255, 255, 0.05);
}
.ai-project-item.is-active a { background: rgba(127, 181, 255, 0.2); }
.ai-history-list li {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
  padding: 0.5rem 0.7rem;
  display: flex;
  flex-direction: column;
  gap: 0.2rem;
}
.ai-history-title { font-weight: 600; }
.ai-history-meta { font-size: 0.75rem; opacity: 0.75; }

.ai-conversation {
  background: rgba(8, 23, 43, 0.78);
  border-radius: 16px;
  padding: 1.2rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  min-height: 520px;
}
.ai-empty-state {
  margin: auto;
  text-align: center;
  max-width: 320px;
}
.ai-chat-feed {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  border-radius: 14px;
  background: rgba(0, 0, 0, 0.25);
  display: flex;
  flex-direction: column;
  gap: 1rem;
}
.ai-chat-placeholder h2 { margin: 0; }
.ai-chat-placeholder { text-align: center; opacity: 0.8; }
.ai-message {
  border-radius: 12px;
  padding: 0.9rem 1rem;
  white-space: pre-wrap;
  line-height: 1.5;
}
.ai-message-user {
  align-self: flex-end;
  background: rgba(127, 181, 255, 0.25);
  border: 1px solid rgba(127, 181, 255, 0.35);
}
.ai-message-assistant {
  align-self: flex-start;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.08);
}
.ai-message-note {
  margin-top: 0.6rem;
  font-size: 0.85rem;
  opacity: 0.85;
}
.ai-message-error {
  border: 1px solid rgba(255, 102, 102, 0.4);
  background: rgba(255, 102, 102, 0.12);
}
.ai-message.hidden { display: none; }

.ai-chat-form {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  padding: 0.8rem;
  border-radius: 14px;
  background: rgba(0, 0, 0, 0.2);
}
.ai-input-shell {
  display: flex;
  gap: 0.6rem;
  align-items: flex-end;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 12px;
  padding: 0.75rem 0.85rem;
}
.ai-input-shell textarea {
  flex: 1;
  background: transparent;
  border: none;
  color: inherit;
  resize: vertical;
  min-height: 38px;
  max-height: 140px;
}
.ai-input-shell textarea:focus { outline: none; }
.ai-chat-form .btn-primary { padding: 0.55rem 1.2rem; }
.ai-chat-hint { margin: 0; font-size: 0.8rem; opacity: 0.7; }

.ai-insights {
  background: rgba(8, 23, 43, 0.78);
  border-radius: 16px;
  padding: 1.2rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  max-height: calc(100vh - 220px);
  overflow-y: auto;
}
.ai-accordion {
  background: rgba(0, 0, 0, 0.25);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 12px;
  padding: 0.85rem 1rem;
}
.ai-accordion summary {
  cursor: pointer;
  font-weight: 600;
  list-style: none;
}
.ai-accordion summary::after {
  content: "▾";
  float: right;
  transition: transform 0.2s ease;
}
.ai-accordion[open] summary::after {
  transform: rotate(180deg);
}
.ai-accordion summary::-webkit-details-marker { display: none; }
.ai-accordion[open] summary { margin-bottom: 0.65rem; }
.ai-accordion-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}
.ai-accordion-list li {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
  padding: 0.8rem 0.9rem;
}
.ai-accordion .badge {
  margin-left: 0.5rem;
  font-size: 0.7rem;
  text-transform: uppercase;
  background: rgba(127, 181, 255, 0.3);
  padding: 0.1rem 0.45rem;
  border-radius: 12px;
}
.ai-insights-empty {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  padding: 1rem;
}

.hidden { display: none; }

@media (max-width: 1200px) {
  .ai-layout { grid-template-columns: 240px 1fr; }
  .ai-insights { display: none; }
}

@media (max-width: 900px) {
  .ai-layout {
    grid-template-columns: 1fr;
  }
  .ai-sidebar,
  .ai-conversation,
  .ai-insights {
    max-height: none;
  }
  .ai-sidebar { order: 1; }
  .ai-conversation { order: 2; }
}
</style>
{% endblock %}
