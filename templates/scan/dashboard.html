{% extends "base.html" %}
{% block title %}Scan ‚Äî ARPIA{% endblock %}

{% block content %}
<section class="page-heading">
  <div>
    <h1>Orquestra√ß√£o de scans</h1>
    <p class="page-subtitle">Selecione um projeto para configurar conectividade, discovery r√°pido e perfis avan√ßados.</p>
  </div>
  {% if has_project %}
    <div class="active-project">
      <span class="label">Projeto ativo</span>
      <strong>{{ selected_project.name }}</strong>
      {% if selected_project.client_name %}
        <span class="muted">{{ selected_project.client_name }}</span>
      {% endif %}
    </div>
  {% endif %}
</section>

<template id="panel-macros">
  {% if macro_entries %}
    <ul class="macro-list">
      {% for macro in macro_entries %}
        <li>
          <span class="macro-key">{{ macro.key }}</span>
          {% if macro.is_pre %}
            <pre>{{ macro.value }}</pre>
          {% else %}
            <span class="macro-value">{{ macro.value|default:"‚Äî" }}</span>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="empty">
      <p>Selecione um projeto para visualizar hosts, redes, ferramentas e wordlists dispon√≠veis.</p>
    </div>
  {% endif %}
</template>

<template id="panel-sessions">
  {% if recent_sessions %}
    <table class="sessions-table">
      <thead>
        <tr>
          <th>T√≠tulo</th>
          <th>Status</th>
          <th>Iniciada</th>
          <th>Respons√°vel</th>
        </tr>
      </thead>
      <tbody>
        {% for session in recent_sessions %}
          <tr>
            <td>
              <a href="{% url 'arpia_scan:session_detail' session.id %}">{{ session.title }}</a>
              <span class="ref">#{{ session.reference }}</span>
            </td>
            <td>
              <span class="status status-{{ session.status }}">{{ session.get_status_display }}</span>
            </td>
            <td>{{ session.started_at|default:session.created_at|date:"Y-m-d H:i" }}</td>
            <td>{{ session.owner.get_username }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% elif has_project %}
    <div class="empty">
      <p>Nenhuma sess√£o registrada ainda para este projeto. Inicie um fluxo para gerar hist√≥rico.</p>
    </div>
  {% else %}
    <div class="empty">
      <p>Selecione um projeto para visualizar o hist√≥rico.</p>
    </div>
  {% endif %}
</template>

<template id="panel-reports">
  <div class="reports-placeholder">
    <p class="muted">Resumo r√°pido dos relat√≥rios ser√° exibido aqui.</p>
    <p>Voc√™ pode gerar relat√≥rios completos acessando a se√ß√£o dedicada.</p>
    <a class="btn-secondary" href="{% url 'arpia_report:report_home' %}">Abrir relat√≥rios</a>
  </div>
</template>

{{ action_cards|json_script:"action-cards-data" }}

<section class="scan-shell" data-project-selected="{{ has_project|yesno:'true,false' }}">
  <div class="left-column">
    <article class="panel projects-panel">
      <header class="panel-header">
        <div>
          <h2>Projetos</h2>
          <p class="muted">Voc√™ tem acesso a {{ projects|length }} projeto(s).</p>
        </div>
        {% if projects %}
          <a class="see-all" href="{% url 'projects_list' %}">Ver todos</a>
        {% endif %}
      </header>
      {% if projects %}
        <div class="projects-scroll">
          <ul class="project-items">
            {% for project in projects %}
              <li class="project-item {% if project.id|stringformat:'s' == selected_project_id %}is-active{% endif %}">
                <a href="?project={{ project.id }}" class="project-card" aria-current="{% if project.id|stringformat:'s' == selected_project_id %}page{% else %}false{% endif %}">
                  <div class="project-card-body">
                    <h3>{{ project.name }}</h3>
                    {% if project.description %}<p class="description">{{ project.description }}</p>{% endif %}
                    {% if project.client_name %}<span class="client">{{ project.client_name }}</span>{% endif %}
                  </div>
                  <span class="project-chevron" aria-hidden="true">‚Üí</span>
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% else %}
        <div class="empty">
          <p>Nenhum projeto dispon√≠vel. Crie um projeto para habilitar os fluxos de scan.</p>
        </div>
      {% endif %}
    </article>

    <article class="panel actions-panel" data-project-id="{{ selected_project_id }}">
      <header class="panel-header">
        <div>
          <h2>A√ß√µes</h2>
          <p class="muted">Escolha uma op√ß√£o para visualizar detalhes.</p>
        </div>
      </header>
      <div class="actions-pill-list">
        <button type="button" class="action-pill" data-panel="flow" {% if not has_project %}disabled{% endif %}>
          <span>Fluxo de Scan</span>
        </button>
        <button type="button" class="action-pill" data-panel="macros" {% if not has_project %}disabled{% endif %}>
          <span>Macros</span>
        </button>
        <button type="button" class="action-pill" data-panel="sessions" {% if not has_project %}disabled{% endif %}>
          <span>Sess√µes recentes</span>
        </button>
        <button type="button" class="action-pill" data-panel="reports" {% if not has_project %}disabled{% endif %}>
          <span>Relat√≥rios</span>
        </button>
      </div>
    </article>
  </div>

  <div class="right-column">
    <article class="panel action-view-panel">
      <header class="panel-header">
        <div>
          <h2 id="content-title">Painel de a√ß√µes</h2>
          <p class="muted" id="content-subtitle">Selecione um bot√£o √† esquerda para carregar o conte√∫do.</p>
        </div>
      </header>
      <div class="content-body">
        <div id="scan-feedback" class="scan-feedback hidden" role="status">
          <span class="icon" aria-hidden="true">‚è≥</span>
          <div>
            <strong id="scan-feedback-title">Preparando execu√ß√£o‚Ä¶</strong>
            <p id="scan-feedback-body">Aguarde enquanto iniciamos o fluxo escolhido.</p>
          </div>
        </div>
        <div class="action-view" id="action-view">
          <div class="empty">Escolha uma das op√ß√µes (Fluxo de Scan, Macros, Sess√µes recentes ou Relat√≥rios) para come√ßar.</div>
        </div>
      </div>
    </article>
  </div>
</section>

<style>
.page-heading{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:1.6rem;gap:1rem;}
.page-heading h1{margin:0;font-size:1.9rem;color:var(--text);} 
.active-project{display:flex;flex-direction:column;gap:.25rem;background:rgba(255,255,255,0.02);padding:.8rem 1rem;border-radius:10px;border:1px solid rgba(255,255,255,0.06);min-width:220px;}
.active-project .label{font-size:.78rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);} 
.scan-shell{display:grid;grid-template-columns:minmax(384px,432px) 1fr;gap:1.6rem;align-items:start;}
.left-column{display:flex;flex-direction:column;gap:1.6rem;}
.right-column{display:flex;flex-direction:column;gap:1.6rem;}
.panel{background:rgba(8,23,43,0.78);border-radius:16px;padding:1.4rem;border:1px solid rgba(255,255,255,0.05);box-shadow:0 18px 38px rgba(5,16,32,0.35);position:relative;overflow:hidden;}
.panel-header{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;margin-bottom:1.2rem;}
.panel-header h2{margin:0;color:var(--text);font-size:1.35rem;}
.muted{color:var(--muted);} 
.see-all{color:var(--muted);font-size:.78rem;text-transform:uppercase;letter-spacing:.08em;}
.projects-panel{display:flex;flex-direction:column;max-height:22rem;}
.projects-panel .panel-header{margin-bottom:.9rem;}
.projects-scroll{flex:1;min-height:0;overflow:auto;padding-right:.4rem;}
.project-items{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.9rem;}
.project-item{position:relative;transition:.2s ease;}
.project-card{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;padding:1.05rem 1.2rem;border-radius:14px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);text-decoration:none;color:inherit;transition:.2s ease;}
.project-card:hover{border-color:rgba(127,181,255,0.25);box-shadow:0 0 0 1px rgba(127,181,255,0.15);} 
.project-item.is-active .project-card{border-color:rgba(127,181,255,0.6);box-shadow:0 0 0 2px rgba(127,181,255,0.2);background:rgba(127,181,255,0.08);} 
.project-card-body{display:flex;flex-direction:column;gap:.4rem;}
.project-card h3{margin:0;font-size:1.05rem;color:var(--text);} 
.project-card .description{margin:0;color:var(--muted);font-size:.85rem;}
.project-card .client{display:inline-flex;align-items:center;gap:.35rem;margin-top:.2rem;padding:.2rem .6rem;border-radius:999px;background:rgba(127,181,255,0.15);color:#cfe4ff;font-size:.72rem;text-transform:uppercase;letter-spacing:.08em;}
.project-chevron{display:inline-flex;align-items:center;justify-content:center;min-width:1.75rem;height:1.75rem;border-radius:999px;background:rgba(255,255,255,0.06);color:rgba(230,241,255,0.7);font-size:1.1rem;transition:.2s ease;}
.project-card:hover .project-chevron{background:rgba(127,181,255,0.2);color:#e8f2ff;transform:translateX(2px);} 
.actions-pill-list{display:flex;flex-direction:column;gap:.9rem;}
.action-pill{display:flex;align-items:center;justify-content:space-between;gap:.6rem;padding:.85rem 1.1rem;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--text);font-weight:600;cursor:pointer;transition:.2s ease;text-align:left;}
.action-pill:hover:not(:disabled){border-color:rgba(127,181,255,0.35);box-shadow:0 0 0 1px rgba(127,181,255,0.2);}
.action-pill.is-active{border-color:rgba(127,181,255,0.6);box-shadow:0 0 0 2px rgba(127,181,255,0.25);background:rgba(127,181,255,0.08);}
.action-pill:disabled{opacity:.55;cursor:not-allowed;}
.action-view-panel{min-height:672px;display:flex;flex-direction:column;}
.content-body{display:flex;flex-direction:column;gap:1rem;}
.action-view{padding:1rem;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);flex:1;overflow:visible;min-height:448px;}
.scan-feedback{display:flex;align-items:center;gap:.75rem;padding:.9rem 1rem;margin-bottom:1rem;border-radius:12px;background:rgba(76,148,255,0.12);border:1px solid rgba(76,148,255,0.25);color:#cfe4ff;}
.action-preview{display:flex;flex-direction:column;gap:1.2rem;}
.preview-header{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;}
.preview-header h3{margin:.15rem 0 0;color:var(--text);font-size:1.25rem;}
.preview-kicker{display:inline-flex;align-items:center;gap:.4rem;font-size:.75rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);}
.preview-description{margin:.45rem 0 0;color:var(--muted);font-size:.9rem;max-width:32rem;}
.preview-steps{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.9rem;}
.preview-step{padding:1rem 1.1rem;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:.55rem;}
.step-head{display:flex;align-items:center;justify-content:space-between;gap:.8rem;}
.step-name{font-weight:600;color:var(--text);}
.step-kind{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;}
.progress-track{width:100%;height:.55rem;border-radius:999px;background:rgba(255,255,255,0.08);overflow:hidden;}
.progress-bar{display:block;height:100%;border-radius:999px;background:linear-gradient(90deg,#7fb5ff,#52d2ff);} 
.preview-metadata{display:flex;align-items:center;gap:.6rem;font-size:.8rem;color:var(--muted);}
.preview-metadata span{display:inline-flex;align-items:center;gap:.35rem;}
.preview-metadata .dot{width:.4rem;height:.4rem;border-radius:50%;background:#7fb5ff;display:inline-block;}
.preview-execute{margin-left:auto;}
.scan-feedback.hidden{display:none;}
.scan-feedback .icon{font-size:1.4rem;}
.scan-feedback.tone-success{background:rgba(118,221,174,0.18);border-color:rgba(118,221,174,0.35);color:#d8f6e9;}
.scan-feedback.tone-error{background:rgba(255,132,132,0.16);border-color:rgba(255,132,132,0.35);color:#ffd9d9;}
.flow-list{display:flex;flex-direction:column;gap:1.1rem;}
.flow-card{display:flex;flex-direction:column;gap:1rem;padding:1.1rem 1.2rem;border-radius:14px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 24px rgba(5,16,32,0.22);transition:.2s ease;width:100%;}
.flow-card header{display:flex;align-items:flex-start;justify-content:space-between;gap:.9rem;}
.flow-card h3{margin:0;font-size:1.15rem;color:var(--text);} 
.flow-card p{margin:.45rem 0 0;color:var(--muted);font-size:.9rem;}
.flow-card .flow-meta{margin:.25rem 0 0;font-size:.8rem;color:var(--muted);}
.flow-card .flow-meta code{background:rgba(0,0,0,0.35);padding:.05rem .35rem;border-radius:6px;color:inherit;}
.flow-card .badge{align-self:flex-start;padding:.3rem .6rem;border-radius:999px;background:rgba(127,181,255,0.18);color:#bedeff;font-size:.75rem;text-transform:uppercase;letter-spacing:.08em;}
.flow-card .flow-steps{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.75rem;}
.flow-card .flow-step{display:flex;align-items:stretch;gap:.75rem;padding:.75rem .9rem;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);transition:.2s ease;}
.flow-card .flow-step-connectivity{background:rgba(118,221,174,0.12);border-color:rgba(118,221,174,0.32);}
.flow-card .flow-step-connectivity:hover{border-color:rgba(118,221,174,0.45);box-shadow:0 4px 16px rgba(118,221,174,0.18);} 
.flow-card .flow-step:hover{border-color:rgba(127,181,255,0.38);box-shadow:0 4px 16px rgba(127,181,255,0.16);} 
.flow-step-index{display:flex;align-items:center;justify-content:center;width:2rem;height:2rem;border-radius:50%;background:rgba(127,181,255,0.22);color:#dceeff;font-weight:700;font-size:.95rem;flex:0 0 auto;}
.flow-step-connectivity .flow-step-index{background:rgba(118,221,174,0.38);color:#06241a;}
.flow-step-body{display:flex;flex-direction:column;gap:.55rem;width:100%;}
.flow-step-head{display:flex;align-items:flex-start;justify-content:space-between;gap:.8rem;}
.flow-step-name{font-weight:600;color:var(--text);} 
.step-tag{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .6rem;border-radius:999px;background:rgba(127,181,255,0.18);color:#cfe4ff;font-size:.72rem;text-transform:uppercase;letter-spacing:.08em;}
.flow-step-connectivity .step-tag{background:rgba(118,221,174,0.28);color:#06241a;}
.flow-warnings{background:rgba(255,204,128,0.12);border:1px solid rgba(255,204,128,0.25);color:#f6d3a0;border-radius:12px;padding:.6rem .8rem;display:flex;flex-direction:column;gap:.3rem;font-size:.82rem;margin-top:.6rem;}
.flow-warnings code{background:rgba(0,0,0,0.3);padding:.1rem .35rem;border-radius:6px;color:inherit;}
.flow-card .flow-trigger,
.preview-execute{display:inline-flex;align-items:center;gap:.45rem;padding:.65rem 1.3rem;border-radius:999px;background:linear-gradient(135deg,rgba(123,195,255,0.95),rgba(82,210,255,0.95));border:1px solid rgba(123,195,255,0.45);color:#041022;font-weight:700;letter-spacing:.03em;text-transform:uppercase;box-shadow:0 10px 22px rgba(30,120,190,0.32);transition:transform .18s ease,box-shadow .18s ease,filter .18s ease;}
.flow-card .flow-trigger:hover,
.preview-execute:hover{box-shadow:0 16px 32px rgba(30,120,190,0.36);transform:translateY(-1px);filter:brightness(1.05);}
.flow-card .flow-trigger:disabled,
.preview-execute:disabled{opacity:.55;cursor:not-allowed;box-shadow:none;background:rgba(127,181,255,0.3);border-color:rgba(127,181,255,0.28);color:rgba(4,16,34,0.55);filter:none;}
.flow-card .flow-trigger{align-self:flex-start;}
.flow-card.is-disabled{opacity:.45;}
.reports-placeholder{display:flex;flex-direction:column;gap:.8rem;font-size:.92rem;color:var(--muted);}
.reports-placeholder .btn-secondary{align-self:flex-start;}
.macro-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.7rem;}
.macro-list li{display:flex;flex-direction:column;gap:.35rem;background:rgba(255,255,255,0.02);padding:.75rem 1rem;border-radius:10px;border:1px solid rgba(255,255,255,0.03);} 
.macro-key{font-family:"Fira Code",monospace;color:#89d1ff;font-size:.85rem;}
.macro-value{color:var(--text);} 
.macro-list pre{margin:0;background:rgba(0,0,0,0.4);padding:.6rem .8rem;border-radius:8px;white-space:pre-wrap;word-break:break-word;font-family:"Fira Code",monospace;font-size:.78rem;max-width:100%;overflow:auto;}
.sessions-table{width:100%;border-collapse:collapse;font-size:.92rem;}
.sessions-table th,.sessions-table td{padding:.55rem .75rem;border-bottom:1px solid rgba(255,255,255,0.05);text-align:left;}
.sessions-table th{font-weight:600;color:var(--muted);text-transform:uppercase;font-size:.75rem;letter-spacing:.06em;}
.sessions-table td .ref{display:block;font-size:.75rem;color:var(--muted);}
.status{display:inline-flex;align-items:center;gap:.4rem;padding:.2rem .6rem;border-radius:999px;font-size:.75rem;font-weight:600;color:var(--text);background:rgba(255,255,255,0.08);} 
.status-running{background:rgba(123,195,255,0.15);}
.status-completed{background:rgba(118,221,174,0.2);}
.status-failed{background:rgba(255,132,132,0.18);}
.status-planned,.status-ready{background:rgba(255,255,255,0.08);}
.summary{color:var(--muted);font-size:.85rem;}
.empty{padding:1rem;background:rgba(255,255,255,0.02);border-radius:10px;color:var(--muted);text-align:left;}
@media (max-width:1280px){
  .scan-shell{grid-template-columns:1fr;}
}
@media (max-width:1024px){
  .left-column{gap:1.2rem;}
}
@media (max-width:960px){
  .page-heading{flex-direction:column;align-items:flex-start;}
  .active-project{width:100%;}
  .scan-shell{grid-template-columns:1fr;}
}
@media (max-width:720px){
  .flow-step-index{width:1.8rem;height:1.8rem;font-size:.9rem;}
}
</style>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const actionsPanel = document.querySelector(".actions-panel");
  if (!actionsPanel) return;

  const shell = document.querySelector(".scan-shell");
  const hasProject = shell?.dataset.projectSelected === "true";
  const projectId = actionsPanel.dataset.projectId;
  const contentTitle = document.getElementById("content-title");
  const contentSubtitle = document.getElementById("content-subtitle");
  const actionView = document.getElementById("action-view");
  const feedback = document.getElementById("scan-feedback");
  const feedbackTitle = document.getElementById("scan-feedback-title");
  const feedbackBody = document.getElementById("scan-feedback-body");
  const panelButtons = Array.from(actionsPanel.querySelectorAll(".action-pill"));
  const macrosTemplate = document.getElementById("panel-macros");
  const sessionsTemplate = document.getElementById("panel-sessions");
  const reportsTemplate = document.getElementById("panel-reports");
  const actionCardsData = JSON.parse(document.getElementById("action-cards-data")?.textContent || "[]");
  const cardsByKind = new Map(actionCardsData.map(card => [card.kind, card]));

  const createUrl = "{% url 'arpia_scan:api_session_create' %}";
  const startUrlTemplate = "{% url 'arpia_scan:api_session_start' pk='00000000-0000-0000-0000-000000000000' %}";

  const KIND_LABELS = {
    connectivity: "Conectividade",
    discovery_rustscan: "Discovery",
    discovery_nmap: "Nmap",
    script: "Script",
  };

  const TERMINAL_STATUSES = new Set(["completed", "failed", "canceled"]);

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }

  function setFeedback({ title, body, icon = "‚è≥", tone = "info" }) {
    if (!feedback) return;
    feedback.classList.remove("hidden", "tone-success", "tone-error");
    if (tone === "success") feedback.classList.add("tone-success");
    if (tone === "error") feedback.classList.add("tone-error");
    feedback.querySelector(".icon").textContent = icon;
    feedbackTitle.textContent = title;
    feedbackBody.textContent = body;
  }

  function clearFeedback() {
    if (!feedback) return;
    feedback.classList.add("hidden");
  }

  function setFlowButtonsDisabled(state) {
    document.querySelectorAll(".flow-trigger").forEach(btn => {
      btn.disabled = state;
    });
  }

  function injectTemplate(template) {
    if (!actionView) return;
    actionView.innerHTML = "";
    if (!template) {
      actionView.innerHTML = '<div class="empty">Conte√∫do indispon√≠vel.</div>';
      return;
    }
    actionView.appendChild(template.content.cloneNode(true));
  }

  function renderFlowPanel() {
    contentTitle.textContent = "Fluxo de Scan";
    if (!hasProject) {
      contentSubtitle.textContent = "Selecione um projeto para habilitar os fluxos de scan.";
      actionView.innerHTML = '<div class="empty">Selecione um projeto na coluna √† esquerda.</div>';
      return;
    }

    contentSubtitle.textContent = "Escolha um fluxo para executar e acompanhar as etapas.";

    const cardsMarkup = actionCardsData.map(card => {
      const tasks = (card.tasks || []).map((task, index) => {
        const kindKey = task.kind?.startsWith("script") ? "script" : task.kind;
        const kindLabel = KIND_LABELS[kindKey] || "Etapa";
        const stepClasses = ["flow-step"];
        if (task.kind === "connectivity") {
          stepClasses.push("flow-step-connectivity");
        }
        return `
          <li class="${stepClasses.join(" ")}" data-step-index="${index + 1}">
            <div class="flow-step-index">${index + 1}</div>
            <div class="flow-step-body">
              <div class="flow-step-head">
                <span class="flow-step-name">${task.name}</span>
                <span class="step-tag">${kindLabel}</span>
              </div>
              <div class="progress-track"><span class="progress-bar" style="width:0%"></span></div>
            </div>
          </li>
        `;
      }).join("\n");

      const disabledAttr = card.enabled ? "" : "disabled";
      const disabledClass = card.enabled ? "" : " is-disabled";
      const toolInfo = card.required_tool_slug
        ? `<p class="flow-meta">Requer ferramenta <code>${card.required_tool_slug}</code>${card.required_tool_name ? ` ‚Äî ${card.required_tool_name}` : ""}</p>`
        : "";
      const warnings = [];
      if (!hasProject) {
        warnings.push("Selecione um projeto para habilitar este fluxo.");
      }
      if (card.missing_tool && card.required_tool_slug) {
        warnings.push(`Cadastre a ferramenta <code>${card.required_tool_slug}</code> na √°rea de ferramentas.`);
      }
      if (card.kind.startsWith("script:")) {
        warnings.push("Este fluxo depende de um teste de conectividade bem-sucedido antes da execu√ß√£o do script.");
      }
      return `
        <section class="flow-card${disabledClass}" data-kind="${card.kind}">
          <header>
            <div>
              <h3>${card.title}</h3>
              <p>${card.description}</p>
              ${toolInfo}
            </div>
            ${card.badge ? `<span class="badge">${card.badge}</span>` : ""}
          </header>
          <ul class="flow-steps">
            ${tasks}
          </ul>
          ${warnings.length ? `<div class="flow-warnings">${warnings.map(text => `<p>${text}</p>`).join("")}</div>` : ""}
          <button type="button" class="btn-primary flow-trigger" data-kind="${card.kind}" ${disabledAttr}>
            Executar agora
          </button>
        </section>
      `;
    }).join("\n");

    actionView.innerHTML = `<div class="flow-list">${cardsMarkup}</div>`;

    actionView.querySelectorAll(".flow-trigger").forEach(button => {
      button.addEventListener("click", () => {
        const kind = button.dataset.kind;
        triggerFlow(kind, button);
      });
    });
  }

  function renderMacrosPanel() {
    contentTitle.textContent = "Macros do projeto";
    contentSubtitle.textContent = "Ser√£o injetadas nos scripts e ferramentas durante o scan.";
    injectTemplate(macrosTemplate);
    clearFeedback();
  }

  function renderSessionsPanel() {
    contentTitle.textContent = "Sess√µes recentes";
    contentSubtitle.textContent = "Hist√≥rico das √∫ltimas execu√ß√µes para o projeto selecionado.";
    injectTemplate(sessionsTemplate);
    clearFeedback();
  }

  function renderReportsPanel() {
    contentTitle.textContent = "Relat√≥rios";
    contentSubtitle.textContent = "Acompanhe insights e documentos gerados pelos scans.";
    injectTemplate(reportsTemplate);
    clearFeedback();
  }

  async function triggerFlow(kind, button) {
    if (!projectId || !hasProject) {
      setFeedback({
        title: "Selecione um projeto",
        body: "√â necess√°rio escolher um projeto antes de iniciar um fluxo.",
        icon: "‚ÑπÔ∏è",
      });
      return;
    }

    const card = cardsByKind.get(kind);
    if (!card) return;

    setFlowButtonsDisabled(true);
    if (button) button.disabled = true;
    setFeedback({
      title: `Iniciando ${card.title}`,
      body: "Preparando sess√£o e executando tarefas configuradas‚Ä¶",
      icon: "‚öôÔ∏è",
    });

    try {
      const createResponse = await fetch(createUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          project_id: projectId,
          title: `${card.title} ‚Äî ${new Date().toLocaleString("pt-BR")}`,
          tasks: card.tasks,
          trigger_kind: kind,
        }),
      });

      if (!createResponse.ok) {
        const errorPayload = await createResponse.json().catch(() => ({}));
        throw new Error(errorPayload.error || "Falha ao criar sess√£o");
      }

      const sessionData = await createResponse.json();

      setFeedback({
        title: "Execu√ß√£o em andamento",
        body: "Abrindo acompanhamento em tempo real‚Ä¶",
        icon: "üì°",
      });

      const detailUrl = sessionData.detail_url;
      const startUrl = startUrlTemplate.replace("00000000-0000-0000-0000-000000000000", sessionData.id);

      fetch(startUrl, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
        },
        keepalive: true,
      })
        .then(response => {
          if (!response.ok) {
            return response.json().catch(() => ({})).then(errorPayload => {
              console.error("Falha ao iniciar sess√£o", errorPayload.error || response.statusText);
            });
          }
        })
        .catch(error => {
          console.error("Erro ao iniciar sess√£o", error);
        });

      setTimeout(() => {
        window.location.href = detailUrl;
      }, 200);
      return;
    } catch (error) {
      console.error(error);
      setFeedback({
        title: "N√£o foi poss√≠vel iniciar o fluxo",
        body: error.message || "Tente novamente em instantes.",
        icon: "‚ùå",
        tone: "error",
      });
    } finally {
      setFlowButtonsDisabled(false);
      if (button) button.disabled = false;
    }
  }

  function setActivePanel(panelKey) {
    panelButtons.forEach(btn => {
      const isActive = btn.dataset.panel === panelKey;
      btn.classList.toggle("is-active", isActive);
    });

    switch (panelKey) {
      case "flow":
        renderFlowPanel();
        break;
      case "macros":
        renderMacrosPanel();
        break;
      case "sessions":
        renderSessionsPanel();
        break;
      case "reports":
        renderReportsPanel();
        break;
      default:
        actionView.innerHTML = '<div class="empty">Conte√∫do n√£o dispon√≠vel.</div>';
        break;
    }
  }

  panelButtons.forEach(button => {
    button.addEventListener("click", () => {
      if (button.disabled) return;
      setActivePanel(button.dataset.panel);
    });
  });

  if (hasProject && panelButtons.length) {
    setActivePanel("flow");
  }
});
</script>
{% endblock %}
