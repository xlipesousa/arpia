{% extends "base.html" %}
{% block title %}Scan {{ session.title }} — ARPIA{% endblock %}

{% block content %}
<section class="page-heading">
  <div>
    <a href="{% url 'arpia_scan:dashboard' %}?project={{ project.id }}" class="back-link">← Voltar para dashboard de scans</a>
    <h1>{{ session.title }}</h1>
    <p class="page-subtitle">Projeto {{ project.name }} • Referência #{{ session.reference }}</p>
  </div>
  <div class="session-status">
    <span class="label">Status</span>
    <span class="status-pill status-{{ session.status }}" id="session-status-pill">{{ session.get_status_display }}</span>
    <span class="live-indicator {% if session.is_terminal %}hidden{% endif %}" id="live-indicator">Atualizando em tempo real…</span>
    {% if report_url %}
      <a href="{{ report_url }}" class="report-link" target="_blank" rel="noopener noreferrer">Ver relatório provisório</a>
    {% endif %}
  </div>
</section>

<section class="session-report" id="session-root" data-session-id="{{ session.id }}" data-status="{{ session.status }}" data-api-status-url="{% url 'arpia_scan:api_session_status' session.id %}" data-api-logs-url="{{ logs_url }}">
  <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <article class="card execution-card" id="execution-card" data-total-tasks="{{ tasks|length }}">
    <header class="section-header">
      <div>
        <h2>Execução ao vivo</h2>
        <p class="muted">Acompanhe o andamento e a saída das etapas em tempo real.</p>
      </div>
    </header>

    <div class="execution-status">
      <div class="status-beacon status-{{ session.status }}" id="execution-status-beacon">
        <span class="beacon-dot" aria-hidden="true"></span>
        <span class="beacon-label" id="execution-status-label">{{ session.get_status_display }}</span>
      </div>
      <div class="execution-meta">
        <span id="execution-task-label">{% if session.is_terminal %}Sessão finalizada.{% else %}Aguardando atualização…{% endif %}</span>
        <small id="execution-time-indicator">
          {% if session.started_at %}
            Iniciado em {{ session.started_at|date:"d/m/Y H:i" }}
          {% else %}
            Sessão ainda não iniciada.
          {% endif %}
        </small>
      </div>
    </div>

    <div class="execution-progress">
      <div class="progress-bar progress-overall" id="execution-progress-bar" data-progress="{{ overall_progress_percent|default:0 }}">
        <span style="width: {{ overall_progress_percent|default:0 }}%"></span>
      </div>
      <div class="progress-summary">
        <span class="progress-value" id="execution-progress-value">{{ overall_progress_percent|default:0 }}%</span>
        <span class="progress-detail" id="execution-progress-detail">{{ completed_tasks_count|default:0 }} de {{ total_tasks_count|default:0 }} etapas concluídas</span>
      </div>
    </div>

    <div class="execution-console">
      <div class="console-header">
        <span>Saída recente</span>
      </div>
      <div class="console-body" id="console-body">
        <pre id="live-console" class="console-output hidden" aria-live="polite" aria-label="Saída em tempo real"></pre>
        <div class="empty" id="live-console-empty">Nenhuma saída registrada ainda.</div>
      </div>
    </div>
  </article>

  <article class="card session-overview">
    <header class="section-header">
      <h2>Resumo da sessão</h2>
      {% if report_url %}
        <a href="{{ report_url }}" class="btn-secondary" target="_blank" rel="noopener noreferrer">Abrir relatório</a>
      {% endif %}
    </header>
    <div class="session-meta">
      <dl>
        <div>
          <dt>Projeto</dt>
          <dd>{{ project.name }}</dd>
        </div>
        <div>
          <dt>Responsável</dt>
          <dd>{{ session.owner.get_username }}</dd>
        </div>
        <div>
          <dt>Iniciada</dt>
          <dd id="session-started-at" data-empty-text="—">{{ session.started_at|default:session.created_at|date:"d/m/Y H:i" }}</dd>
        </div>
        <div>
          <dt>Finalizada</dt>
          <dd id="session-finished-at" data-empty-text="—">{% if session.finished_at %}{{ session.finished_at|date:"d/m/Y H:i" }}{% else %}<span class="muted">—</span>{% endif %}</dd>
        </div>
        <div class="notes">
          <dt>Notas</dt>
          <dd id="session-notes" data-empty-text="Nenhuma anotação.">{{ session.notes|default:"Nenhuma anotação." }}</dd>
        </div>
      </dl>
    </div>
  </article>

  <article class="card metrics-card">
    <header class="section-header">
      <h2>Resumo executivo</h2>
      <p class="muted">Panorama consolidado com base no snapshot da sessão.</p>
    </header>
    <div class="metrics-grid" id="metrics-grid" data-empty-text="Nenhuma métrica disponível até o momento.">
      {% for metric in overview_metrics %}
        <div class="metric-card">
          <span class="metric-value">{{ metric.value|default:"—" }}</span>
          <span class="metric-label">{{ metric.label }}</span>
          {% if metric.note %}<span class="metric-note">{{ metric.note }}</span>{% endif %}
        </div>
      {% endfor %}
    </div>
    <ul class="insights-list{% if not report_insights %} hidden{% endif %}" id="insights-list" data-empty-text="Nenhum insight registrado.">
      {% for insight in report_insights %}
        <li class="insight insight-{{ insight.level|default:'info' }}">{{ insight.message }}</li>
      {% endfor %}
    </ul>
  <div class="empty{% if report_insights %} hidden{% endif %}" id="insights-empty" data-empty-text="Nenhum insight registrado.">Nenhum insight registrado.</div>
  </article>

  <article class="card connectivity-card" data-empty-text="Nenhum dado de conectividade registrado.">
    <header class="section-header">
      <div>
        <h2>Resumo de conectividade</h2>
        <p class="muted">Resultados interpretados a partir da etapa "Teste de conectividade".</p>
      </div>
      <div class="section-actions">
        <a href="{% url 'arpia_scan:session_targets_export_csv' session.id %}" class="btn-secondary" target="_blank" rel="noopener noreferrer">Exportar CSV</a>
        <a href="{% url 'arpia_scan:session_targets_export_json' session.id %}" class="btn-secondary" target="_blank" rel="noopener noreferrer">Exportar JSON</a>
      </div>
    </header>
    <div class="connectivity-totals" id="connectivity-totals">
      <div>
        <span class="counter">{{ connectivity_overview.totals.reachable }}</span>
        <span class="label">Hosts alcançados</span>
      </div>
      <div>
        <span class="counter">{{ connectivity_overview.totals.unreachable }}</span>
        <span class="label">Hosts sem resposta</span>
      </div>
      <div>
        <span class="counter">{{ connectivity_overview.totals.checked_ports }}</span>
        <span class="label">Portas verificadas</span>
      </div>
    </div>

    <div class="connectivity-hosts" id="connectivity-hosts">
      {% for host in connectivity_overview.hosts %}
        <article class="connectivity-host {% if host.reachable %}reachable{% else %}unreachable{% endif %}">
          <header>
            <div>
              <h3>{{ host.host }}</h3>
              <span class="status-chip {% if host.reachable %}status-open{% else %}status-closed{% endif %}">
                {% if host.reachable %}Alcançado{% else %}Sem resposta{% endif %}
              </span>
            </div>
            <div class="latency-summary">
              {% if host.latency_avg %}
                <span>Média {{ host.latency_avg }} ms</span>
                {% if host.latency_min and host.latency_max %}
                  <small class="muted">{{ host.latency_min }} – {{ host.latency_max }} ms</small>
                {% endif %}
              {% else %}
                <span class="muted">Sem métricas de latência</span>
              {% endif %}
            </div>
          </header>

          <table class="connectivity-table">
            <thead>
              <tr>
                <th>Porta</th>
                <th>Status</th>
                <th>Latência</th>
                <th>Observações</th>
              </tr>
            </thead>
            <tbody>
              {% for port in host.open_ports %}
                <tr class="status-open">
                  <td>{{ port.port }}</td>
                  <td><span class="status-chip status-open">Aberta</span></td>
                  <td>{% if port.latency_ms is not None %}{{ port.latency_ms }} ms{% else %}<span class="muted">—</span>{% endif %}</td>
                  <td><span class="muted">—</span></td>
                </tr>
              {% endfor %}
              {% for port in host.closed_ports %}
                <tr class="status-closed">
                  <td>{{ port.port }}</td>
                  <td><span class="status-chip status-closed">Fechada</span></td>
                  <td><span class="muted">—</span></td>
                  <td>{{ port.error|default:"Conexão recusada" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          {% if host.errors %}
            <ul class="host-alerts">
              {% for error in host.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </article>
      {% endfor %}
    </div>
  <div class="empty{% if connectivity_overview.hosts %} hidden{% endif %}" id="connectivity-empty" data-empty-text="Nenhum dado de conectividade registrado.">Nenhum dado de conectividade registrado.</div>
  </article>

  <article class="card timeline-card">
    <header class="section-header">
      <h2>Linha do tempo das etapas</h2>
      <p class="muted">Ordens cronológicas com início, término e duração.</p>
    </header>
    <ol class="timeline{% if not timeline_entries %} hidden{% endif %}" id="timeline-list">
      {% for step in timeline_entries %}
        <li>
          <div class="timeline-item">
            <div class="timeline-title">{{ step.label }}</div>
            <div class="timeline-meta">
              <span class="status-chip status-{{ step.status|default:'pending' }}">{{ step.status_display|default:step.status|default:"—" }}</span>
              <span>Início {{ step.started_at }}</span>
              <span>Término {{ step.finished_at }}</span>
              <span>Duração {{ step.duration }}</span>
            </div>
          </div>
        </li>
      {% endfor %}
    </ol>
  <div class="empty{% if timeline_entries %} hidden{% endif %}" id="timeline-empty" data-empty-text="Nenhuma etapa executada até o momento.">Nenhuma etapa executada até o momento.</div>
  </article>

  <article class="card tasks-card" data-empty-text="Nenhuma etapa registrada para esta sessão.">
    <header class="section-header">
      <h2>Tabela de etapas</h2>
      <p class="muted">Detalhes completos de cada tarefa executada.</p>
    </header>
    <table class="tasks-table" id="tasks-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Etapa</th>
          <th>Ferramenta</th>
          <th>Script</th>
          <th>Status</th>
          <th>Progresso</th>
          <th>Início</th>
          <th>Término</th>
          <th>Saída</th>
        </tr>
      </thead>
      <tbody id="tasks-body">
        {% for task in tasks %}
          <tr data-task-id="{{ task.id }}">
            <td>{{ forloop.counter }}</td>
            <td>
              <strong>{{ task.name }}</strong>
              <span class="muted">{{ task.get_kind_display }}</span>
            </td>
            <td>{{ task.tool|default:"—" }}</td>
            <td>{{ task.script|default:"—" }}</td>
            <td><span class="status-pill status-{{ task.status }}">{{ task.get_status_display }}</span></td>
            <td>
              <div class="progress-bar" data-progress="{{ task.progress_percent }}"><span></span></div>
              <small class="muted">{{ task.progress_percent }}%</small>
            </td>
            <td>{% if task.started_at %}{{ task.started_at|date:"d/m/Y H:i" }}{% else %}<span class="muted">—</span>{% endif %}</td>
            <td>{% if task.finished_at %}{{ task.finished_at|date:"d/m/Y H:i" }}{% else %}<span class="muted">—</span>{% endif %}</td>
            <td class="task-output">
              {% if task.stdout %}
                <details>
                  <summary>Ver saída</summary>
                  <pre>{{ task.stdout }}</pre>
                </details>
              {% else %}
                <span class="muted">Sem saída</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if not tasks %}
      <div class="empty" id="tasks-empty">Nenhuma etapa registrada para esta sessão.</div>
    {% endif %}
  </article>

  <article class="card findings-card" data-empty-text="Nenhum achado documentado.">
    <header class="section-header">
      <h2>Achados documentados</h2>
      <p class="muted">Resumo interpretado das observações registradas.</p>
    </header>
    <ul class="findings-list" id="findings-list">
      {% for item in findings %}
        {% with finding=item.instance payload=item.payload %}
          <li>
            <div class="finding-header">
              <span class="badge kind-{{ finding.kind }}">{{ finding.get_kind_display }}</span>
              {% if finding.severity %}
                <span class="badge severity">{{ finding.severity }}</span>
              {% endif %}
            </div>
            <h3>{{ finding.title }}</h3>
            <p>{{ finding.summary|default:"Sem descrição adicional." }}</p>

            {% if payload.host %}
              <div class="finding-host">
                <span class="status-chip {% if payload.reachable %}status-open{% else %}status-closed{% endif %}">
                  {% if payload.reachable %}Host alcançado{% else %}Host sem resposta{% endif %}
                </span>
                <span class="muted">{{ payload.host }}</span>
              </div>
            {% endif %}

            {% if payload.open_ports %}
              <div class="ports-group">
                <h4>Portas em evidência</h4>
                <ul class="ports-list open">
                  {% for port in payload.open_ports %}
                    <li><strong>{{ port.port }}</strong> <span class="muted">Aberta{% if port.latency_ms %} • {{ port.latency_ms }} ms{% endif %}</span></li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}

            {% if payload.closed_ports %}
              <div class="ports-group">
                <h4>Portas sem resposta</h4>
                <ul class="ports-list closed">
                  {% for port in payload.closed_ports %}
                    <li><strong>{{ port.port }}</strong> <span class="muted">{{ port.error|default:"Conexão recusada" }}</span></li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}

            {% if payload.hosts %}
              <div class="summary-hosts">
                <h4>Hosts mapeados</h4>
                <ul>
                  {% for host in payload.hosts %}
                    <li>{{ host }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}

            {% if item.raw_json %}
              <details class="raw-data">
                <summary>Ver dados brutos</summary>
                <pre>{{ item.raw_json }}</pre>
              </details>
            {% endif %}
          </li>
        {% endwith %}
      {% endfor %}
    </ul>
    {% if not findings %}
      <div class="empty" id="findings-empty">Nenhum achado documentado.</div>
    {% endif %}
  </article>

  <article class="card macros-card">
    <header class="section-header">
      <h2>Macros utilizadas</h2>
      <p class="muted">Valores congelados no início da sessão.</p>
    </header>
    {% if macro_entries %}
      <ul class="macro-list">
        {% for macro in macro_entries %}
          <li>
            <span class="macro-key">{{ macro.key }}</span>
            {% if macro.is_pre %}
              <pre>{{ macro.value }}</pre>
            {% else %}
              <span class="macro-value">{{ macro.value|default:"—" }}</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="empty">Nenhuma macro capturada para esta sessão.</div>
    {% endif %}
  </article>

  <article class="card logs-card" data-empty-text="Nenhum log registrado para esta sessão.">
    <header class="section-header">
      <h2>Eventos e logs</h2>
      <p class="muted">Atualizado em tempo real via arpia_log.</p>
    </header>
    <ul class="logs-list" id="session-logs"></ul>
    <div class="empty" id="logs-empty">Nenhum log registrado para esta sessão.</div>
  </article>
</section>

{{ session_bootstrap|json_script:"session-bootstrap" }}

<style>
.page-heading{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:1.6rem;gap:1rem;}
.page-heading h1{margin:.3rem 0;font-size:1.85rem;color:var(--text);}
.back-link{text-decoration:none;color:var(--muted);font-size:.9rem;}
.back-link:hover{color:var(--text);}
.session-status{display:flex;flex-direction:column;gap:.3rem;align-items:flex-end;}
.session-status .label{font-size:.75rem;text-transform:uppercase;color:var(--muted);letter-spacing:.08em;}
.status-pill{display:inline-flex;align-items:center;padding:.25rem .75rem;border-radius:999px;font-weight:600;font-size:.8rem;color:var(--text);background:rgba(255,255,255,0.08);}
.status-running{background:rgba(123,195,255,0.18);}
.status-completed{background:rgba(118,221,174,0.22);}
.status-failed{background:rgba(255,132,132,0.2);}
.status-planned,.status-ready{background:rgba(255,255,255,0.08);}
.live-indicator{font-size:.82rem;color:#8fc0ff;display:inline-flex;align-items:center;gap:.4rem;}
.live-indicator::before{content:"";display:inline-block;width:.5rem;height:.5rem;border-radius:999px;background:#8fc0ff;animation:pulse 1.5s ease-in-out infinite;}
.live-indicator.hidden{display:none;}
.live-indicator.tone-success{color:#d8f6e9;}
.live-indicator.tone-error{color:#ffd9d9;}
.btn-secondary{display:inline-flex;align-items:center;justify-content:center;padding:.45rem .9rem;border-radius:999px;font-weight:600;font-size:.85rem;background:rgba(76,148,255,0.15);border:1px solid rgba(76,148,255,0.25);color:#8bc5ff;text-decoration:none;transition:.2s ease;}
.btn-secondary:hover{background:rgba(117,187,255,0.25);}

.session-report{display:flex;flex-direction:column;gap:1.6rem;align-items:stretch;}
.card{background:rgba(8,23,43,0.78);border-radius:14px;padding:1.4rem;border:1px solid rgba(255,255,255,0.05);box-shadow:0 18px 38px rgba(5,16,32,0.35);max-width:100%;overflow:hidden;}
.section-header{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;margin-bottom:1.1rem;}
.section-header h2{margin:0;font-size:1.35rem;}
.section-header p{margin:0;max-width:520px;}
.section-actions{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;}
.section-header > .section-actions{margin-left:auto;}

.execution-card{display:flex;flex-direction:column;gap:1.2rem;}
.execution-status{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:1rem;}
.status-beacon{display:inline-flex;align-items:center;gap:.65rem;padding:.55rem 1.1rem;border-radius:999px;font-weight:600;font-size:.9rem;background:rgba(143,192,255,0.22);color:#d3eaff;position:relative;box-shadow:0 0 0 0 rgba(139,197,255,0.4);}
.status-beacon .beacon-dot{width:.8rem;height:.8rem;border-radius:999px;background:#8bc5ff;box-shadow:0 0 0 0 rgba(139,197,255,0.65);animation:beaconPulse 1.8s ease-out infinite;}
.status-beacon.status-running{background:rgba(143,192,255,0.22);color:#d3eaff;}
.status-beacon.status-completed{background:rgba(118,221,174,0.25);color:#d7f7e7;}
.status-beacon.status-completed .beacon-dot{background:#62d3a1;box-shadow:0 0 0 0 rgba(98,211,161,0.6);}
.status-beacon.status-failed,.status-beacon.status-error{background:rgba(255,132,132,0.25);color:#ffd7d7;}
.status-beacon.status-failed .beacon-dot,.status-beacon.status-error .beacon-dot{background:#ff8484;box-shadow:0 0 0 0 rgba(255,132,132,0.55);}
.status-beacon.status-planned,.status-beacon.status-ready,.status-beacon.status-queued,.status-beacon.status-pending{background:rgba(255,255,255,0.12);color:var(--text);}
.status-beacon.status-canceled{background:rgba(255,214,165,0.25);color:#ffe6c9;}
.execution-meta span{font-size:1.05rem;font-weight:600;color:var(--text);display:block;}
.execution-meta small{display:block;margin-top:.25rem;font-size:.82rem;color:var(--muted);}
.execution-progress{display:flex;flex-direction:column;gap:.5rem;}
.progress-overall{height:10px;}
.progress-summary{display:flex;align-items:center;justify-content:space-between;font-size:.85rem;color:var(--muted);}
.progress-summary .progress-value{font-size:1.2rem;font-weight:700;color:#8bc5ff;}
.progress-summary .progress-detail{font-size:.85rem;}
.execution-console{display:flex;flex-direction:column;gap:.6rem;}
.console-header{display:flex;align-items:center;justify-content:space-between;font-size:.85rem;color:var(--muted);}
.console-header span{font-weight:600;color:var(--text);}
.console-body{position:relative;background:rgba(0,0,0,0.42);border-radius:12px;padding:.9rem;max-height:320px;overflow:auto;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.05);}
.console-output{margin:0;white-space:pre-wrap;word-break:break-word;min-height:140px;max-width:100%;font-family:"Fira Code",monospace;font-size:.86rem;line-height:1.45;color:#d5e8ff;}
.console-body::-webkit-scrollbar{width:8px;}
.console-body::-webkit-scrollbar-thumb{background:rgba(139,197,255,0.35);border-radius:10px;}

.hidden{display:none !important;}

.session-overview dl{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin:0;}
.session-overview dt{font-size:.8rem;text-transform:uppercase;color:var(--muted);letter-spacing:.08em;}
.session-overview dd{margin:0;font-size:1rem;color:var(--text);}
.session-overview .notes{grid-column:1/-1;}

.metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;}
.metric-card{background:rgba(255,255,255,0.04);border-radius:12px;padding:1rem 1.1rem;display:flex;flex-direction:column;gap:.35rem;min-height:140px;}
.metric-value{font-size:1.6rem;font-weight:700;color:#8bc5ff;}
.metric-label{font-size:.85rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);}
.metric-note{font-size:.82rem;color:var(--text-muted,#93a0b8);}

.insights-list{list-style:none;margin:1.2rem 0 0;padding:0;display:flex;flex-direction:column;gap:.7rem;}
.insights-list .insight{padding:.75rem 1rem;border-radius:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);}

.connectivity-card{display:flex;flex-direction:column;gap:1.2rem;}
.connectivity-totals{display:flex;gap:1.4rem;flex-wrap:wrap;}
.connectivity-totals .counter{display:block;font-size:1.8rem;font-weight:700;color:#8bc5ff;}
.connectivity-totals .label{font-size:.85rem;color:var(--muted);}
.connectivity-hosts{display:flex;flex-direction:column;gap:1.2rem;}
.connectivity-host{padding:1.1rem 1.2rem;border:1px solid rgba(255,255,255,0.06);border-radius:12px;background:rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:.9rem;}
.connectivity-host header{display:flex;justify-content:space-between;gap:1rem;align-items:flex-start;}
.connectivity-host h3{margin:0;font-size:1.15rem;}
.latency-summary{display:flex;flex-direction:column;align-items:flex-end;gap:.2rem;font-size:.85rem;color:var(--muted);}

.status-chip{display:inline-flex;align-items:center;justify-content:center;padding:.25rem .65rem;border-radius:999px;font-weight:600;font-size:.75rem;text-transform:uppercase;letter-spacing:.06em;}
.status-chip.status-open{background:rgba(118,221,174,0.22);color:#b9f2db;}
.status-chip.status-closed{background:rgba(255,132,132,0.25);color:#ffd1d1;}
.status-chip.status-running{background:rgba(123,195,255,0.2);color:#cfe7ff;}
.status-chip.status-completed{background:rgba(118,221,174,0.25);color:#bff5df;}
.status-chip.status-failed{background:rgba(255,132,132,0.28);color:#ffd7d7;}
.status-chip.status-pending,.status-chip.status-queued{background:rgba(255,255,255,0.08);color:var(--text);}

.connectivity-table{width:100%;border-collapse:collapse;font-size:.9rem;background:rgba(0,0,0,0.35);border-radius:10px;overflow:hidden;}
.connectivity-table th,.connectivity-table td{padding:.55rem .75rem;border-bottom:1px solid rgba(255,255,255,0.08);text-align:left;}
.connectivity-table th{font-size:.75rem;text-transform:uppercase;color:var(--muted);letter-spacing:.06em;background:rgba(0,0,0,0.25);}
.connectivity-table tr:last-child td{border-bottom:none;}
.connectivity-table tr.status-open{background:rgba(65,154,109,0.1);}
.connectivity-table tr.status-closed{background:rgba(164,73,73,0.12);}
.host-alerts{margin:0;padding-left:1.2rem;color:#ffd7d7;font-size:.85rem;}
.host-alerts li{margin-bottom:.25rem;}

.timeline{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:1rem;}
.timeline-item{padding-left:1.2rem;border-left:2px solid rgba(139,197,255,0.25);display:flex;flex-direction:column;gap:.4rem;}
.timeline-title{font-weight:600;font-size:1rem;color:var(--text);}
.timeline-meta{display:flex;flex-wrap:wrap;gap:.5rem 1.4rem;font-size:.85rem;color:var(--muted);align-items:center;}

.tasks-table{width:100%;border-collapse:collapse;font-size:.92rem;}
.tasks-table th,.tasks-table td{padding:.6rem .75rem;border-bottom:1px solid rgba(255,255,255,0.05);text-align:left;vertical-align:top;}
.tasks-table th{font-size:.75rem;text-transform:uppercase;color:var(--muted);letter-spacing:.06em;}
.progress-bar{background:rgba(255,255,255,0.08);border-radius:999px;height:6px;overflow:hidden;margin-bottom:.35rem;}
.progress-bar span{display:block;height:100%;background:linear-gradient(90deg,#7fb5ff,#4d9dff);transition:width .4s ease;}
.task-output details{cursor:pointer;}
.task-output pre{margin-top:.5rem;}

.findings-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:1rem;}
.findings-list li{background:rgba(255,255,255,0.02);padding:1rem 1.2rem;border-radius:12px;border:1px solid rgba(255,255,255,0.04);word-break:break-word;}
.finding-header{display:flex;gap:.5rem;margin-bottom:.4rem;}
.ports-group{margin-top:.8rem;}
.ports-group h4{margin:0 0 .35rem;font-size:.95rem;}
.ports-list{list-style:none;margin:0;padding:0;display:flex;flex-wrap:wrap;gap:.4rem 1.2rem;font-size:.88rem;}
.ports-list li strong{margin-right:.35rem;}
.finding-host{display:flex;align-items:center;gap:.6rem;margin:.6rem 0;}
.summary-hosts ul{list-style:disc;margin:.4rem 0 0 1.2rem;padding:0;font-size:.88rem;}
.raw-data summary{cursor:pointer;font-weight:600;}
.raw-data pre{margin-top:.5rem;}

.macros-card .macro-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.7rem;max-height:320px;overflow:auto;}
.macro-list li{display:flex;flex-direction:column;gap:.35rem;background:rgba(255,255,255,0.02);padding:.75rem 1rem;border-radius:10px;border:1px solid rgba(255,255,255,0.03);}
.macro-key{font-family:"Fira Code",monospace;color:#89d1ff;font-size:.85rem;}
.macro-value{color:var(--text);}
.macro-list pre{margin:0;background:rgba(0,0,0,0.4);padding:.6rem .8rem;border-radius:8px;white-space:pre-wrap;font-family:"Fira Code",monospace;font-size:.78rem;}

.logs-card{display:flex;flex-direction:column;gap:1rem;max-height:420px;overflow:hidden;}
.logs-list{list-style:none;margin:0;padding:0;overflow:auto;max-height:340px;display:flex;flex-direction:column;gap:.75rem;}
.log-entry{padding:.75rem 1rem;border-radius:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);display:flex;flex-direction:column;gap:.4rem;}
.log-entry header{display:flex;align-items:center;justify-content:space-between;gap:.6rem;font-size:.85rem;}
.log-entry .severity{display:inline-flex;align-items:center;padding:.2rem .6rem;border-radius:999px;font-weight:600;font-size:.72rem;}
.log-entry .severity-ERROR{background:rgba(255,132,132,0.25);color:#ffd8d8;}
.log-entry .severity-WARN{background:rgba(255,214,165,0.25);color:#ffe5c7;}
.log-entry .severity-INFO{background:rgba(127,181,255,0.22);color:#d3e8ff;}
.log-entry .severity-NOTICE{background:rgba(124,214,191,0.25);color:#dbf9f1;}
.log-entry .severity-CRITICAL{background:rgba(206,91,91,0.32);color:#ffe0e0;}
.log-entry footer{display:flex;align-items:center;justify-content:space-between;font-size:.75rem;color:var(--muted);}
.log-entry code{font-family:"Fira Code",monospace;font-size:.78rem;background:rgba(0,0,0,0.35);padding:.3rem .45rem;border-radius:6px;}

.toast-container{position:fixed;top:1.2rem;right:1.2rem;z-index:9999;display:flex;flex-direction:column;gap:.6rem;pointer-events:none;}
.toast{min-width:260px;max-width:320px;padding:.75rem 1rem;border-radius:10px;background:rgba(8,23,43,0.9);border:1px solid rgba(255,255,255,0.12);color:#fff;box-shadow:0 12px 28px rgba(0,0,0,0.35);opacity:0;transform:translateY(-10px);transition:opacity .25s ease,transform .25s ease;pointer-events:auto;}
.toast.show{opacity:1;transform:translateY(0);}
.toast.success{border-color:rgba(118,221,174,0.45);}
.toast.error{border-color:rgba(255,132,132,0.45);}
.toast .toast-title{font-weight:600;font-size:.9rem;margin-bottom:.2rem;}
.toast .toast-body{font-size:.85rem;color:rgba(255,255,255,0.85);}
.toast button{background:none;border:none;color:inherit;font-size:1rem;cursor:pointer;margin-left:auto;display:inline-flex;align-items:center;}

.empty{padding:1rem;background:rgba(255,255,255,0.02);border-radius:10px;color:var(--muted);}
.tasks-table pre,.findings-list pre{margin:0;background:rgba(0,0,0,0.45);padding:.6rem .8rem;border-radius:8px;white-space:pre-wrap;word-break:break-word;max-width:100%;overflow:auto;}

.live-update-error{color:#ffb8b8;font-size:.85rem;margin-top:.75rem;}

@keyframes pulse{0%{opacity:0.3;}50%{opacity:1;}100%{opacity:0.3;}}
@keyframes beaconPulse{0%{box-shadow:0 0 0 0 currentColor;opacity:.85;}70%{box-shadow:0 0 0 16px rgba(255,255,255,0);opacity:1;}100%{box-shadow:0 0 0 0 rgba(255,255,255,0);opacity:.75;}}
@media (max-width:900px){
  .page-heading{flex-direction:column;align-items:flex-start;}
  .session-status{align-items:flex-start;}
  .execution-status{flex-direction:column;align-items:flex-start;}
  .timeline-meta{flex-direction:column;align-items:flex-start;gap:.35rem;}
  .tasks-table{display:block;overflow-x:auto;}
  .logs-card{max-height:none;}
  .logs-list{max-height:none;}
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const root = document.getElementById("session-root");
  if (!root) return;

  const statusPill = document.getElementById("session-status-pill");
  const liveIndicator = document.getElementById("live-indicator");
  const tasksBody = document.getElementById("tasks-body");
  const tasksEmpty = document.getElementById("tasks-empty");
  const findingsList = document.getElementById("findings-list");
  const findingsEmpty = document.getElementById("findings-empty");
  const logsList = document.getElementById("session-logs");
  const logsEmpty = document.getElementById("logs-empty");
  const toastContainer = document.getElementById("toast-container");
  const executionCard = document.getElementById("execution-card");
  const executionStatusBeacon = document.getElementById("execution-status-beacon");
  const executionStatusLabel = document.getElementById("execution-status-label");
  const executionTaskLabel = document.getElementById("execution-task-label");
  const executionProgressBar = document.getElementById("execution-progress-bar");
  const executionProgressValue = document.getElementById("execution-progress-value");
  const executionProgressDetail = document.getElementById("execution-progress-detail");
  const liveConsole = document.getElementById("live-console");
  const liveConsoleEmpty = document.getElementById("live-console-empty");
  const consoleBody = document.getElementById("console-body");
  const executionTimeIndicator = document.getElementById("execution-time-indicator");
  const sessionStartedAt = document.getElementById("session-started-at");
  const sessionFinishedAt = document.getElementById("session-finished-at");
  const sessionNotes = document.getElementById("session-notes");
  const metricsGrid = document.getElementById("metrics-grid");
  const insightsList = document.getElementById("insights-list");
  const insightsEmpty = document.getElementById("insights-empty");
  const connectivityTotals = document.getElementById("connectivity-totals");
  const connectivityHosts = document.getElementById("connectivity-hosts");
  const connectivityEmpty = document.getElementById("connectivity-empty");
  const timelineList = document.getElementById("timeline-list");
  const timelineEmpty = document.getElementById("timeline-empty");

  const statusUrl = root.dataset.apiStatusUrl;
  const logsUrl = root.dataset.apiLogsUrl;
  const sessionId = root.dataset.sessionId;
  const initialStatus = root.dataset.status;
  const terminalStatuses = new Set(["completed", "failed", "canceled"]);
  let previousStatus = initialStatus;
  let latestLogCursor = null;
  let isFetchingLogs = false;
  const MAX_CONSOLE_LINES = 400;
  let consoleLines = [];
  const STATUS_CLASSES = [
    "status-running",
    "status-completed",
    "status-failed",
    "status-error",
    "status-canceled",
    "status-planned",
    "status-ready",
    "status-pending",
    "status-queued",
  ];
  let statusPollTimer = null;

  let bootstrapData = {};
  const bootstrapElement = document.getElementById("session-bootstrap");
  if (bootstrapElement && bootstrapElement.textContent) {
    try {
      bootstrapData = JSON.parse(bootstrapElement.textContent);
    } catch (error) {
      console.warn("Falha ao interpretar dados de bootstrap da sessão", error);
    }
  }
  const bootstrapTasks = Array.isArray(bootstrapData.tasks) ? bootstrapData.tasks : [];
  const bootstrapLogs = Array.isArray(bootstrapData.logs) ? bootstrapData.logs : [];
  const bootstrapStatus = bootstrapData.status || initialStatus;
  const bootstrapStatusDisplay = bootstrapData.status_display || (statusPill ? statusPill.textContent : "");

  const scheduleStatusPoll = (delay = 2500) => {
    if (!statusUrl) return;
    if (statusPollTimer) {
      clearTimeout(statusPollTimer);
    }
    statusPollTimer = setTimeout(() => {
      pollStatus();
    }, Math.max(0, delay));
  };

  const shouldPoll = Boolean(statusUrl) && !terminalStatuses.has(initialStatus);
  if (!shouldPoll && liveIndicator) {
    liveIndicator.classList.add("hidden");
  }

  if (bootstrapTasks.length) {
    updateExecutionPanel({
      status: bootstrapStatus,
      status_display: bootstrapStatusDisplay,
    }, bootstrapTasks);
  } else {
    updateExecutionPanel({
      status: bootstrapStatus,
      status_display: bootstrapStatusDisplay,
    }, []);
  }
  previousStatus = bootstrapStatus;
  if (bootstrapLogs.length) {
    appendLogs(bootstrapLogs, true);
    latestLogCursor = bootstrapData.latest_log_cursor || bootstrapLogs[bootstrapLogs.length - 1]?.timestamp || null;
    updateLogsEmpty();
  }

  if (bootstrapData && typeof bootstrapData === "object" && Object.keys(bootstrapData).length > 0) {
    if (bootstrapData.session) {
      updateSessionOverview(bootstrapData.session);
    } else {
      updateSessionOverview(bootstrapData);
    }
    if (Object.prototype.hasOwnProperty.call(bootstrapData, "overview_metrics") || Object.prototype.hasOwnProperty.call(bootstrapData, "report_insights")) {
      renderOverviewMetrics(bootstrapData.overview_metrics || [], bootstrapData.report_insights || []);
    }
    if (Object.prototype.hasOwnProperty.call(bootstrapData, "connectivity_overview")) {
      renderConnectivity(bootstrapData.connectivity_overview || null);
    }
    if (Object.prototype.hasOwnProperty.call(bootstrapData, "timeline_entries")) {
      renderTimeline(bootstrapData.timeline_entries || []);
    }
  }

  function statusToneClass(status) {
    switch (status) {
      case "running": return "status-running";
      case "completed": return "status-completed";
      case "failed": return "status-failed";
      default: return "status-" + status;
    }
  }

  function formatDate(iso) {
    if (!iso) return "—";
    const date = new Date(iso);
    if (Number.isNaN(date.getTime())) return "—";
    return new Intl.DateTimeFormat("pt-BR", {
      dateStyle: "short",
      timeStyle: "medium",
    }).format(date);
  }

  function formatDateShort(iso) {
    if (!iso) return null;
    const date = new Date(iso);
    if (Number.isNaN(date.getTime())) return null;
    return new Intl.DateTimeFormat("pt-BR", {
      dateStyle: "short",
      timeStyle: "short",
    }).format(date);
  }

  function escapeHtml(value) {
    const safeValue = value == null ? "" : String(value);
    return safeValue
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function setEmptyState(element, message) {
    if (!element) return;
    const text = message || element.dataset.emptyText || "—";
    element.innerHTML = `<span class="muted">${escapeHtml(text)}</span>`;
  }

  function setPlainText(element, value, fallbackMessage) {
    if (!element) return;
    const stringValue = value == null ? "" : String(value);
    if (stringValue.trim()) {
      element.textContent = stringValue;
    } else {
      element.textContent = fallbackMessage || element.dataset.emptyText || "";
    }
  }

  function updateSessionOverview(sessionPayload) {
    if (!sessionPayload) return;
    const startedAtValue = sessionPayload.started_at || sessionPayload.created_at || null;
    const finishedAtValue = sessionPayload.finished_at || null;
    const notesValue = sessionPayload.notes || "";

    const formattedStarted = formatDateShort(startedAtValue);
    if (sessionStartedAt) {
      if (formattedStarted) {
        sessionStartedAt.textContent = formattedStarted;
      } else {
        setEmptyState(sessionStartedAt);
      }
    }

    const formattedFinished = formatDateShort(finishedAtValue);
    if (sessionFinishedAt) {
      if (formattedFinished) {
        sessionFinishedAt.textContent = formattedFinished;
      } else {
        setEmptyState(sessionFinishedAt);
      }
    }

    if (sessionNotes) {
      setPlainText(sessionNotes, notesValue, sessionNotes.dataset.emptyText || "");
    }

    if (executionTimeIndicator) {
      if (formattedFinished) {
        executionTimeIndicator.textContent = `Finalizada em ${formattedFinished}`;
      } else if (formattedStarted) {
        executionTimeIndicator.textContent = `Iniciada em ${formattedStarted}`;
      } else {
        executionTimeIndicator.textContent = "Sessão ainda não iniciada.";
      }
    }
  }

  function renderOverviewMetrics(metrics = [], insights = []) {
    if (metricsGrid) {
      metricsGrid.innerHTML = "";
      const hasMetrics = Array.isArray(metrics) && metrics.length > 0;
      if (hasMetrics) {
        metrics.forEach(metric => {
          const card = document.createElement("div");
          card.className = "metric-card";
          const value = metric.value ?? "—";
          const label = metric.label ?? "Métrica";
          const note = metric.note ?? "";
          card.innerHTML = `
            <span class="metric-value">${escapeHtml(String(value))}</span>
            <span class="metric-label">${escapeHtml(String(label))}</span>
            ${note ? `<span class="metric-note">${escapeHtml(String(note))}</span>` : ""}
          `;
          metricsGrid.appendChild(card);
        });
      } else {
        const emptyMessage = metricsGrid.dataset.emptyText || "Nenhuma métrica disponível.";
        const placeholder = document.createElement("div");
        placeholder.className = "empty";
        placeholder.textContent = emptyMessage;
        metricsGrid.appendChild(placeholder);
      }
    }

    if (insightsList && insightsEmpty) {
      insightsList.innerHTML = "";
      const hasInsights = Array.isArray(insights) && insights.length > 0;
      insightsList.classList.toggle("hidden", !hasInsights);
      insightsEmpty.classList.toggle("hidden", hasInsights);

      if (hasInsights) {
        insights.forEach(insight => {
          const li = document.createElement("li");
          const level = insight.level || "info";
          li.className = `insight insight-${escapeHtml(String(level))}`;
          li.textContent = insight.message || "Insight registrado";
          insightsList.appendChild(li);
        });
      } else {
        const emptyMessage = insightsEmpty.dataset.emptyText || insightsList.dataset.emptyText || insightsEmpty.textContent;
        insightsEmpty.textContent = emptyMessage;
      }
    }
  }

  function renderConnectivity(overview) {
    if (!connectivityTotals || !connectivityHosts || !connectivityEmpty) return;
    const totals = overview && typeof overview === "object" ? overview.totals || {} : {};
    const hosts = overview && Array.isArray(overview.hosts) ? overview.hosts : [];

    const reachable = totals.reachable ?? 0;
    const unreachable = totals.unreachable ?? 0;
    const checkedPorts = totals.checked_ports ?? 0;

    connectivityTotals.innerHTML = `
      <div>
        <span class="counter">${escapeHtml(String(reachable))}</span>
        <span class="label">Hosts alcançados</span>
      </div>
      <div>
        <span class="counter">${escapeHtml(String(unreachable))}</span>
        <span class="label">Hosts sem resposta</span>
      </div>
      <div>
        <span class="counter">${escapeHtml(String(checkedPorts))}</span>
        <span class="label">Portas verificadas</span>
      </div>
    `;

    connectivityHosts.innerHTML = "";
    const hasHosts = hosts.length > 0;
    if (hasHosts) {
      hosts.forEach(host => {
        const article = document.createElement("article");
        article.className = `connectivity-host ${host.reachable ? "reachable" : "unreachable"}`;
        const latencySummary = (() => {
          if (host.latency_avg != null) {
            const min = host.latency_min != null ? `${escapeHtml(String(host.latency_min))} ms` : null;
            const max = host.latency_max != null ? `${escapeHtml(String(host.latency_max))} ms` : null;
            const detail = min && max ? `${min} – ${max}` : min || max || "";
            const detailBlock = detail ? `<small class="muted">${detail}</small>` : "";
            return `
              <span>Média ${escapeHtml(String(host.latency_avg))} ms</span>
              ${detailBlock}
            `;
          }
          return '<span class="muted">Sem métricas de latência</span>';
        })();

        const openPorts = Array.isArray(host.open_ports) ? host.open_ports : [];
        const closedPorts = Array.isArray(host.closed_ports) ? host.closed_ports : [];
        const openRows = openPorts.map(port => `
          <tr class="status-open">
            <td>${escapeHtml(String(port.port ?? "—"))}</td>
            <td><span class="status-chip status-open">Aberta</span></td>
            <td>${port.latency_ms != null ? `${escapeHtml(String(port.latency_ms))} ms` : '<span class="muted">—</span>'}</td>
            <td><span class="muted">—</span></td>
          </tr>
        `).join("");
        const closedRows = closedPorts.map(port => `
          <tr class="status-closed">
            <td>${escapeHtml(String(port.port ?? "—"))}</td>
            <td><span class="status-chip status-closed">Fechada</span></td>
            <td><span class="muted">—</span></td>
            <td>${escapeHtml(String(port.error || "Conexão recusada"))}</td>
          </tr>
        `).join("");
        const tableBody = openRows + closedRows;

        const hostErrors = Array.isArray(host.errors) ? host.errors : [];
        const errorsList = hostErrors.length
          ? `<ul class="host-alerts">${hostErrors.map(error => `<li>${escapeHtml(String(error))}</li>`).join("")}</ul>`
          : "";

        article.innerHTML = `
          <header>
            <div>
              <h3>${escapeHtml(String(host.host || "Host"))}</h3>
              <span class="status-chip ${host.reachable ? "status-open" : "status-closed"}">
                ${host.reachable ? "Alcançado" : "Sem resposta"}
              </span>
            </div>
            <div class="latency-summary">${latencySummary}</div>
          </header>
          <table class="connectivity-table">
            <thead>
              <tr>
                <th>Porta</th>
                <th>Status</th>
                <th>Latência</th>
                <th>Observações</th>
              </tr>
            </thead>
            <tbody>
              ${tableBody || `
                <tr>
                  <td colspan="4"><span class="muted">Nenhuma porta registrada.</span></td>
                </tr>
              `}
            </tbody>
          </table>
          ${errorsList}
        `;
        connectivityHosts.appendChild(article);
      });
    }

    const emptyMessage = connectivityEmpty.dataset.emptyText || connectivityEmpty.textContent;
    connectivityEmpty.textContent = emptyMessage;
    connectivityEmpty.classList.toggle("hidden", hasHosts);
    connectivityHosts.classList.toggle("hidden", !hasHosts);
  }

  function renderTimeline(entries = []) {
    if (!timelineList || !timelineEmpty) return;
    timelineList.innerHTML = "";
    const hasEntries = Array.isArray(entries) && entries.length > 0;
    if (hasEntries) {
      entries.forEach(step => {
        const li = document.createElement("li");
        const label = step.label || "Etapa";
        const status = step.status || "pending";
        const statusDisplay = step.status_display || status;
        const startedAt = step.started_at || "—";
        const finishedAt = step.finished_at || "—";
        const duration = step.duration || "—";

        li.innerHTML = `
          <div class="timeline-item">
            <div class="timeline-title">${escapeHtml(String(label))}</div>
            <div class="timeline-meta">
              <span class="status-chip status-${escapeHtml(String(status))}">${escapeHtml(String(statusDisplay))}</span>
              <span>Início ${escapeHtml(String(startedAt))}</span>
              <span>Término ${escapeHtml(String(finishedAt))}</span>
              <span>Duração ${escapeHtml(String(duration))}</span>
            </div>
          </div>
        `;
        timelineList.appendChild(li);
      });
    }

    const emptyMessage = timelineEmpty.dataset.emptyText || timelineEmpty.textContent;
    timelineEmpty.textContent = emptyMessage;
    timelineList.classList.toggle("hidden", !hasEntries);
    timelineEmpty.classList.toggle("hidden", hasEntries);
  }

  function resetConsole() {
    consoleLines = [];
    if (liveConsole) {
      liveConsole.textContent = "";
    }
  }

  function updateConsoleEmpty() {
    if (!liveConsole || !liveConsoleEmpty) return;
    const hasContent = consoleLines.length > 0;
    liveConsole.classList.toggle("hidden", !hasContent);
    liveConsoleEmpty.classList.toggle("hidden", hasContent);
  }

  function appendConsoleLine(log) {
    if (!liveConsole) return;
    const timestamp = log.timestamp_display || log.timestamp || "";
    const severity = (log.severity || "").toUpperCase();
    const component = log.component || "";
    const message = (log.message || "").trim();
    const parts = [];
    if (timestamp) parts.push(`[${timestamp}]`);
    if (severity) parts.push(`[${severity}]`);
    if (component) parts.push(`[${component}]`);
    if (message) parts.push(message);
    if (!parts.length) return;
    const line = parts.join(" ");
    consoleLines.push(line);
    if (consoleLines.length > MAX_CONSOLE_LINES) {
      consoleLines = consoleLines.slice(-MAX_CONSOLE_LINES);
    }
    liveConsole.textContent = consoleLines.join("\n");
    updateConsoleEmpty();
    if (consoleBody) {
      consoleBody.scrollTop = consoleBody.scrollHeight;
    }
  }

  function calculateOverallProgress(tasks, sessionStatus) {
    if (Array.isArray(tasks) && tasks.length) {
      const total = tasks.reduce((acc, task) => {
        const parsedPercent = Number(task.progress_percent);
        if (!Number.isNaN(parsedPercent)) {
          return acc + Math.max(0, Math.min(100, Math.round(parsedPercent)));
        }
        const fallback = typeof task.progress === "number"
          ? Math.round(Math.max(0, Math.min(1, task.progress)) * 100)
          : 0;
        return acc + fallback;
      }, 0);
      const average = Math.round(total / tasks.length);
      const clamped = Math.max(0, Math.min(100, average));
      if (terminalStatuses.has(sessionStatus)) {
        return 100;
      }
      return clamped;
    }
    return terminalStatuses.has(sessionStatus) ? 100 : 0;
  }

  function resolveOverallProgress(sessionPayload, tasks, fallbackStatus) {
    if (sessionPayload && Object.prototype.hasOwnProperty.call(sessionPayload, "overall_progress_percent")) {
      const parsed = Number(sessionPayload.overall_progress_percent);
      if (!Number.isNaN(parsed)) {
        const normalized = Math.max(0, Math.min(100, Math.round(parsed)));
        const referenceStatus = sessionPayload.status || fallbackStatus;
        if (referenceStatus && terminalStatuses.has(referenceStatus)) {
          return 100;
        }
        return normalized;
      }
    }
    const referenceStatus = sessionPayload && sessionPayload.status ? sessionPayload.status : fallbackStatus;
    return calculateOverallProgress(tasks, referenceStatus);
  }

  function updateExecutionPanel(sessionPayload, tasks) {
    if (!executionCard) return;
    const status = sessionPayload.status;
    const statusDisplay = sessionPayload.status_display;

    if (executionCard) {
      const payloadTotal = sessionPayload && typeof sessionPayload.total_tasks_count === "number"
        ? sessionPayload.total_tasks_count
        : null;
      const storedTotal = Number.parseInt(executionCard.dataset.totalTasks || "0", 10) || 0;
      const derivedTotal = payloadTotal !== null
        ? payloadTotal
        : Array.isArray(tasks) && tasks.length ? tasks.length : storedTotal;
      const normalizedTotal = Math.max(0, Math.round(derivedTotal));
      executionCard.dataset.totalTasks = String(normalizedTotal);
    }

    if (executionStatusBeacon) {
      STATUS_CLASSES.forEach(cls => executionStatusBeacon.classList.remove(cls));
      executionStatusBeacon.classList.add(statusToneClass(status));
    }

    if (executionStatusLabel) {
      executionStatusLabel.textContent = statusDisplay;
    }

    if (executionTaskLabel) {
      const runningTask = tasks.find(task => task.status === "running");
      const failingTask = tasks.find(task => task.status === "failed" || task.status === "error");
      const queuedTask = tasks.find(task => ["queued", "pending", "ready", "planned"].includes(task.status));
      const completedTasks = tasks.filter(task => task.status === "completed");
      let descriptor = "Aguardando atualização…";

      if (runningTask) {
        const context = runningTask.script_name || runningTask.tool_name;
        descriptor = context ? `${runningTask.name} • ${context}` : runningTask.name;
      } else if (status === "failed" && failingTask) {
        descriptor = `Falha em ${failingTask.name}`;
      } else if (queuedTask) {
        descriptor = `Próxima etapa: ${queuedTask.name}`;
      } else if (status === "completed" && completedTasks.length) {
        descriptor = `Última etapa concluída: ${completedTasks[completedTasks.length - 1].name}`;
      } else if (status === "canceled") {
        descriptor = "Sessão cancelada.";
      } else if (!tasks.length && terminalStatuses.has(status)) {
        descriptor = "Sessão finalizada.";
      }

      executionTaskLabel.textContent = descriptor;
    }

    if (executionProgressBar) {
      const progressPercent = resolveOverallProgress(sessionPayload, tasks, status);
      executionProgressBar.dataset.progress = progressPercent;
      syncProgressBars(executionCard);
      if (executionProgressValue) {
        executionProgressValue.textContent = `${progressPercent}%`;
      }
      if (executionProgressDetail) {
        const completedFromPayload = sessionPayload && typeof sessionPayload.completed_tasks_count === "number"
          ? sessionPayload.completed_tasks_count
          : null;
        const completedCount = completedFromPayload !== null
          ? completedFromPayload
          : tasks.filter(task => task.status === "completed").length;
        const storedTotal = Number.parseInt(executionCard.dataset.totalTasks || "0", 10) || 0;
        const totalTasks = storedTotal || tasks.length;
        executionProgressDetail.textContent = totalTasks
          ? `${completedCount} de ${totalTasks} etapas concluídas`
          : "Nenhuma etapa registrada ainda.";
      }
    }
  }

  function syncProgressBars(scope = document) {
    scope.querySelectorAll(".progress-bar").forEach(bar => {
      const progress = Number.parseInt(bar.dataset.progress ?? "0", 10);
      const clamped = Number.isNaN(progress) ? 0 : Math.max(0, Math.min(progress, 100));
      const span = bar.querySelector("span");
      if (span) {
        span.style.width = `${clamped}%`;
      }
    });
  }

  function renderTasks(tasks) {
    if (!tasksBody) return;
    tasksBody.innerHTML = "";
    tasks.forEach((task, index) => {
      const tr = document.createElement("tr");
      tr.dataset.taskId = task.id;
      const progressPercent = typeof task.progress_percent === "number"
        ? task.progress_percent
        : Math.round((task.progress || 0) * 100);
      const stdout = task.stdout ? escapeHtml(task.stdout) : "";
      const stdoutBlock = task.stdout
        ? `<details><summary>Ver saída</summary><pre>${stdout}</pre></details>`
        : '<span class="muted">Sem saída</span>';
      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>
          <strong>${task.name}</strong>
          <span class="muted">${task.kind_display}</span>
        </td>
        <td>${task.tool_name || "—"}</td>
        <td>${task.script_name || "—"}</td>
        <td><span class="status-pill ${statusToneClass(task.status)}">${task.status_display}</span></td>
        <td>
          <div class="progress-bar" data-progress="${progressPercent}"><span></span></div>
          <small class="muted">${progressPercent}%</small>
        </td>
        <td>${formatDate(task.started_at)}</td>
        <td>${formatDate(task.finished_at)}</td>
        <td class="task-output">${stdoutBlock}</td>
      `;
      tasksBody.appendChild(tr);
    });

    syncProgressBars(tasksBody);

    if (tasksEmpty) {
      tasksEmpty.classList.toggle("hidden", tasks.length > 0);
      if (!tasks.length) {
        tasksEmpty.textContent = document.querySelector(".tasks-card").dataset.emptyText;
      }
    }
  }

  function renderFindings(findings) {
    if (!findingsList) return;
    findingsList.innerHTML = "";

    findings.forEach(finding => {
      const li = document.createElement("li");
      const severityBadge = finding.severity ? `<span class="badge severity">${escapeHtml(finding.severity)}</span>` : "";
      const data = finding.data || {};
      const ports = Array.isArray(data.ports) ? data.ports : [];
      const openPorts = ports.filter(port => port.status === "open");
      const closedPorts = ports.filter(port => port.status && port.status !== "open");
      const hostsList = Array.isArray(data.hosts) ? data.hosts : [];

      const hostBlock = data.host ? `
        <div class="finding-host">
          <span class="status-chip ${data.reachable ? "status-open" : "status-closed"}">${data.reachable ? "Host alcançado" : "Host sem resposta"}</span>
          <span class="muted">${escapeHtml(String(data.host))}</span>
        </div>
      ` : "";

      const openPortsBlock = openPorts.length ? `
        <div class="ports-group">
          <h4>Portas em evidência</h4>
          <ul class="ports-list open">
            ${openPorts.map(port => `
              <li><strong>${escapeHtml(String(port.port))}</strong> <span class="muted">Aberta${port.latency_ms ? ` • ${escapeHtml(String(port.latency_ms))} ms` : ""}</span></li>
            `).join("")}
          </ul>
        </div>
      ` : "";

      const closedPortsBlock = closedPorts.length ? `
        <div class="ports-group">
          <h4>Portas sem resposta</h4>
          <ul class="ports-list closed">
            ${closedPorts.map(port => `
              <li><strong>${escapeHtml(String(port.port))}</strong> <span class="muted">${escapeHtml(port.error || "Conexão recusada")}</span></li>
            `).join("")}
          </ul>
        </div>
      ` : "";

      const hostsBlock = hostsList.length ? `
        <div class="summary-hosts">
          <h4>Hosts mapeados</h4>
          <ul>${hostsList.map(host => `<li>${escapeHtml(String(host))}</li>`).join("")}</ul>
        </div>
      ` : "";

      const rawData = finding.data ? escapeHtml(JSON.stringify(finding.data, null, 2)) : "";
      const rawBlock = finding.data ? `
        <details class="raw-data">
          <summary>Ver dados brutos</summary>
          <pre>${rawData}</pre>
        </details>
      ` : "";

      li.innerHTML = `
        <div class="finding-header">
          <span class="badge kind-${escapeHtml(finding.kind)}">${escapeHtml(finding.kind_display || finding.kind)}</span>
          ${severityBadge}
        </div>
        <h3>${escapeHtml(finding.title || "Achado")}</h3>
        <p>${finding.summary ? escapeHtml(finding.summary) : "Sem descrição adicional."}</p>
        ${hostBlock}
        ${openPortsBlock}
        ${closedPortsBlock}
        ${hostsBlock}
        ${rawBlock}
      `;
      findingsList.appendChild(li);
    });

    if (findingsEmpty) {
      findingsEmpty.classList.toggle("hidden", findings.length > 0);
      if (!findings.length) findingsEmpty.textContent = document.querySelector(".findings-card").dataset.emptyText;
    }
  }

  async function pollStatus() {
    if (!statusUrl) return;
    try {
      const response = await fetch(statusUrl, {
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "Cache-Control": "no-cache",
        },
      });
      if (!response.ok) throw new Error("Falha ao consultar status");
      const payload = await response.json();
      const tasks = payload.tasks || [];

      if (statusPill) {
        statusPill.textContent = payload.status_display;
        statusPill.className = "status-pill " + statusToneClass(payload.status);
      }

    handleStatusTransition(payload.status, payload.status_display);
    updateSessionOverview(payload);
    renderOverviewMetrics(payload.overview_metrics || [], payload.report_insights || []);
    renderConnectivity(payload.connectivity_overview || null);
    renderTimeline(payload.timeline_entries || []);

    if (tasksBody) renderTasks(tasks);
    updateExecutionPanel(payload, tasks);
    if (findingsList) renderFindings(payload.findings || []);
      if (logsUrl) fetchLogs();

      if (!terminalStatuses.has(payload.status)) {
        if (liveIndicator) {
          liveIndicator.classList.remove("hidden", "tone-success", "tone-error");
          liveIndicator.textContent = "Atualizando em tempo real…";
        }
        scheduleStatusPoll(2500);
      } else if (liveIndicator) {
        liveIndicator.classList.remove("hidden");
      }
    } catch (error) {
      console.error("Erro ao atualizar sessão", error);
      if (liveIndicator) {
        liveIndicator.textContent = "Falha ao atualizar automaticamente.";
        liveIndicator.classList.remove("hidden", "tone-success", "tone-error");
        liveIndicator.classList.add("tone-error");
      }
      scheduleStatusPoll(5000);
    }
  }

  syncProgressBars();
  if (statusUrl) {
    pollStatus();
  }
  if (logsUrl) {
    fetchLogs(true);
  }

  function handleStatusTransition(currentStatus, statusDisplay) {
    if (liveIndicator && terminalStatuses.has(currentStatus)) {
      liveIndicator.textContent = currentStatus === "completed" ? "Sessão concluída." : "Sessão finalizada.";
      liveIndicator.classList.remove("hidden", "tone-success", "tone-error");
      liveIndicator.classList.add(currentStatus === "completed" ? "tone-success" : "tone-error");
    }

    if (previousStatus !== currentStatus && terminalStatuses.has(currentStatus)) {
      const tone = currentStatus === "completed" ? "success" : "error";
      showToast({
        title: currentStatus === "completed" ? "Scan finalizado" : "Scan encerrado",
        message: statusDisplay || "A sessão foi encerrada.",
        tone,
      });
    }

    previousStatus = currentStatus;
  }

  async function fetchLogs(initial = false) {
    if (isFetchingLogs || !logsUrl) return;
    isFetchingLogs = true;

    try {
      const url = new URL(logsUrl, window.location.origin);
      if (!initial && latestLogCursor) {
        url.searchParams.set("cursor", latestLogCursor);
      }
      url.searchParams.set("limit", initial ? "100" : "50");

      const response = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
      if (!response.ok) throw new Error("Falha ao buscar logs");
      const payload = await response.json();
      const logs = payload.results || [];
      if (logs.length) {
        appendLogs(logs, initial);
        latestLogCursor = logs[logs.length - 1].timestamp;
      }
      updateLogsEmpty();
    } catch (error) {
      console.error("Erro ao buscar logs", error);
    } finally {
      isFetchingLogs = false;
    }
  }

  function appendLogs(logs, initialLoad = false) {
    if (!logsList) return;
    if (liveConsole && initialLoad) {
      resetConsole();
    }
    const fragment = document.createDocumentFragment();
    logs.forEach(log => {
      const li = document.createElement("li");
      li.className = "log-entry";
      li.innerHTML = `
        <header>
          <span class="severity severity-${log.severity}">${log.severity}</span>
          <span>${log.timestamp_display || ""}</span>
        </header>
        <div class="log-message">${escapeHtml(log.message || "")}</div>
        <footer>
          <span>${escapeHtml(log.event_type || "")}</span>
          <span>${escapeHtml(log.component || "")}</span>
        </footer>
      `;
      fragment.appendChild(li);
      appendConsoleLine(log);
    });

    if (initialLoad || !logsList.children.length) {
      logsList.innerHTML = "";
      logsList.appendChild(fragment);
    } else {
      logsList.appendChild(fragment);
      if (logsList.children.length > 200) {
        while (logsList.children.length > 200) {
          logsList.removeChild(logsList.firstChild);
        }
      }
      logsList.scrollTop = logsList.scrollHeight;
    }

    updateConsoleEmpty();
  }

  function updateLogsEmpty() {
    if (!logsEmpty || !logsList) return;
    const hasLogs = logsList.children.length > 0;
    logsEmpty.classList.toggle("hidden", hasLogs);
    logsList.classList.toggle("hidden", !hasLogs);
    updateConsoleEmpty();
  }

  function showToast({ title, message, tone = "success", timeout = 5000 }) {
    if (!toastContainer) return;
    const toast = document.createElement("div");
    toast.className = `toast ${tone}`;
    toast.innerHTML = `
      <div class="toast-title">${escapeHtml(title)}</div>
      <div class="toast-body">${escapeHtml(message)}</div>
      <button type="button" aria-label="Fechar">×</button>
    `;

    const close = () => {
      toast.classList.remove("show");
      setTimeout(() => toast.remove(), 250);
    };

    toast.querySelector("button").addEventListener("click", close);
    toastContainer.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add("show"));
    setTimeout(close, timeout);
  }
});
</script>
{% endblock %}
