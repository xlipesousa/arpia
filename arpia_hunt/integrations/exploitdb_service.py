from __future__ import annotations

import json
import os
import subprocess
from typing import Mapping

from .base import IntegrationError

DEFAULT_SEARCHSPLOIT_PATH = "/usr/bin/searchsploit"


def search_cve(cve: str) -> Mapping[str, object]:
    searchsploit_path = os.getenv("ARPIA_HUNT_SEARCHSPLOIT_PATH", DEFAULT_SEARCHSPLOIT_PATH)

    timeout_value = os.getenv("ARPIA_HUNT_SEARCHSPLOIT_TIMEOUT", "15")
    try:
        timeout = int(timeout_value)
    except ValueError:
        timeout = 15

    try:
        process = subprocess.run(
            [searchsploit_path, "-j", cve],
            check=True,
            capture_output=True,
            text=True,
            timeout=timeout,
        )
    except FileNotFoundError as exc:
        raise IntegrationError(f"searchsploit não encontrado em '{searchsploit_path}'.", retriable=False) from exc
    except subprocess.TimeoutExpired as exc:
        raise IntegrationError(f"searchsploit excedeu o tempo limite ({timeout}s) para {cve}.") from exc
    except subprocess.CalledProcessError as exc:
        raise IntegrationError(f"searchsploit retornou erro ao consultar {cve}: {exc.stderr.strip()}") from exc

    stdout = process.stdout.strip()
    if not stdout:
        return {"results": []}

    try:
        return json.loads(stdout)
    except json.JSONDecodeError as exc:
        raise IntegrationError("Resposta inesperada do searchsploit (JSON inválido).", retriable=False) from exc


__all__ = ["search_cve", "DEFAULT_SEARCHSPLOIT_PATH"]
