from datetime import timedelta

from django.contrib.auth import get_user_model
from django.test import TestCase
from django.urls import reverse
from django.utils import timezone

from arpia_core.models import Asset, ObservedEndpoint, Project
from arpia_hunt.models import HuntAlert, HuntFinding
from arpia_scan.models import ScanSession
from arpia_vuln.models import VulnScanSession, VulnerabilityFinding


class PentestDashboardViewTests(TestCase):
	def setUp(self):
		self.user = get_user_model().objects.create_user("pentester", password="pass1234")
		self.older = Project.objects.create(owner=self.user, name="Projeto Pentest Antigo", slug="projeto-pentest-antigo")

	def test_projects_sorted_by_most_recent_first(self):
		newer = Project.objects.create(owner=self.user, name="Projeto Pentest Recente", slug="projeto-pentest-recente")

		self.client.login(username="pentester", password="pass1234")
		response = self.client.get(reverse("arpia_pentest:dashboard"))

		self.assertEqual(response.status_code, 200)
		projects = response.context["projects"]
		self.assertGreaterEqual(len(projects), 2)
		self.assertEqual([project.pk for project in projects[:2]], [newer.pk, self.older.pk])

	def test_dashboard_populates_modules_with_project_data(self):
		now = timezone.now()
		asset = Asset.objects.create(
			project=self.older,
			identifier="10.0.0.5",
			name="srv-web",
			ips=["10.0.0.5"],
		)
		ObservedEndpoint.objects.create(
			asset=asset,
			ip="10.0.0.5",
			port=22,
			proto="tcp",
			service="ssh",
			source="test",
		)
		ObservedEndpoint.objects.create(
			asset=asset,
			ip="10.0.0.5",
			port=8080,
			proto="tcp",
			service="http",
			source="test",
		)

		running_session = ScanSession.objects.create(
			project=self.older,
			owner=self.user,
			title="Varredura contínua",
			status=ScanSession.Status.RUNNING,
			started_at=now - timedelta(minutes=10),
		)
		completed_session = ScanSession.objects.create(
			project=self.older,
			owner=self.user,
			title="Varredura nmap",
			status=ScanSession.Status.COMPLETED,
			started_at=now - timedelta(hours=1),
			finished_at=now - timedelta(minutes=30),
			report_snapshot={"stats": {"hosts_count": 1, "total_findings": 2}},
		)
		completed_session.save(update_fields=["finished_at", "report_snapshot"])

		vuln_session = VulnScanSession.objects.create(
			project=self.older,
			owner=self.user,
			title="Greenbone semanal",
			status=VulnScanSession.Status.COMPLETED,
			started_at=now - timedelta(hours=2),
			finished_at=now - timedelta(hours=1, minutes=45),
		)
		finding = VulnerabilityFinding.objects.create(
			session=vuln_session,
			cve="CVE-2023-0001",
			title="OpenSSH vulnerável",
			severity=VulnerabilityFinding.Severity.CRITICAL,
			host="10.0.0.5",
			service="ssh",
			port=22,
			cvss_score=9.8,
		)

		hunt_finding = HuntFinding.objects.create(
			project=self.older,
			vulnerability=finding,
			vuln_session=vuln_session,
			host="10.0.0.5",
			service="ssh",
			port=22,
			cve=finding.cve,
			severity=finding.severity,
			cvss_score=finding.cvss_score,
			detected_at=now - timedelta(minutes=20),
		)
		HuntAlert.objects.create(
			finding=hunt_finding,
			kind=HuntAlert.Kind.PRIORITY_CRITICAL,
			last_triggered_at=now - timedelta(minutes=5),
		)

		self.client.login(username="pentester", password="pass1234")
		response = self.client.get(reverse("arpia_pentest:dashboard"), {"project": str(self.older.pk)})

		self.assertEqual(response.status_code, 200)
		modules = response.context["modules"]
		scan_module = next(module for module in modules if module["slug"] == "scan")
		self.assertEqual(scan_module["key_metrics"][0]["value"], 1)
		self.assertEqual(scan_module["key_metrics"][1]["value"], 1)
		self.assertGreaterEqual(scan_module["key_metrics"][2]["value"], 1)
		self.assertTrue(any("10.0.0.5" in highlight for highlight in scan_module["highlights"]))

		vuln_module = next(module for module in modules if module["slug"] == "vuln")
		self.assertEqual(vuln_module["key_metrics"][0]["value"], 1)
		self.assertEqual(vuln_module["key_metrics"][1]["value"], 1)
		self.assertEqual(vuln_module["key_metrics"][2]["value"], 1)
		self.assertTrue(any("CVE-2023-0001" in highlight for highlight in vuln_module["highlights"]))

		hunt_module = next(module for module in modules if module["slug"] == "hunt")
		self.assertEqual(hunt_module["key_metrics"][0]["value"], 1)
		self.assertEqual(hunt_module["key_metrics"][1]["value"], 1)
		self.assertEqual(hunt_module["key_metrics"][2]["value"], 1)
		self.assertTrue(any("CVE-2023-0001" in highlight for highlight in hunt_module["highlights"]))
