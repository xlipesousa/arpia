from __future__ import annotations

from dataclasses import dataclass, asdict
from typing import Any

from django.views.generic import TemplateView


@dataclass
class PentestModule:
	slug: str
	name: str
	summary: str
	key_metrics: list[dict[str, Any]]
	highlights: list[str]
	activity_log: list[dict[str, str]]

	def as_dict(self) -> dict[str, Any]:
		return asdict(self)


class PentestDashboardView(TemplateView):
	template_name = "pentest/dashboard.html"

	def get_context_data(self, **kwargs):  # type: ignore[override]
		context = super().get_context_data(**kwargs)

		modules = [
			PentestModule(
				slug="scan",
				name="ARPIA Scan",
				summary="Varreduras de superfície exposta, portas prioritárias e fingerprint de serviços.",
				key_metrics=[
					{"label": "Sessões ativas", "value": 2},
					{"label": "Hosts descobertos", "value": 18},
					{"label": "Portas críticas", "value": 11},
				],
				highlights=[
					"Rustscan executado contra perímetro externo às 18:11",
					"Fingerprint atualizado com 6 novos serviços HTTP",
					"Repositório DNS enumerado com sucesso (zone transfer parcial)",
				],
				activity_log=[
					{"time": "18:11", "event": "Rustscan", "detail": "Top 1000 TCP + UDP"},
					{"time": "18:05", "event": "Nmap NSE", "detail": "Scripts default,safe"},
					{"time": "17:58", "event": "Subfinder", "detail": "34 subdomínios válidos"},
				],
			),
			PentestModule(
				slug="vuln",
				name="ARPIA Vuln",
				summary="Correlação de vulnerabilidades, CVEs priorizados e integração Greenbone.",
				key_metrics=[
					{"label": "CVEs críticos", "value": 4},
					{"label": "Findings confirmados", "value": 12},
					{"label": "Exploit disponíveis", "value": 3},
				],
				highlights=[
					"CVE-2023-38408 explorável — OpenSSH agent forwarding",
					"Greenbone entregou relatório de alta criticidade (9.8)",
					"Plano de exploração atualizado para o ativo GATEWAY-01",
				],
				activity_log=[
					{"time": "18:14", "event": "Exploit PoC", "detail": "OpenSSH Agent"},
					{"time": "17:45", "event": "Greenbone", "detail": "Scan completo - Perfil Deep"},
					{"time": "17:20", "event": "Parser CVE", "detail": "Score CVSS recalculado"},
				],
			),
			PentestModule(
				slug="hunt",
				name="ARPIA Hunt",
				summary="Telemetria pós-exploração, persistência e alerta de atividades suspeitas.",
				key_metrics=[
					{"label": "Alertas ativos", "value": 5},
					{"label": "Sessões persistentes", "value": 3},
					{"label": "Hosts comprometidos", "value": 6},
				],
				highlights=[
					"Detecção de lateral movement via WinRM no segmento interno",
					"Implant de beacon HTTP ativo na zona DMZ há 42 minutos",
					"Novo alerta de credencial exposta em repositório Git interno",
				],
				activity_log=[
					{"time": "18:19", "event": "Beacon", "detail": "Callback estável"},
					{"time": "18:02", "event": "Credential Dump", "detail": "Hash NTLM coletado"},
					{"time": "17:37", "event": "Alert", "detail": "Bruteforce RDP bloqueado"},
				],
			),
		]

		context.update(
			{
				"modules": [module.as_dict() for module in modules],
				"default_module": modules[0].slug,
				"terminal_lines": [
					"┌─[pentest@arpia]─[~/ops/initial-access]",
					"└──$ sudo ./weaponize --target=GATEWAY-01 --profile=stealth",
					"[+] Carregando payload modulado...",
					"[+] Pivot configurado via SSH dynamic forward (1080)",
					"┌─[pentest@arpia]─[~/ops/post-exploitation]",
					"└──$ python3 session_manager.py --list",
					"# ID  HOSTNAME     USER        LAST_SEEN      ACCESS",
					"  07  DMZ-WEB01    nt_author   2m atrás       beacon_http",
					"  12  CORE-DB02    sa_service  5m atrás       meterpreter_tcp",
					"└──$ _",
				],
			}
		)
		return context
